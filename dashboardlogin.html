<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <!-- Favicon -->
    <link rel="icon" type="image/png" href="/logo.png">
    <link rel="icon" type="image/x-icon" href="/favicon.ico">
    <link rel="apple-touch-icon" href="/logo.png">
    <title>Connexion au dashboard - GoReview</title>
    <script>
      // Suppress third-party extension errors to keep console clean
      (function(){
        const isExtensionError = (msg) => {
          if (!msg) return false;
          const str = String(msg).toLowerCase();
          return str.includes('solanaactionscontentscript') ||
                 str.includes('chrome-extension://') ||
                 str.includes('moz-extension://') ||
                 str.includes('localhost:62462') ||
                 str.includes('browserautomation');
        };
        
        const originalError = console.error;
        console.error = function(...args) {
          const isExt = args.some(arg => isExtensionError(String(arg)));
          if (!isExt) {
            originalError.apply(console, args);
          }
        };
        
        const originalFetch = window.fetch;
        window.fetch = function(...args) {
          if (args[0] && args[0].includes && (args[0].includes('localhost:62462') || args[0].includes('chrome-extension://'))) {
            return Promise.reject(new Error('Blocked by filter')).catch(() => {});
          }
          return originalFetch.apply(this, args);
        };
      })();
    </script>
    
    <style>
        :root {
            --primary-color: #6366f1;
            --primary-dark: #4f46e5;
            --border-color: #e5e7eb;
            --radius-md: 0.75rem;
        }
        * { box-sizing: border-box; }
        body {
            min-height: 100vh;
            background: linear-gradient(135deg, #f9fafb 0%, #ffffff 100%);
            color: #111827;
            font-family: 'Helvetica Neue', Helvetica, Arial, sans-serif;
            margin: 0;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 1.5rem;
        }
        .card {
            background: #fff;
            border: 1px solid var(--border-color);
            border-radius: 16px;
            box-shadow: 0 20px 25px -5px rgba(0,0,0,0.1), 0 10px 10px -5px rgba(0,0,0,0.04);
            padding: 2rem;
            width: 100%;
            max-width: 440px;
        }
        .logo {
            width: 72px;
            height: 72px;
            margin: 0 auto 1rem;
        }
        .logo img { width: 100%; height: 100%; object-fit: contain; }
        h1 { text-align: center; font-size: 1.75rem; margin: 0 0 0.5rem 0; }
        p.subtitle { text-align: center; color: #6b7280; margin: 0 0 1.25rem 0; }
        .form-group { margin-bottom: 1rem; }
        label { display: block; font-weight: 600; margin-bottom: 0.5rem; }
        input[type="email"] {
            width: 100%; padding: 0.75rem 1rem; border: 1px solid #d1d5db; border-radius: var(--radius-md);
            font-size: 1rem; background: #fff; color: #111827;
        }
        input[type="email"]:focus { outline: none; border-color: var(--primary-color); box-shadow: 0 0 0 3px rgba(99,102,241,0.1); }
        .btn-primary {
            width: 100%; border: none; cursor: pointer; font-size: 1rem; font-weight: 600; border-radius: var(--radius-md);
            padding: 0.875rem 1.25rem; color: #fff; background: linear-gradient(135deg, var(--primary-color), var(--primary-dark));
            box-shadow: 0 4px 14px 0 rgba(99,102,241,0.39); transition: transform 0.2s, box-shadow 0.2s;
        }
        .btn-primary:hover { transform: translateY(-2px); box-shadow: 0 8px 20px 0 rgba(99,102,241,0.5); }
        .status { display: none; margin-top: 0.75rem; font-size: 0.9375rem; text-align: center; }
        .status.error { color: #991b1b; background: #fee2e2; padding: 0.5rem 0.75rem; border-radius: 8px; }
        .status.success { color: #065f46; background: #d1fae5; padding: 0.5rem 0.75rem; border-radius: 8px; }
        .status.show { display: block; }
        .note { font-size: 0.875rem; color: #6b7280; text-align: center; margin-top: 0.75rem; }
        @media (max-width: 400px) { .card { padding: 1.25rem; } }
    </style>
</head>
<body>
    <div class="card">
        <div class="logo"><img src="logo.png" alt="GoReview Logo"></div>
        <h1>Connexion</h1>
        <p class="subtitle">Connectez-vous √† votre tableau de bord GoReview</p>
        <form id="loginForm">
            <div class="form-group">
                <label for="email">Adresse email</label>
                <input type="email" id="email" name="email" required placeholder="votre@email.com" autocomplete="email">
            </div>
            <button type="submit" class="btn-primary">Se connecter</button>
            <div id="status" class="status"></div>
            <p class="note">Entrez l'email associ√© √† votre compte.</p>
        </form>
    </div>

    <!-- Supabase for reads, Database Proxy for writes -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="db-proxy.js"></script>

    <script>
        // Delete goreview_session cookie on page load
        (function() {
            const cookieName = 'goreview_session';
            const pastDate = 'Thu, 01 Jan 1970 00:00:00 UTC';
            const hostname = window.location.hostname;
            const hostnameParts = hostname.split('.');
            
            // Delete cookie with different paths and domains
            document.cookie = `${cookieName}=;expires=${pastDate};path=/;`;
            document.cookie = `${cookieName}=;expires=${pastDate};path=/;SameSite=Lax;`;
            document.cookie = `${cookieName}=;expires=${pastDate};path=/;SameSite=Strict;`;
            document.cookie = `${cookieName}=;expires=${pastDate};path=/;domain=${hostname};`;
            
            // Delete for parent domain if applicable
            if (hostnameParts.length > 1) {
                const parentDomain = '.' + hostnameParts.slice(-2).join('.');
                document.cookie = `${cookieName}=;expires=${pastDate};path=/;domain=${parentDomain};`;
                const parentDomainNoDot = hostnameParts.slice(-2).join('.');
                document.cookie = `${cookieName}=;expires=${pastDate};path=/;domain=${parentDomainNoDot};`;
            }
            
            console.log('‚úÖ goreview_session cookie deleted');
        })();
        
        // Check for error parameters from dashboard authentication failure
        (function() {
            const urlParams = new URLSearchParams(window.location.search);
            const errorType = urlParams.get('error');
            
            if (errorType) {
                console.log('‚ö†Ô∏è Received error from dashboard:', errorType);
                
                // Clear the problematic cookie
                document.cookie = 'dashboard_sesh=; expires=Thu, 01 Jan 1970 00:00:00 UTC; path=/;';
                console.log('üóëÔ∏è Cleared invalid dashboard_sesh cookie');
                
                // Clear session storage
                window.sessionStorage.removeItem('dashboard_redirect_in_progress');
                window.sessionStorage.removeItem('dashboard_load_count');
                
                // Show appropriate error message
                const statusEl = document.getElementById('status');
                if (statusEl) {
                    let errorMessage = '';
                    switch(errorType) {
                        case 'session_expired':
                            errorMessage = 'Votre session a expir√©. Veuillez vous reconnecter.';
                            break;
                        case 'invalid_session':
                            errorMessage = 'Session invalide. Veuillez vous reconnecter.';
                            break;
                        case 'auth_failed':
                            errorMessage = 'Erreur d\'authentification. Veuillez vous reconnecter.';
                            break;
                        default:
                            errorMessage = 'Veuillez vous reconnecter.';
                    }
                    statusEl.textContent = errorMessage;
                    statusEl.className = 'status show error';
                }
                
                // Remove error parameter from URL without reloading
                const cleanUrl = window.location.pathname;
                window.history.replaceState({}, document.title, cleanUrl);
                
                // Don't attempt auto-redirect when there's an error
                return;
            }
        
        // Check if user is already logged in (has dashboard_sesh cookie)
        // Use setTimeout to ensure this runs after page is fully loaded
        setTimeout(function() {
                // Check if we're coming from a failed dashboard load (to prevent loop)
                const fromDashboard = document.referrer.includes('/dashboard.html');
                if (fromDashboard) {
                    console.log('‚ÑπÔ∏è Coming from dashboard, allowing re-login');
                    return;
                }
                
            function getCookie(name) {
                const value = `; ${document.cookie}`;
                const parts = value.split(`; ${name}=`);
                if (parts.length === 2) {
                    return decodeURIComponent(parts.pop().split(';').shift());
                }
                return null;
            }
            
            try {
                const cookieValue = getCookie('dashboard_sesh');
                if (cookieValue) {
                    const cookieData = JSON.parse(cookieValue);
                    if (cookieData && cookieData.id) {
                        console.log('‚úÖ dashboard_sesh cookie found, redirecting to dashboard');
                            console.log('   Cookie ID:', cookieData.id);
                            console.log('   Cookie Email:', cookieData.email);
                            window.location.replace('/dashboard.html');
                        return;
                    }
                }
            } catch (e) {
                console.warn('‚ö†Ô∏è Error parsing dashboard_sesh cookie:', e);
            }
        }, 100);
        })();
    </script>

    <script>
            
            const form = document.getElementById('loginForm');
            const statusEl = document.getElementById('status');

            function showStatus(message, type) {
                statusEl.textContent = message;
                statusEl.className = 'status show ' + (type === 'error' ? 'error' : 'success');
            }

            function validateEmail(email) {
                const re = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
                return re.test(email);
            }

            let isProcessing = false; // Prevent multiple simultaneous requests
            
            form.addEventListener('submit', async (e) => {
                e.preventDefault();
                console.log('üìù Form submitted');
                
                // Prevent multiple submissions
                if (isProcessing) {
                    console.log('‚ö†Ô∏è Request already in progress, ignoring...');
                    return;
                }
                
                statusEl.className = 'status';

                const email = (document.getElementById('email').value || '').trim().toLowerCase();
                console.log('üìß Email entered:', email);

                if (!validateEmail(email)) {
                    showStatus("Veuillez entrer une adresse email valide.", 'error');
                    return;
                }

                // Disable form and set processing flag
                isProcessing = true;
                const submitButton = form.querySelector('button[type="submit"]');
                const originalButtonText = submitButton.textContent;
                submitButton.disabled = true;
                submitButton.textContent = 'Connexion...';
                
                showStatus("V√©rification en cours...", 'success');

                try {
                    // Wait for Supabase to be available
                    let retries = 0;
                    while (typeof supabase === 'undefined' && retries < 30) {
                        await new Promise(resolve => setTimeout(resolve, 100));
                        retries++;
                    }

                    if (typeof supabase === 'undefined') {
                        showStatus("Erreur de connexion. Veuillez r√©essayer.", 'error');
                        return;
                    }
                    
                    // Initialize Supabase client (same as db-proxy.js)
                    const SUPABASE_URL = 'https://vigutqmfosxbpncussie.supabase.co';
                    const SUPABASE_SERVICE_ROLE = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InZpZ3V0cW1mb3N4YnBuY3Vzc2llIiwicm9sZSI6InNlcnZpY2Vfcm9sZSIsImlhdCI6MTc2MTU4NDc1MiwiZXhwIjoyMDc3MTYwNzUyfQ.WPhspJ5LQ7E6k9sUFJsaISU6eVcJnIPGYv0GPGQfd98';
                    const supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_SERVICE_ROLE);
                    
                    // Normalize email: trim and lowercase for consistent search
                    const normalizedEmail = email.trim().toLowerCase();
                    
                    console.log('üîç Searching for email (case-insensitive):', normalizedEmail);
                    console.log('üîç Supabase client initialized:', !!supabaseClient);
                    
                    // First, let's check if we can query the table at all and see what emails exist
                    console.log('üîç Diagnostic: Fetching sample records from accounts table...');
                    const diagnosticQuery = await supabaseClient
                        .from('accounts')
                        .select('id, email')
                        .limit(10);
                    
                    console.log('üìä Diagnostic query result:', {
                        data: diagnosticQuery.data,
                        error: diagnosticQuery.error,
                        count: diagnosticQuery.data?.length || 0
                    });
                    
                    if (diagnosticQuery.data && diagnosticQuery.data.length > 0) {
                        console.log('üìã Sample emails in database:', diagnosticQuery.data.map(acc => ({
                            id: acc.id,
                            email: acc.email,
                            emailLower: acc.email?.toLowerCase(),
                            matches: acc.email?.toLowerCase() === normalizedEmail
                        })));
                    }
                    
                    // Try multiple query methods to find the account
                    // Method 1: Case-insensitive search using filter with ilike
                    console.log('üì§ Sending query to Supabase (method 1: ilike)...');
                    let { data, error } = await supabaseClient
                        .from('accounts')
                        .select('id, email')
                        .filter('email', 'ilike', normalizedEmail)
                        .maybeSingle();

                    console.log('üì• Supabase response (method 1):', { data, error });
                    
                    // Method 2: If no results, try exact match (in case email is already lowercase in DB)
                    if (!data && !error) {
                        console.log('üîÑ Trying method 2: exact match...');
                        const result2 = await supabaseClient
                            .from('accounts')
                            .select('id, email')
                            .eq('email', normalizedEmail)
                            .maybeSingle();
                        data = result2.data;
                        error = result2.error;
                        console.log('üì• Supabase response (method 2):', { data, error });
                    }
                    
                    // Method 3: If still no results, fetch all and filter client-side (last resort)
                    if (!data && !error) {
                        console.log('üîÑ Trying method 3: fetch all and filter client-side...');
                        const result3 = await supabaseClient
                            .from('accounts')
                            .select('id, email');
                        
                        console.log('üì• Method 3 query result:', { 
                            data: result3.data, 
                            error: result3.error,
                            count: result3.data?.length || 0
                        });
                        
                        if (!result3.error && result3.data) {
                            console.log('üîç Filtering through', result3.data.length, 'records...');
                            const found = result3.data.find(acc => {
                                if (!acc.email) return false;
                                const accEmailNormalized = acc.email.trim().toLowerCase();
                                const matches = accEmailNormalized === normalizedEmail;
                                if (matches) {
                                    console.log('‚úÖ Match found!', {
                                        dbEmail: acc.email,
                                        dbEmailNormalized: accEmailNormalized,
                                        searchEmail: normalizedEmail,
                                        id: acc.id
                                    });
                                }
                                return matches;
                            });
                            if (found) {
                                data = found;
                                console.log('‚úÖ Found with client-side filtering:', data);
                            } else {
                                console.log('‚ùå No match found in', result3.data.length, 'records');
                                console.log('üîç All emails in DB:', result3.data.map(a => a.email).filter(Boolean));
                            }
                        } else {
                            console.error('‚ùå Method 3 query failed:', result3.error);
                        }
                    }

                    console.log('üì• Final Supabase response');
                    console.log('üì• Data:', data);
                    console.log('üì• Error:', error);

                    if (error) {
                        console.error('‚ùå Database error:', error);
                        showStatus("Une erreur est survenue. Veuillez r√©essayer.", 'error');
                        // Re-enable form
                        isProcessing = false;
                        submitButton.disabled = false;
                        submitButton.textContent = originalButtonText;
                        return;
                    }

                    if (!data || !data.id) {
                        console.log('‚ö†Ô∏è No account found for email:', normalizedEmail);
                        showStatus("Aucun compte trouv√© avec cet email.", 'error');
                        // Re-enable form
                        isProcessing = false;
                        submitButton.disabled = false;
                        submitButton.textContent = originalButtonText;
                        return;
                    }
                    
                    console.log('‚úÖ Account found:', data.id);

                    // Create dashboard_sesh cookie with account ID
                    const cookieData = {
                        id: data.id,
                        email: data.email,
                        loginTime: new Date().toISOString()
                    };
                    const expirationDate = new Date();
                    expirationDate.setTime(expirationDate.getTime() + (30 * 24 * 60 * 60 * 1000)); // 30 days
                    
                    // Set cookie without encoding first to test if that's the issue
                    const cookieValue = JSON.stringify(cookieData);
                    const cookieString = `dashboard_sesh=${encodeURIComponent(cookieValue)}; expires=${expirationDate.toUTCString()}; path=/; SameSite=Lax`;
                    document.cookie = cookieString;
                    
                    console.log('‚úÖ dashboard_sesh cookie set');
                    console.log('   Cookie string:', cookieString);
                    console.log('   Cookie data:', cookieData);
                    console.log('   All cookies after setting:', document.cookie);
                    
                    // Function to get cookie value
                    function getCookie(name) {
                        const value = `; ${document.cookie}`;
                        const parts = value.split(`; ${name}=`);
                        if (parts.length === 2) {
                            return decodeURIComponent(parts.pop().split(';').shift());
                        }
                        return null;
                    }
                    
                    // Verify cookie was set by reading it back
                    let cookieVerified = false;
                    let attempts = 0;
                    for (let i = 0; i < 10; i++) {
                        await new Promise(resolve => setTimeout(resolve, 50));
                        attempts++;
                        const cookieValue = getCookie('dashboard_sesh');
                        console.log(`   Verification attempt ${attempts}: Cookie ${cookieValue ? 'found' : 'not found'}`);
                        if (cookieValue) {
                            try {
                                const parsed = JSON.parse(cookieValue);
                                console.log('   Parsed cookie:', parsed);
                                if (parsed && parsed.id === data.id) {
                                    cookieVerified = true;
                                    console.log('‚úÖ Cookie verified successfully on attempt', attempts);
                                    console.log('   Verified ID:', parsed.id);
                                    console.log('   Verified Email:', parsed.email);
                                    break;
                                } else {
                                    console.warn('   Cookie ID mismatch:', parsed?.id, 'vs', data.id);
                                }
                            } catch (e) {
                                console.warn('‚ö†Ô∏è Error parsing cookie during verification:', e);
                                console.warn('   Cookie value was:', cookieValue);
                            }
                        }
                    }
                    
                    if (!cookieVerified) {
                        console.error('‚ùå Cookie verification failed after', attempts, 'attempts');
                        console.error('   Final cookie check:', getCookie('dashboard_sesh'));
                        console.error('   All cookies:', document.cookie);
                        showStatus("Erreur lors de la cr√©ation de la session. Veuillez r√©essayer.", 'error');
                        isProcessing = false;
                        submitButton.disabled = false;
                        submitButton.textContent = originalButtonText;
                        return;
                    }

                    // Show success message
                    showStatus("Connexion r√©ussie, redirection...", 'success');
                    
                    // Small delay before redirect to ensure cookie is fully set
                    await new Promise(resolve => setTimeout(resolve, 300));

                    // Final verification that cookie is readable
                    const finalCookieCheck = getCookie('dashboard_sesh');
                    console.log('üîç Final cookie check before redirect:', finalCookieCheck ? 'Cookie present' : 'Cookie missing');
                    
                    if (!finalCookieCheck) {
                        console.error('‚ùå Cookie verification failed right before redirect');
                        showStatus("Erreur de session. Veuillez r√©essayer.", 'error');
                        isProcessing = false;
                        submitButton.disabled = false;
                        submitButton.textContent = originalButtonText;
                        return;
                    }
                    
                    // Set redirect protection flag
                    window.sessionStorage.setItem('dashboard_redirect_in_progress', 'true');
                    
                    // Email found, redirect to dashboard (ID will be read from cookie)
                    const redirectUrl = `/dashboard.html`;
                    console.log('üîÑ Redirecting to:', redirectUrl);
                    console.log('üìç Current location:', window.location.href);
                    console.log('üç™ Cookie contains ID:', data.id);
                    console.log('üç™ Cookie data:', finalCookieCheck);
                    console.log('‚ÑπÔ∏è Dashboard will read ID from cookie (no ID needed in URL)');
                    
                    // Use replace to avoid adding to history and prevent back button issues
                    window.location.replace(redirectUrl);
                } catch (err) {
                    console.error('Login error:', err);
                    showStatus("Une erreur est survenue. Veuillez r√©essayer.", 'error');
                    // Re-enable form
                    isProcessing = false;
                    submitButton.disabled = false;
                    submitButton.textContent = originalButtonText;
                }
            });
    </script>
</body>
</html>


