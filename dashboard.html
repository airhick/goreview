<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="icon" type="image/png" href="/logo.png">
    <link rel="icon" type="image/x-icon" href="/favicon.ico">
    <link rel="apple-touch-icon" href="/logo.png">
    <title>Dashboard - GoReview</title>
    <meta http-equiv="Content-Security-Policy" content="default-src 'self' http://localhost:*; connect-src 'self' http://localhost:* https://*.googleapis.com https://*.google.com https://maps.googleapis.com https://maps.gstatic.com https://vigutqmfosxbpncussie.supabase.co https://*.netlify.app https://*.netlify.com https://n8n.goreview.fr https://serpapi.com https://cdn.jsdelivr.net; img-src 'self' data: https: blob:; script-src 'self' 'unsafe-inline' 'unsafe-eval' https://accounts.google.com https://www.google.com https://*.google.com https://maps.googleapis.com https://cdn.jsdelivr.net; style-src 'self' 'unsafe-inline' https://fonts.googleapis.com; font-src 'self' https://fonts.gstatic.com; frame-src 'self' http://localhost:* https://www.google.com https://*.google.com https://maps.google.com;">
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script>
        (function() {
            const script = document.createElement('script');
            script.src = `db-proxy.js?v=${Date.now()}`;
            script.async = false;
            script.onerror = function() {
                console.error('Failed to load db-proxy.js - 404 error');
            };
            script.onload = function() {
                console.log('db-proxy.js loaded successfully');
            };
            document.head.appendChild(script);
        })();
    </script>
    <link href="https://fonts.googleapis.com/css2?family=DM+Sans:wght@400;500;600;700&family=JetBrains+Mono:wght@400;500&display=swap" rel="stylesheet">
    <style>
        :root {
            /* Light theme (default) */
            --bg-primary: #ffffff;
            --bg-secondary: #f9fafb;
            --bg-card: #ffffff;
            --bg-card-hover: #f3f4f6;
            --border-color: #e5e7eb;
            --text-primary: #111827;
            --text-secondary: #4b5563;
            --text-muted: #6b7280;
            --accent-primary: #8b5cf6;
            --accent-secondary: #a78bfa;
            --accent-glow: rgba(139, 92, 246, 0.1);
            --success: #10b981;
            --warning: #f59e0b;
            --danger: #ef4444;
            --info: #3b82f6;
            --star-gold: #fbbf24;
        }
        
        /* Dark theme */
        body.dark-mode {
            --bg-primary: #0a0a0f;
            --bg-secondary: #12121a;
            --bg-card: #1a1a24;
            --bg-card-hover: #222230;
            --border-color: #2a2a3a;
            --text-primary: #ffffff;
            --text-secondary: #9ca3af;
            --text-muted: #6b7280;
            --accent-glow: rgba(139, 92, 246, 0.3);
        }
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'DM Sans', -apple-system, BlinkMacSystemFont, sans-serif;
            background: var(--bg-primary);
            color: var(--text-primary);
            min-height: 100vh;
            line-height: 1.6;
        }
        
        /* Loading State */
        .loading-screen {
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            background: radial-gradient(ellipse at center, var(--bg-secondary) 0%, var(--bg-primary) 100%);
        }
        
        .loading-content {
            text-align: center;
        }
        
        .loading-spinner {
            width: 48px;
            height: 48px;
            border: 3px solid var(--border-color);
            border-top-color: var(--accent-primary);
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 1.5rem;
        }
        
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        
        .loading-text {
            font-size: 1.25rem;
            font-weight: 600;
            color: var(--accent-primary);
            margin-bottom: 0.5rem;
        }
        
        .loading-status {
            font-size: 0.9rem;
            color: var(--text-muted);
        }
        
        /* Main Dashboard Layout */
        .dashboard-container {
            max-width: 1600px;
            margin: 0 auto;
            padding: 2rem;
        }
        
        /* Header */
        .dashboard-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 2rem;
            padding-bottom: 1.5rem;
            border-bottom: 1px solid var(--border-color);
        }
        
        .header-left {
            display: flex;
            align-items: center;
            gap: 1rem;
        }
        
        .logo {
            height: 40px;
            width: auto;
        }
        
        .business-name {
            font-size: 1.5rem;
            font-weight: 700;
            background: linear-gradient(135deg, var(--text-primary) 0%, var(--accent-secondary) 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }
        
        .header-right {
            display: flex;
            align-items: center;
            gap: 1rem;
        }
        
        .last-updated {
            font-size: 0.8rem;
            color: var(--text-muted);
            font-family: 'JetBrains Mono', monospace;
        }
        
        .settings-btn {
            width: 44px;
            height: 44px;
            border-radius: 12px;
            border: 1px solid var(--border-color);
            background: var(--bg-card);
            color: var(--text-secondary);
            font-size: 1.25rem;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .settings-btn:hover {
            background: var(--bg-card-hover);
            border-color: var(--accent-primary);
            color: var(--accent-primary);
        }
        
        /* Theme Toggle */
        .theme-toggle {
            width: 44px;
            height: 44px;
            border-radius: 12px;
            border: 1px solid var(--border-color);
            background: var(--bg-card);
            color: var(--text-secondary);
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
            position: relative;
            overflow: hidden;
        }
        
        .theme-toggle:hover {
            background: var(--bg-card-hover);
            border-color: var(--accent-primary);
            color: var(--accent-primary);
        }
        
        .theme-icon {
            width: 20px;
            height: 20px;
            position: absolute;
            transition: all 0.3s ease;
        }
        
        .sun-icon {
            opacity: 1;
            transform: rotate(0deg) scale(1);
        }
        
        .moon-icon {
            opacity: 0;
            transform: rotate(90deg) scale(0);
        }
        
        body.dark-mode .sun-icon {
            opacity: 0;
            transform: rotate(90deg) scale(0);
        }
        
        body.dark-mode .moon-icon {
            opacity: 1;
            transform: rotate(0deg) scale(1);
        }
        
        /* Grid Layout */
        .dashboard-grid {
            display: grid;
            grid-template-columns: repeat(12, 1fr);
            gap: 1.5rem;
        }
        
        /* Cards */
        .card {
            background: var(--bg-card);
            border: 1px solid var(--border-color);
            border-radius: 16px;
            padding: 1.5rem;
            position: relative;
            overflow: hidden;
            transition: all 0.3s ease;
        }
        
        .card:hover {
            border-color: var(--accent-primary);
            box-shadow: 0 0 30px var(--accent-glow);
        }
        
        .card-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 1rem;
        }
        
        .card-title {
            font-size: 0.85rem;
            font-weight: 600;
            color: var(--text-muted);
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }
        
        .card-icon {
            width: 32px;
            height: 32px;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1rem;
        }
        
        .card-icon.purple { background: rgba(139, 92, 246, 0.2); color: var(--accent-primary); }
        .card-icon.green { background: rgba(16, 185, 129, 0.2); color: var(--success); }
        .card-icon.orange { background: rgba(245, 158, 11, 0.2); color: var(--warning); }
        .card-icon.blue { background: rgba(59, 130, 246, 0.2); color: var(--info); }
        .card-icon.red { background: rgba(239, 68, 68, 0.2); color: var(--danger); }
        
        /* Span classes */
        .span-3 { grid-column: span 3; }
        .span-4 { grid-column: span 4; }
        .span-6 { grid-column: span 6; }
        .span-8 { grid-column: span 8; }
        .span-12 { grid-column: span 12; }
        
        /* Main Metrics */
        .metric-value {
            font-size: 2.5rem;
            font-weight: 700;
            line-height: 1;
            margin-bottom: 0.5rem;
        }
        
        .metric-label {
            font-size: 0.9rem;
            color: var(--text-secondary);
        }
        
        /* Stars */
        .stars-display {
            display: flex;
            gap: 4px;
            margin-bottom: 0.75rem;
        }
        
        .star {
            font-size: 1.75rem;
            color: var(--border-color);
        }
        
        .star.filled {
            color: var(--star-gold);
        }
        
        .star.half {
            background: linear-gradient(90deg, var(--star-gold) 50%, var(--border-color) 50%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }
        
        /* Rating Distribution Bar */
        .rating-distribution {
            margin-top: 1rem;
        }
        
        .rating-bar-row {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            margin-bottom: 0.5rem;
        }
        
        .rating-bar-label {
            font-size: 0.8rem;
            color: var(--text-muted);
            width: 20px;
            text-align: right;
            font-family: 'JetBrains Mono', monospace;
        }
        
        .rating-bar-track {
            flex: 1;
            height: 8px;
            background: var(--border-color);
            border-radius: 4px;
            overflow: hidden;
        }
        
        .rating-bar-fill {
            height: 100%;
            border-radius: 4px;
            transition: width 0.5s ease;
        }
        
        .rating-bar-fill.star-5 { background: linear-gradient(90deg, #10b981, #34d399); }
        .rating-bar-fill.star-4 { background: linear-gradient(90deg, #22c55e, #4ade80); }
        .rating-bar-fill.star-3 { background: linear-gradient(90deg, #f59e0b, #fbbf24); }
        .rating-bar-fill.star-2 { background: linear-gradient(90deg, #f97316, #fb923c); }
        .rating-bar-fill.star-1 { background: linear-gradient(90deg, #ef4444, #f87171); }
        
        .rating-bar-count {
            font-size: 0.75rem;
            color: var(--text-muted);
            width: 50px;
            font-family: 'JetBrains Mono', monospace;
        }
        
        /* Response Rate Gauge */
        .gauge-container {
            position: relative;
            width: 140px;
            height: 70px;
            margin: 1rem auto;
        }
        
        .gauge-bg {
            position: absolute;
            width: 140px;
            height: 70px;
            border-radius: 70px 70px 0 0;
            background: conic-gradient(
                from 180deg at 50% 100%,
                var(--border-color) 0deg,
                var(--border-color) 180deg
            );
        }
        
        .gauge-fill {
            position: absolute;
            width: 140px;
            height: 70px;
            border-radius: 70px 70px 0 0;
            background: conic-gradient(
                from 180deg at 50% 100%,
                var(--success) 0deg,
                var(--success) calc(var(--gauge-value, 0) * 1.8deg),
                transparent calc(var(--gauge-value, 0) * 1.8deg)
            );
        }
        
        .gauge-center {
            position: absolute;
            width: 100px;
            height: 50px;
            border-radius: 50px 50px 0 0;
            background: var(--bg-card);
            bottom: 0;
            left: 20px;
        }
        
        .gauge-value {
            position: absolute;
            bottom: 5px;
            left: 50%;
            transform: translateX(-50%);
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--success);
        }
        
        /* Popular Times Chart */
        .popular-times-chart {
            display: flex;
            flex-direction: column;
            gap: 1rem;
            margin-top: 1rem;
        }
        
        .day-row {
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }
        
        .day-label {
            width: 35px;
            font-size: 0.75rem;
            font-weight: 600;
            color: var(--text-muted);
            text-transform: uppercase;
        }
        
        .hours-chart {
            flex: 1;
            display: flex;
            align-items: flex-end;
            gap: 2px;
            height: 40px;
        }
        
        .hour-bar {
            flex: 1;
            background: var(--border-color);
            border-radius: 2px 2px 0 0;
            transition: all 0.3s ease;
            min-height: 4px;
            position: relative;
        }
        
        .hour-bar:hover {
            background: var(--accent-primary) !important;
        }
        
        .hour-bar.peak {
            background: linear-gradient(to top, var(--warning), var(--danger));
        }
        
        .hour-bar.high {
            background: linear-gradient(to top, var(--success), var(--warning));
        }
        
        .hour-bar.medium {
            background: var(--info);
        }
        
        .hour-bar.low {
            background: var(--border-color);
        }
        
        /* Competitor Cards */
        .competitors-list {
            display: flex;
            flex-direction: column;
            gap: 0.75rem;
            margin-top: 1rem;
        }
        
        .competitor-item {
            display: flex;
            align-items: center;
            gap: 1rem;
            padding: 0.75rem;
            background: var(--bg-secondary);
            border-radius: 10px;
            border: 1px solid var(--border-color);
            transition: all 0.2s;
        }
        
        .competitor-item:hover {
            border-color: var(--accent-primary);
        }
        
        .competitor-item.you {
            border-color: var(--accent-primary);
            background: rgba(139, 92, 246, 0.1);
        }
        
        .competitor-rank {
            width: 28px;
            height: 28px;
            border-radius: 50%;
            background: var(--border-color);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.8rem;
            font-weight: 700;
            color: var(--text-secondary);
        }
        
        .competitor-item.you .competitor-rank {
            background: var(--accent-primary);
            color: white;
        }
        
        .competitor-info {
            flex: 1;
            min-width: 0;
        }
        
        .competitor-name {
            font-weight: 600;
            font-size: 0.9rem;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        
        .competitor-type {
            font-size: 0.75rem;
            color: var(--text-muted);
        }
        
        .competitor-rating {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        
        .competitor-rating .star {
            font-size: 1rem;
            color: var(--star-gold);
        }
        
        .competitor-rating-value {
            font-weight: 600;
            font-size: 0.9rem;
        }
        
        .competitor-reviews {
            font-size: 0.75rem;
            color: var(--text-muted);
        }
        
        /* Reviews List */
        .reviews-list {
            display: flex;
            flex-direction: column;
            gap: 1rem;
            margin-top: 1rem;
            max-height: 400px;
            overflow-y: auto;
        }
        
        .review-item {
            padding: 1rem;
            background: var(--bg-secondary);
            border-radius: 12px;
            border: 1px solid var(--border-color);
        }
        
        .review-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 0.5rem;
        }
        
        .review-author {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        
        .review-avatar {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            background: var(--accent-primary);
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 600;
            font-size: 0.9rem;
        }
        
        .review-name {
            font-weight: 600;
            font-size: 0.9rem;
        }
        
        .review-date {
            font-size: 0.75rem;
            color: var(--text-muted);
        }
        
        .review-rating {
            display: flex;
            gap: 2px;
        }
        
        .review-rating .star {
            font-size: 0.9rem;
        }
        
        .review-text {
            font-size: 0.9rem;
            color: var(--text-secondary);
            line-height: 1.6;
        }
        
        .review-response {
            margin-top: 0.75rem;
            padding: 0.75rem;
            background: rgba(139, 92, 246, 0.1);
            border-left: 3px solid var(--accent-primary);
            border-radius: 0 8px 8px 0;
        }
        
        .review-response-label {
            font-size: 0.75rem;
            font-weight: 600;
            color: var(--accent-primary);
            margin-bottom: 0.25rem;
        }
        
        .review-response-text {
            font-size: 0.85rem;
            color: var(--text-secondary);
        }
        
        .review-no-response {
            margin-top: 0.75rem;
            padding: 0.5rem 0.75rem;
            background: rgba(239, 68, 68, 0.1);
            border: 1px dashed var(--danger);
            border-radius: 8px;
            font-size: 0.8rem;
            color: var(--danger);
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        
        /* Review Management Section */
        .review-filters {
            display: flex;
            gap: 1rem;
            margin-bottom: 1.5rem;
            flex-wrap: wrap;
            align-items: center;
        }
        
        .filter-group {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }
        
        .filter-label {
            font-size: 0.75rem;
            font-weight: 600;
            color: var(--text-muted);
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }
        
        .filter-buttons {
            display: flex;
            gap: 0.5rem;
        }
        
        .filter-btn {
            padding: 0.5rem 1rem;
            border-radius: 8px;
            font-size: 0.85rem;
            font-weight: 600;
            border: 1px solid var(--border-color);
            background: var(--bg-secondary);
            color: var(--text-secondary);
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .filter-btn:hover {
            border-color: var(--accent-primary);
            color: var(--accent-primary);
        }
        
        .filter-btn.active {
            background: var(--accent-primary);
            border-color: var(--accent-primary);
            color: white;
        }
        
        .filter-btn.rating-1 { border-color: var(--danger); color: var(--danger); }
        .filter-btn.rating-1.active { background: var(--danger); color: white; }
        .filter-btn.rating-2 { border-color: #f97316; color: #f97316; }
        .filter-btn.rating-2.active { background: #f97316; color: white; }
        .filter-btn.rating-3 { border-color: var(--warning); color: var(--warning); }
        .filter-btn.rating-3.active { background: var(--warning); color: white; }
        
        .sort-select {
            padding: 0.5rem 1rem;
            border-radius: 8px;
            border: 1px solid var(--border-color);
            background: var(--bg-secondary);
            color: var(--text-primary);
            font-size: 0.85rem;
            cursor: pointer;
            transition: all 0.2s ease;
            min-width: 180px;
        }
        
        .sort-select:hover, .sort-select:focus {
            border-color: var(--accent-primary);
            outline: none;
            box-shadow: 0 0 0 3px var(--accent-glow);
        }
        
        .review-stats {
            display: flex;
            gap: 2rem;
            margin-bottom: 1.5rem;
            padding: 1rem;
            background: var(--bg-secondary);
            border-radius: 12px;
        }
        
        .review-stat {
            display: flex;
            flex-direction: column;
            gap: 0.25rem;
        }
        
        .review-stat-value {
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--text-primary);
        }
        
        .review-stat-label {
            font-size: 0.75rem;
            color: var(--text-muted);
        }
        
        .reply-btn {
            padding: 0.5rem 1rem;
            border-radius: 8px;
            font-size: 0.85rem;
            font-weight: 600;
            border: 1px solid var(--accent-primary);
            background: var(--accent-primary);
            color: white;
            cursor: pointer;
            transition: all 0.2s;
            text-decoration: none;
            display: inline-block;
        }
        
        .reply-btn:hover {
            background: var(--accent-secondary);
            transform: translateY(-2px);
            box-shadow: 0 4px 12px var(--accent-glow);
        }
        
        .reply-btn.urgent {
            background: var(--danger);
            animation: pulse-urgent 2s infinite;
        }
        
        @keyframes pulse-urgent {
            0%, 100% { box-shadow: 0 0 0 0 rgba(239, 68, 68, 0.4); }
            50% { box-shadow: 0 0 0 8px rgba(239, 68, 68, 0); }
        }
        
        .view-review-btn {
            padding: 0.4rem 0.6rem;
            border-radius: 6px;
            font-size: 0.85rem;
            background: var(--bg-secondary);
            color: var(--text-secondary);
            text-decoration: none;
            transition: all 0.2s ease;
            display: inline-flex;
            align-items: center;
        }
        
        .view-review-btn:hover {
            background: var(--bg-card-hover);
            color: var(--accent-primary);
        }
        
        .local-guide-badge {
            font-size: 0.85rem;
            margin-left: 0.25rem;
        }
        
        .review-no-response.urgent {
            background: rgba(239, 68, 68, 0.15);
            border-left: 3px solid var(--danger);
            padding-left: 0.75rem;
        }
        
        .review-item.bad-review {
            border-color: var(--danger);
            background: rgba(239, 68, 68, 0.05);
        }
        
        /* AI Insight Card */
        .ai-insight {
            background: linear-gradient(135deg, rgba(139, 92, 246, 0.15) 0%, rgba(59, 130, 246, 0.1) 100%);
            border: 1px solid var(--accent-primary);
            padding: 1.5rem;
            border-radius: 16px;
            position: relative;
            overflow: hidden;
        }
        
        .ai-insight::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 3px;
            background: linear-gradient(90deg, var(--accent-primary), var(--info), var(--accent-primary));
            background-size: 200% 100%;
            animation: shimmer 2s linear infinite;
        }
        
        @keyframes shimmer {
            0% { background-position: -200% 0; }
            100% { background-position: 200% 0; }
        }
        
        .ai-header {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            margin-bottom: 1rem;
        }
        
        .ai-icon {
            width: 40px;
            height: 40px;
            border-radius: 10px;
            background: linear-gradient(135deg, var(--accent-primary), var(--info));
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.25rem;
        }
        
        .ai-title {
            font-size: 1rem;
            font-weight: 700;
        }
        
        .ai-subtitle {
            font-size: 0.8rem;
            color: var(--text-muted);
        }
        
        .ai-content {
            font-size: 0.95rem;
            line-height: 1.7;
            color: var(--text-secondary);
        }
        
        .ai-highlight {
            background: rgba(139, 92, 246, 0.3);
            padding: 0.1rem 0.4rem;
            border-radius: 4px;
            font-weight: 500;
            color: var(--text-primary);
        }
        
        .ai-tags {
            display: flex;
            flex-wrap: wrap;
            gap: 0.5rem;
            margin-top: 1rem;
        }
        
        .ai-tag {
            padding: 0.25rem 0.75rem;
            background: var(--bg-card);
            border: 1px solid var(--border-color);
            border-radius: 20px;
            font-size: 0.75rem;
            color: var(--text-secondary);
        }
        
        .ai-tag.positive { border-color: var(--success); color: var(--success); }
        .ai-tag.negative { border-color: var(--danger); color: var(--danger); }
        
        /* Staffing Alert */
        .staffing-alert {
            display: flex;
            align-items: flex-start;
            gap: 1rem;
            padding: 1rem;
            background: rgba(245, 158, 11, 0.1);
            border: 1px solid var(--warning);
            border-radius: 12px;
            margin-top: 1rem;
        }
        
        .staffing-alert-icon {
            font-size: 1.5rem;
        }
        
        .staffing-alert-content h4 {
            font-size: 0.9rem;
            font-weight: 600;
            color: var(--warning);
            margin-bottom: 0.25rem;
        }
        
        .staffing-alert-content p {
            font-size: 0.85rem;
            color: var(--text-secondary);
        }
        
        /* Social Post Generator */
        .social-post-preview {
            margin-top: 1rem;
            padding: 1.25rem;
            background: linear-gradient(135deg, #833ab4 0%, #fd1d1d 50%, #fcb045 100%);
            border-radius: 12px;
            color: white;
        }
        
        .social-post-quote {
            font-size: 1.1rem;
            font-style: italic;
            line-height: 1.6;
            margin-bottom: 1rem;
        }
        
        .social-post-author {
            font-size: 0.85rem;
            opacity: 0.9;
        }
        
        .social-post-actions {
            display: flex;
            gap: 0.5rem;
            margin-top: 1rem;
        }
        
        .btn {
            padding: 0.5rem 1rem;
            border-radius: 8px;
            font-size: 0.85rem;
            font-weight: 600;
            border: none;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .btn-primary {
            background: var(--accent-primary);
            color: white;
        }
        
        .btn-primary:hover {
            background: var(--accent-secondary);
        }
        
        .btn-secondary {
            background: var(--bg-card);
            color: var(--text-primary);
            border: 1px solid var(--border-color);
        }
        
        .btn-secondary:hover {
            border-color: var(--accent-primary);
        }
        
        /* Attributes Grid */
        .attributes-grid {
            display: flex;
            flex-wrap: wrap;
            gap: 0.5rem;
            margin-top: 1rem;
        }
        
        .attribute-tag {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.5rem 0.75rem;
            background: var(--bg-secondary);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            font-size: 0.8rem;
            color: var(--text-secondary);
        }
        
        .attribute-tag .icon {
            font-size: 1rem;
        }
        
        /* Time Spent */
        .time-spent-display {
            text-align: center;
            padding: 1.5rem;
        }
        
        .time-spent-value {
            font-size: 2.5rem;
            font-weight: 700;
            color: var(--info);
        }
        
        .time-spent-label {
            font-size: 0.9rem;
            color: var(--text-muted);
            margin-top: 0.25rem;
        }
        
        /* Contacts Table */
        .contacts-preview {
            margin-top: 1rem;
            border: 1px solid var(--border-color);
            border-radius: 12px;
            overflow: hidden;
        }
        
        .contacts-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.85rem;
        }
        
        .contacts-table thead {
            background: var(--bg-secondary);
        }
        
        .contacts-table th {
            padding: 0.75rem 1rem;
            text-align: left;
            font-weight: 600;
            color: var(--text-muted);
            font-size: 0.75rem;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            border-bottom: 1px solid var(--border-color);
        }
        
        .contacts-table td {
            padding: 0.75rem 1rem;
            border-bottom: 1px solid var(--border-color);
            color: var(--text-secondary);
        }
        
        .contacts-table tr:last-child td {
            border-bottom: none;
        }
        
        .contacts-table tr:hover td {
            background: var(--bg-card-hover);
        }
        
        .contacts-table a {
            color: var(--accent-primary);
            text-decoration: none;
        }
        
        .contacts-table a:hover {
            text-decoration: underline;
        }
        
        /* Empty State */
        .empty-state {
            text-align: center;
            padding: 2rem;
            color: var(--text-muted);
        }
        
        .empty-state-icon {
            font-size: 2.5rem;
            margin-bottom: 1rem;
            opacity: 0.5;
        }
        
        /* Responsive */
        @media (max-width: 1200px) {
            .span-3 { grid-column: span 6; }
            .span-4 { grid-column: span 6; }
            .span-8 { grid-column: span 12; }
        }
        
        @media (max-width: 768px) {
            .dashboard-container {
                padding: 1rem;
            }
            
            .span-3, .span-4, .span-6, .span-8 { 
                grid-column: span 12; 
            }
            
            .dashboard-header {
                flex-direction: column;
                gap: 1rem;
                text-align: center;
            }
            
            .header-left {
                flex-direction: column;
            }
            
            .metric-value {
                font-size: 2rem;
            }
        }
        
        /* Scrollbar */
        ::-webkit-scrollbar {
            width: 8px;
        }
        
        ::-webkit-scrollbar-track {
            background: var(--bg-secondary);
        }
        
        ::-webkit-scrollbar-thumb {
            background: var(--border-color);
            border-radius: 4px;
        }
        
        ::-webkit-scrollbar-thumb:hover {
            background: var(--text-muted);
        }
    </style>
</head>
<body>
<script>
    // Load theme immediately to prevent flash
    (function() {
        const savedTheme = localStorage.getItem('dashboard-theme');
        if (savedTheme === 'dark') {
            document.body.classList.add('dark-mode');
        }
    })();
</script>
<div id="app">
    <div class="loading-screen">
        <div class="loading-content">
            <div class="loading-spinner"></div>
            <div class="loading-text">Chargement du Dashboard</div>
            <div class="loading-status" id="loadingStatus">Vérification de la session...</div>
        </div>
    </div>
</div>

<script>
(async function() {
    const app = document.getElementById('app');
    
    // ═══════════════════════════════════════════════════════════════════
    // AUTHENTICATION
    // ═══════════════════════════════════════════════════════════════════
    
    function getCookie(name) {
        const value = `; ${document.cookie}`;
        const parts = value.split(`; ${name}=`);
        if (parts.length === 2) return decodeURIComponent(parts.pop().split(';').shift());
        return null;
    }
    
    // ═══════════════════════════════════════════════════════════════════
    // THEME MANAGEMENT
    // ═══════════════════════════════════════════════════════════════════
    
    // Load theme preference from localStorage
    function loadTheme() {
        const savedTheme = localStorage.getItem('dashboard-theme');
        if (savedTheme === 'dark') {
            document.body.classList.add('dark-mode');
        } else {
            document.body.classList.remove('dark-mode');
        }
    }
    
    // Toggle theme
    function toggleTheme() {
        const isDark = document.body.classList.contains('dark-mode');
        if (isDark) {
            document.body.classList.remove('dark-mode');
            localStorage.setItem('dashboard-theme', 'light');
        } else {
            document.body.classList.add('dark-mode');
            localStorage.setItem('dashboard-theme', 'dark');
        }
    }
    
    // Initialize theme on load
    loadTheme();
    
    // Add event listener for theme toggle (will be attached after DOM is ready)
    function initThemeToggle() {
        const themeToggle = document.getElementById('themeToggle');
        if (themeToggle) {
            themeToggle.addEventListener('click', toggleTheme);
        }
    }
    
    const params = new URLSearchParams(window.location.search);
    const idFromUrl = params.get('id');
    let accountId = null;
    let accountEmail = null;
    
    // Check for session cookie
    let cookieRetries = 0;
    const maxRetries = 20;
    
    while (!accountId && cookieRetries < maxRetries) {
        try {
            const cookieValue = getCookie('dashboard_sesh');
            if (cookieValue) {
                const cookieData = JSON.parse(cookieValue);
                if (cookieData && cookieData.id) {
                    accountId = cookieData.id;
                    accountEmail = cookieData.email;
                    break;
                }
            }
        } catch (e) {}
        cookieRetries++;
        await new Promise(r => setTimeout(r, 100));
    }
    
        if (!accountId) {
        document.getElementById('loadingStatus').innerHTML = '❌ Session expirée';
        await new Promise(r => setTimeout(r, 1000));
        window.location.replace('/dashboardlogin.html?error=session_expired');
            return;
        }
    
    // URL validation
    if (idFromUrl && String(idFromUrl) !== String(accountId)) {
        window.location.replace('/dashboardlogin.html?error=invalid_session');
            return;
        }
        
    if (!idFromUrl) {
        window.history.replaceState(null, '', `/dashboard.html?id=${encodeURIComponent(accountId)}`);
    }
    
    document.getElementById('loadingStatus').textContent = 'Chargement des données...';
    
    // ═══════════════════════════════════════════════════════════════════
    // DATA FETCHING
    // ═══════════════════════════════════════════════════════════════════
    
    window.waitForDbProxy = async function() {
        if (window.dbProxy) return window.dbProxy;
        let retries = 0;
        while (!window.dbProxy && retries < 50) {
            await new Promise(r => setTimeout(r, 100));
            retries++;
        }
        if (!window.dbProxy) throw new Error('db-proxy.js failed to load');
        return window.dbProxy;
    };
    
    // Fetch enriched data from Serp API
    async function fetchEnrichedData(placeId) {
        // Check if accountId is defined
        if (!accountId) {
            console.warn('fetchEnrichedData: accountId is not defined');
            return null;
        }
        
        const isLocalhost = window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1';
        const apiUrl = isLocalhost 
            ? `/api/serp-reviews?account_id=${encodeURIComponent(accountId)}&business_id=${encodeURIComponent(placeId || '')}`
            : `/.netlify/functions/serp-reviews?account_id=${encodeURIComponent(accountId)}&business_id=${encodeURIComponent(placeId || '')}`;
        
        try {
            console.log('Fetching enriched data from:', apiUrl);
            const response = await fetch(apiUrl);
            
            if (!response.ok) {
                const errorText = await response.text();
                console.error(`API Error (${response.status}):`, errorText);
                throw new Error(`API Error: ${response.status} ${response.statusText}`);
            }
            
            return await response.json();
        } catch (e) {
            console.error('Failed to fetch enriched data:', e);
            // Return null instead of throwing to allow dashboard to continue loading
            return null;
        }
    }
    
    // ═══════════════════════════════════════════════════════════════════
    // HELPER FUNCTIONS
    // ═══════════════════════════════════════════════════════════════════
    
    function escapeHtml(str) {
        if (!str) return '';
        return String(str).replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;').replace(/"/g, '&quot;');
    }
    
    function renderStars(rating, size = '1.75rem') {
        let html = '';
        const fullStars = Math.floor(rating);
        const hasHalf = rating % 1 >= 0.5;
        
        for (let i = 0; i < 5; i++) {
            if (i < fullStars) {
                html += `<span class="star filled" style="font-size:${size}">★</span>`;
            } else if (i === fullStars && hasHalf) {
                html += `<span class="star half" style="font-size:${size}">★</span>`;
            } else {
                html += `<span class="star" style="font-size:${size}">★</span>`;
            }
        }
        return html;
    }
    
    // Analyze sentiment from reviews (simple version)
    function analyzeReviews(reviews) {
        if (!reviews || !reviews.length) return null;
        
        const positiveWords = ['excellent', 'super', 'parfait', 'génial', 'recommande', 'magnifique', 'top', 'délicieux', 'sympa', 'agréable', 'bien', 'bon', 'accueil', 'qualité', 'frais', 'variety', 'choix'];
        const negativeWords = ['mauvais', 'nul', 'horrible', 'décevant', 'éviter', 'froid', 'désagréable', 'impoli', 'cher', 'lent', 'sale', 'attendre', 'problème'];
        
        const themes = {};
        let positiveCount = 0;
        let negativeCount = 0;
        let responded = 0;
        let notResponded = 0;
        
        reviews.forEach(r => {
            const text = (r.description || '').toLowerCase();
            
            positiveWords.forEach(word => {
                if (text.includes(word)) {
                    themes[word] = (themes[word] || 0) + 1;
                    positiveCount++;
                }
            });
            
            negativeWords.forEach(word => {
                if (text.includes(word)) {
                    themes[word] = (themes[word] || 0) + 1;
                    negativeCount++;
                }
            });
            
            if (r.response) responded++;
            else notResponded++;
        });
        
        // Sort themes by frequency
        const sortedThemes = Object.entries(themes).sort((a, b) => b[1] - a[1]).slice(0, 10);
        const positiveThemes = sortedThemes.filter(([word]) => positiveWords.includes(word));
        const negativeThemes = sortedThemes.filter(([word]) => negativeWords.includes(word));
        
        return {
            positiveThemes: positiveThemes.map(([w]) => w),
            negativeThemes: negativeThemes.map(([w]) => w),
            responseRate: reviews.length > 0 ? Math.round((responded / reviews.length) * 100) : 0,
            notRespondedCount: notResponded,
            sentiment: positiveCount > negativeCount ? 'positive' : negativeCount > positiveCount ? 'negative' : 'neutral'
        };
    }
    
    // Find peak hours from popular_times
    function analyzeBusyTimes(popularTimes) {
        if (!popularTimes) return null;
        
        const days = ['sunday', 'monday', 'tuesday', 'wednesday', 'thursday', 'friday', 'saturday'];
        const daysFr = { sunday: 'Dim', monday: 'Lun', tuesday: 'Mar', wednesday: 'Mer', thursday: 'Jeu', friday: 'Ven', saturday: 'Sam' };
        
        let peakDay = null;
        let peakHour = null;
        let peakScore = 0;
        let quietestDay = null;
        let quietestScore = 100;
        
        const analyzed = {};
        
        days.forEach(day => {
            const dayData = popularTimes[day];
            if (!dayData) return;
            
            let dayTotal = 0;
            let hourData = [];
            
            // Handle different formats
            if (Array.isArray(dayData)) {
                dayData.forEach(h => {
                    const score = h.busyness_score || h.percentage || 0;
                    const hour = h.time || h.hour;
                    hourData.push({ hour, score });
                    dayTotal += score;
                    
                    if (score > peakScore) {
                        peakScore = score;
                        peakDay = day;
                        peakHour = hour;
                    }
                });
            } else if (dayData.graph_results) {
                dayData.graph_results.forEach(h => {
                    const score = h.busyness_score || 0;
                    hourData.push({ hour: h.time, score });
                    dayTotal += score;
                    
                    if (score > peakScore) {
                        peakScore = score;
                        peakDay = day;
                        peakHour = h.time;
                    }
                });
            }
            
            const avgScore = hourData.length > 0 ? dayTotal / hourData.length : 0;
            analyzed[day] = { hours: hourData, avg: avgScore };
            
            if (avgScore < quietestScore && avgScore > 0) {
                quietestScore = avgScore;
                quietestDay = day;
            }
        });
        
        return {
            peakDay: peakDay ? daysFr[peakDay] : null,
            peakHour: peakHour,
            peakScore: peakScore,
            quietestDay: quietestDay ? daysFr[quietestDay] : null,
            quietestScore: quietestScore,
            analyzed: analyzed,
            daysFr: daysFr
        };
    }
    
    // ═══════════════════════════════════════════════════════════════════
    // RENDER DASHBOARD
    // ═══════════════════════════════════════════════════════════════════
    
    async function renderDashboard(accountData, enrichedData) {
        const businessName = accountData.business_name || accountData.company_name || 'Mon Commerce';
        const rating = enrichedData?.rating || parseFloat(accountData.current_rating) || 0;
        const totalReviews = enrichedData?.reviews || parseInt(accountData.tot_review) || 0;
        const userReviews = enrichedData?.user_reviews || [];
        const ratingSummary = enrichedData?.rating_summary || {};
        const popularTimes = enrichedData?.popular_times || null;
        const competitors = enrichedData?.competitors || [];
        const timeSpent = enrichedData?.time_spent || null;
        const extensions = enrichedData?.extensions || [];
        const lastUpdated = enrichedData?.last_updated;
        
        // Analyze data
        const sentimentAnalysis = analyzeReviews(userReviews);
        const busyAnalysis = analyzeBusyTimes(popularTimes);
        
        // Build HTML
        let html = `
        <div class="dashboard-container">
            <header class="dashboard-header">
                <div class="header-left">
                    <img src="/logo.png" alt="GoReview" class="logo">
                    <h1 class="business-name">${escapeHtml(businessName)}</h1>
                </div>
                <div class="header-right">
                    ${lastUpdated ? `<span class="last-updated">Mis à jour: ${new Date(lastUpdated).toLocaleString('fr-FR')}</span>` : ''}
                    <button class="theme-toggle" id="themeToggle" title="Basculer le thème">
                        <svg class="theme-icon sun-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <circle cx="12" cy="12" r="5"></circle>
                            <line x1="12" y1="1" x2="12" y2="3"></line>
                            <line x1="12" y1="21" x2="12" y2="23"></line>
                            <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line>
                            <line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line>
                            <line x1="1" y1="12" x2="3" y2="12"></line>
                            <line x1="21" y1="12" x2="23" y2="12"></line>
                            <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line>
                            <line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line>
                        </svg>
                        <svg class="theme-icon moon-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path>
                        </svg>
                    </button>
                    <button class="settings-btn" onclick="window.location.href='/config.html?id=${accountId}'">⚙️</button>
                </div>
            </header>
            
            <div class="dashboard-grid">
        `;
        
        // ═══════════════════════════════════════════════════════════════════
        // ROW 1: Main Metrics
        // ═══════════════════════════════════════════════════════════════════
        
        // Rating Card
                html += `
            <div class="card span-3">
                <div class="card-header">
                    <span class="card-title">Note moyenne</span>
                    <span class="card-icon purple">⭐</span>
                </div>
                <div class="stars-display">${renderStars(rating)}</div>
                <div class="metric-value">${rating > 0 ? rating.toFixed(1) : '–'}</div>
                <div class="metric-label">sur 5 étoiles</div>
                    </div>
                `;
            
        // Total Reviews Card
                html += `
            <div class="card span-3">
                <div class="card-header">
                    <span class="card-title">Total avis</span>
                    <span class="card-icon blue">📊</span>
                </div>
                <div class="metric-value" style="color: var(--info);">${totalReviews > 0 ? totalReviews.toLocaleString('fr-FR') : '–'}</div>
                <div class="metric-label">avis sur Google</div>
                    </div>
                `;
        
        // Response Rate Card
        const responseRate = sentimentAnalysis?.responseRate || 0;
        html += `
            <div class="card span-3">
                <div class="card-header">
                    <span class="card-title">Taux de réponse</span>
                    <span class="card-icon ${responseRate >= 80 ? 'green' : responseRate >= 50 ? 'orange' : 'red'}">💬</span>
                </div>
                <div class="gauge-container">
                    <div class="gauge-bg"></div>
                    <div class="gauge-fill" style="--gauge-value: ${responseRate}"></div>
                    <div class="gauge-center"></div>
                    <div class="gauge-value">${responseRate}%</div>
                </div>
                ${sentimentAnalysis?.notRespondedCount > 0 ? `
                <div style="text-align:center; margin-top:0.5rem;">
                    <span style="color: var(--danger); font-size: 0.85rem;">⚠️ ${sentimentAnalysis.notRespondedCount} avis sans réponse</span>
                </div>
                ` : ''}
            </div>
        `;
        
        // NFC Reviews Collected
        const nfcReviews = parseInt(accountData.review_number) || 0;
        html += `
            <div class="card span-3">
                <div class="card-header">
                    <span class="card-title">Avis via NFC</span>
                    <span class="card-icon green">📱</span>
                </div>
                <div class="metric-value" style="color: var(--success);">${nfcReviews}</div>
                <div class="metric-label">collectés via votre plaque</div>
            </div>
        `;
        
        // ═══════════════════════════════════════════════════════════════════
        // ROW 2: AI Insight + Rating Distribution
        // ═══════════════════════════════════════════════════════════════════
        
        // AI Insight Card (Leia)
        html += `
            <div class="card span-8">
                <div class="ai-insight">
                    <div class="ai-header">
                        <div class="ai-icon">🤖</div>
                        <div>
                            <div class="ai-title">Conseil IA de la semaine</div>
                            <div class="ai-subtitle">Analyse basée sur vos ${userReviews.length} derniers avis</div>
                        </div>
                    </div>
                    <div class="ai-content">
                        ${userReviews.length > 0 ? `
                            ${sentimentAnalysis?.positiveThemes?.length > 0 ? `
                                <p>🟢 <strong>Points forts mentionnés :</strong> ${sentimentAnalysis.positiveThemes.map(t => `<span class="ai-highlight">${t}</span>`).join(', ')}</p>
                            ` : ''}
                            ${sentimentAnalysis?.negativeThemes?.length > 0 ? `
                                <p style="margin-top:0.75rem;">🔴 <strong>Points d'amélioration :</strong> ${sentimentAnalysis.negativeThemes.map(t => `<span class="ai-highlight" style="background:rgba(239,68,68,0.3)">${t}</span>`).join(', ')}</p>
                            ` : ''}
                            ${busyAnalysis?.peakDay ? `
                                <p style="margin-top:0.75rem;">📈 <strong>Conseil staffing :</strong> Votre pic d'affluence est le <span class="ai-highlight">${busyAnalysis.peakDay} à ${busyAnalysis.peakHour}</span>. Assurez-vous d'avoir suffisamment de personnel à ce moment.</p>
                            ` : ''}
                            ${responseRate < 50 ? `
                                <p style="margin-top:0.75rem;">💬 <strong>Action recommandée :</strong> Votre taux de réponse est de ${responseRate}%. Répondre aux avis améliore votre visibilité Google et fidélise vos clients.</p>
                            ` : ''}
                        ` : `
                            <p>Pas assez de données pour générer une analyse. Encouragez vos clients à laisser des avis via votre plaque NFC !</p>
                        `}
                    </div>
                </div>
            </div>
        `;
        
        // Rating Distribution
        html += `
            <div class="card span-4">
                <div class="card-header">
                    <span class="card-title">Distribution des avis</span>
                    <span class="card-icon purple">📈</span>
                </div>
                <div class="rating-distribution">
        `;
        
        // Calculate distribution
        const distribution = {};
        if (ratingSummary && typeof ratingSummary === 'object') {
            for (let i = 5; i >= 1; i--) {
                const key = String(i);
                distribution[i] = ratingSummary[key] || ratingSummary[`${i}_star`] || ratingSummary[`stars_${i}`] || 0;
            }
                } else {
            // Estimate from reviews
            userReviews.forEach(r => {
                const star = Math.round(r.rating);
                distribution[star] = (distribution[star] || 0) + 1;
            });
        }
        
        const totalDist = Object.values(distribution).reduce((a, b) => a + b, 0) || 1;
        
        for (let i = 5; i >= 1; i--) {
            const count = distribution[i] || 0;
            const pct = (count / totalDist) * 100;
                html += `
                <div class="rating-bar-row">
                    <span class="rating-bar-label">${i}★</span>
                    <div class="rating-bar-track">
                        <div class="rating-bar-fill star-${i}" style="width: ${pct}%"></div>
                    </div>
                    <span class="rating-bar-count">${count.toLocaleString('fr-FR')}</span>
                    </div>
                `;
            }
            
        html += `
                </div>
            </div>
        `;
        
        // ═══════════════════════════════════════════════════════════════════
        // ROW 3: Popular Times + Competitors
        // ═══════════════════════════════════════════════════════════════════
        
        // Popular Times Chart
        html += `
            <div class="card span-8">
                <div class="card-header">
                    <span class="card-title">Affluence hebdomadaire</span>
                    <span class="card-icon orange">📊</span>
                </div>
        `;
        
        if (busyAnalysis && busyAnalysis.analyzed) {
            html += `<div class="popular-times-chart">`;
            
            const days = ['monday', 'tuesday', 'wednesday', 'thursday', 'friday', 'saturday', 'sunday'];
            
            days.forEach(day => {
                const dayData = busyAnalysis.analyzed[day];
                if (!dayData || !dayData.hours || dayData.hours.length === 0) return;
                
                html += `
                    <div class="day-row">
                        <span class="day-label">${busyAnalysis.daysFr[day]}</span>
                        <div class="hours-chart">
                `;
                
                dayData.hours.forEach(h => {
                    const score = h.score || 0;
                    const height = Math.max(score, 5);
                    let cls = 'low';
                    if (score >= 80) cls = 'peak';
                    else if (score >= 60) cls = 'high';
                    else if (score >= 30) cls = 'medium';
                    
                    html += `<div class="hour-bar ${cls}" style="height: ${height}%" title="${h.hour}: ${score}%"></div>`;
                });
                
                html += `
                </div>
                                </div>
                `;
            });
            
            html += `</div>`;
            
            // Staffing Alert
            if (busyAnalysis.peakDay) {
                html += `
                    <div class="staffing-alert">
                        <span class="staffing-alert-icon">⚡</span>
                        <div class="staffing-alert-content">
                            <h4>Pic d'affluence détecté</h4>
                            <p><strong>${busyAnalysis.peakDay} à ${busyAnalysis.peakHour}</strong> est votre moment le plus chargé (${busyAnalysis.peakScore}%). Prévoyez du personnel supplémentaire.</p>
                            </div>
                        </div>
                `;
            }
                } else {
            html += `
                <div class="empty-state">
                    <div class="empty-state-icon">📊</div>
                    <p>Données d'affluence non disponibles</p>
                                </div>
            `;
        }
        
        html += `</div>`;
        
        // Competitors Card
        html += `
            <div class="card span-4">
                <div class="card-header">
                    <span class="card-title">Benchmark concurrentiel</span>
                    <span class="card-icon blue">🏆</span>
                            </div>
        `;
        
        if (competitors && competitors.length > 0) {
            // Sort competitors by rating
            const allCompetitors = [
                { name: businessName, rating: rating, reviews: totalReviews, isYou: true }
            ].concat(competitors.filter(c => c.rating).map(c => ({
                name: c.name,
                rating: c.rating,
                reviews: c.reviews,
                type: Array.isArray(c.type) ? c.type[0] : c.type,
                isYou: false
            })));
            
            allCompetitors.sort((a, b) => b.rating - a.rating);
            
            html += `<div class="competitors-list">`;
            
            allCompetitors.slice(0, 5).forEach((comp, idx) => {
                html += `
                    <div class="competitor-item ${comp.isYou ? 'you' : ''}">
                        <span class="competitor-rank">${idx + 1}</span>
                        <div class="competitor-info">
                            <div class="competitor-name">${escapeHtml(comp.name)} ${comp.isYou ? '(Vous)' : ''}</div>
                            ${comp.type ? `<div class="competitor-type">${escapeHtml(comp.type)}</div>` : ''}
                        </div>
                        <div class="competitor-rating">
                            <span class="star filled">★</span>
                            <span class="competitor-rating-value">${comp.rating?.toFixed(1) || '–'}</span>
                            <span class="competitor-reviews">(${comp.reviews?.toLocaleString('fr-FR') || '–'})</span>
                                    </div>
                                </div>
                `;
            });
            
            html += `</div>`;
        } else {
            html += `
                <div class="empty-state">
                    <div class="empty-state-icon">🏆</div>
                    <p>Pas de concurrents identifiés</p>
                            </div>
            `;
        }
        
        html += `</div>`;
        
        // ═══════════════════════════════════════════════════════════════════
        // ROW 4: Reviews + Marketing
        // ═══════════════════════════════════════════════════════════════════
        
        // Recent Reviews
        html += `
            <div class="card span-6">
                <div class="card-header">
                    <span class="card-title">Derniers avis</span>
                    <span class="card-icon purple">💬</span>
                        </div>
        `;
        
        if (userReviews && userReviews.length > 0) {
            html += `<div class="reviews-list">`;
            
            userReviews.slice(0, 5).forEach(review => {
                const initial = (review.name || 'A')[0].toUpperCase();
                html += `
                    <div class="review-item">
                        <div class="review-header">
                            <div class="review-author">
                                <div class="review-avatar">${initial}</div>
                                <div>
                                    <div class="review-name">${escapeHtml(review.name)}</div>
                                    <div class="review-date">${escapeHtml(review.date || '')}</div>
                                </div>
                            </div>
                            <div class="review-rating">${renderStars(review.rating, '0.9rem')}</div>
                        </div>
                        ${review.description ? `<div class="review-text">${escapeHtml(review.description.slice(0, 200))}${review.description.length > 200 ? '...' : ''}</div>` : ''}
                        ${review.response ? `
                            <div class="review-response">
                                <div class="review-response-label">Votre réponse</div>
                                <div class="review-response-text">${escapeHtml(review.response.slice(0, 150))}${review.response.length > 150 ? '...' : ''}</div>
                    </div>
                        ` : review.rating <= 3 ? `
                            <div class="review-no-response">
                                <span>⚠️</span> Cet avis n'a pas de réponse - Répondre améliore votre SEO
                </div>
                        ` : ''}
            </div>
                `;
            });
            
            html += `</div>`;
        } else {
            html += `
                <div class="empty-state">
                    <div class="empty-state-icon">💬</div>
                    <p>Aucun avis récent disponible</p>
                    </div>
            `;
        }
        
        html += `</div>`;
        
        // Marketing Card
        html += `
            <div class="card span-6">
                <div class="card-header">
                    <span class="card-title">Marketing & Social</span>
                    <span class="card-icon green">📣</span>
                </div>
        `;
        
        // Find best review for social post
        const bestReview = userReviews.find(r => r.rating >= 4 && r.description && r.description.length > 20);
        
        if (bestReview) {
            html += `
                <p style="color: var(--text-muted); font-size: 0.9rem; margin-bottom: 1rem;">
                    Transformez vos meilleurs avis en contenu social 📱
                </p>
                <div class="social-post-preview">
                    <div class="social-post-quote">"${escapeHtml(bestReview.description.slice(0, 150))}${bestReview.description.length > 150 ? '...' : ''}"</div>
                    <div class="social-post-author">— ${escapeHtml(bestReview.name)}, client satisfait ⭐⭐⭐⭐⭐</div>
                </div>
                <div class="social-post-actions">
                    <button class="btn btn-primary" onclick="copyToClipboard('${escapeHtml(bestReview.description.replace(/'/g, "\\'"))}')">📋 Copier</button>
                    <button class="btn btn-secondary" onclick="generateNextReview()">🔄 Autre avis</button>
                </div>
            `;
        }
        
        // Attributes
        if (extensions && extensions.length > 0) {
            html += `
                <div style="margin-top: 1.5rem;">
                    <h4 style="font-size: 0.85rem; color: var(--text-muted); margin-bottom: 0.75rem;">Vos attributs Google</h4>
                    <div class="attributes-grid">
            `;
            
            const attrIcons = {
                'wheelchair': '♿',
                'delivery': '🚚',
                'takeout': '🥡',
                'dine-in': '🍽️',
                'credit': '💳',
                'nfc': '📱',
                'parking': '🅿️',
                'wifi': '📶',
                'outdoor': '☀️'
            };
            
            extensions.slice(0, 8).forEach(attr => {
                const attrLower = (attr || '').toLowerCase();
                let icon = '✓';
                Object.keys(attrIcons).forEach(key => {
                    if (attrLower.includes(key)) icon = attrIcons[key];
                });
                
                html += `
                    <div class="attribute-tag">
                        <span class="icon">${icon}</span>
                        ${escapeHtml(attr)}
                    </div>
                `;
            });
            
            html += `</div></div>`;
        }
        
        // Time spent
        if (timeSpent) {
            html += `
                <div style="margin-top: 1.5rem; padding: 1rem; background: var(--bg-secondary); border-radius: 12px; text-align: center;">
                    <div style="font-size: 0.8rem; color: var(--text-muted); margin-bottom: 0.5rem;">Durée moyenne de visite</div>
                    <div style="font-size: 1.5rem; font-weight: 700; color: var(--info);">${escapeHtml(timeSpent)}</div>
                    <div style="font-size: 0.8rem; color: var(--text-muted); margin-top: 0.5rem;">💡 Un temps court = paiement rapide essentiel</div>
                </div>
            `;
        }
        
        html += `</div>`;
        
        // ═══════════════════════════════════════════════════════════════════
        // ROW 5: Reviews Management
        // ═══════════════════════════════════════════════════════════════════
        
        html += `
            <div class="card span-12">
                <div class="card-header">
                    <span class="card-title">Gestion des avis</span>
                    <span class="card-icon purple">⭐</span>
                                </div>
                
                <div class="review-stats">
                    <div class="review-stat">
                        <div class="review-stat-value">${userReviews.length}</div>
                        <div class="review-stat-label">Total avis</div>
                            </div>
                    <div class="review-stat">
                        <div class="review-stat-value" style="color: var(--danger);">${userReviews.filter(r => r.rating <= 3).length}</div>
                        <div class="review-stat-label">Avis négatifs (≤3★)</div>
                        </div>
                    <div class="review-stat">
                        <div class="review-stat-value" style="color: var(--success);">${userReviews.filter(r => r.response).length}</div>
                        <div class="review-stat-label">Avec réponse</div>
                                </div>
                    <div class="review-stat">
                        <div class="review-stat-value" style="color: var(--warning);">${userReviews.filter(r => !r.response).length}</div>
                        <div class="review-stat-label">Sans réponse</div>
                            </div>
                        </div>
                
                <div class="review-filters">
                    <div class="filter-group">
                        <div class="filter-label">Filtrer par note</div>
                        <div class="filter-buttons">
                            <button class="filter-btn active" data-rating="all" onclick="filterReviews('rating', 'all')">Tous</button>
                            <button class="filter-btn rating-1" data-rating="1" onclick="filterReviews('rating', '1')">1★</button>
                            <button class="filter-btn rating-2" data-rating="2" onclick="filterReviews('rating', '2')">2★</button>
                            <button class="filter-btn rating-3" data-rating="3" onclick="filterReviews('rating', '3')">3★</button>
                            <button class="filter-btn" data-rating="4" onclick="filterReviews('rating', '4')">4★</button>
                            <button class="filter-btn" data-rating="5" onclick="filterReviews('rating', '5')">5★</button>
                                    </div>
                                </div>
                    
                    <div class="filter-group">
                        <div class="filter-label">Filtrer par réponse</div>
                        <div class="filter-buttons">
                            <button class="filter-btn active" data-response="all" onclick="filterReviews('response', 'all')">Tous</button>
                            <button class="filter-btn" data-response="replied" onclick="filterReviews('response', 'replied')">Avec réponse</button>
                            <button class="filter-btn" data-response="unreplied" onclick="filterReviews('response', 'unreplied')">Sans réponse</button>
                            </div>
                        </div>
                    
                    <div class="filter-group">
                        <div class="filter-label">Trier par</div>
                        <select class="sort-select" id="reviewSortSelect" onchange="sortReviews(this.value)">
                            <option value="rating-asc">Note ↑ (pire d'abord)</option>
                            <option value="rating-desc">Note ↓ (meilleure d'abord)</option>
                            <option value="date-desc" selected>Date ↓ (récent d'abord)</option>
                            <option value="date-asc">Date ↑ (ancien d'abord)</option>
                        </select>
                                </div>
                            </div>
                
                <div class="reviews-list" id="reviewsManagementList">
        `;
        
        // Store reviews globally for filtering
        if (userReviews && userReviews.length > 0) {
            // Sort by rating (worst first) then by date
            const sortedReviews = [...userReviews].sort((a, b) => {
                if (a.rating !== b.rating) return a.rating - b.rating;
                return new Date(b.date || 0) - new Date(a.date || 0);
            });
            
            sortedReviews.forEach((review, idx) => {
                const initial = (review.name || 'A')[0].toUpperCase();
                const isBadReview = review.rating <= 3;
                const placeId = accountData.business_id || accountData.place_id || '';
                // Priority: 1. Direct review link from SerpAPI, 2. Google Business Profile, 3. Google Maps
                const reviewLink = review.link || `https://business.google.com/reviews?hl=fr`;
                const mapsLink = `https://www.google.com/maps/place/?q=place_id:${placeId}`;
                const actionLink = review.link || mapsLink;
                
                html += `
                    <div class="review-item ${isBadReview ? 'bad-review' : ''}" 
                         data-rating="${review.rating}" 
                         data-response="${review.response ? 'replied' : 'unreplied'}">
                        <div class="review-header">
                            <div class="review-author">
                                <div class="review-avatar">${initial}</div>
                                <div>
                                    <div class="review-name">${escapeHtml(review.name)} ${review.local_guide ? '<span class="local-guide-badge" title="Local Guide">🏅</span>' : ''}</div>
                                    <div class="review-date">${escapeHtml(review.date || '')} ${review.likes > 0 ? `• 👍 ${review.likes}` : ''}</div>
                        </div>
                    </div>
                            <div style="display: flex; align-items: center; gap: 0.75rem;">
                                <div class="review-rating">${renderStars(review.rating, '0.9rem')}</div>
                                <a href="${actionLink}" target="_blank" class="view-review-btn" title="Voir l'avis sur Google Maps">🔗</a>
                                ${!review.response ? `
                                    <a href="https://business.google.com/reviews?hl=fr" target="_blank" class="reply-btn ${isBadReview ? 'urgent' : ''}" title="Ouvrir Google Business Profile pour répondre">💬 Répondre</a>
                                ` : ''}
                </div>
            </div>
                        ${review.description ? `<div class="review-text">${escapeHtml(review.description)}</div>` : ''}
                        ${review.response ? `
                            <div class="review-response">
                                <div class="review-response-label">✅ Votre réponse</div>
                                <div class="review-response-text">${escapeHtml(review.response)}</div>
                    </div>
                        ` : isBadReview ? `
                            <div class="review-no-response urgent">
                                <span>🚨</span> Avis négatif sans réponse - <strong>Action prioritaire recommandée</strong>
                </div>
                        ` : review.rating <= 4 ? `
                            <div class="review-no-response">
                                <span>⚠️</span> Avis sans réponse
                </div>
                        ` : ''}
                </div>
                `;
            });
        } else {
            html += `
                <div class="empty-state">
                    <div class="empty-state-icon">⭐</div>
                    <p>Aucun avis disponible</p>
                    </div>
            `;
        }
        
        html += `
                    </div>
                </div>
        `;
        
        // ═══════════════════════════════════════════════════════════════════
        // ROW 6: Contacts
        // ═══════════════════════════════════════════════════════════════════
        
        html += `
            <div class="card span-12">
                <div class="card-header">
                    <span class="card-title">Contacts collectés via NFC</span>
                    <span class="card-icon green">👥</span>
                    </div>
                <div class="contacts-preview" id="contactsContainer">
                    <div class="empty-state">
                        <div class="loading-spinner" style="margin: 0 auto;"></div>
                </div>
            </div>
                <div style="margin-top: 1rem;">
                    <a href="/contacts.html?id=${accountId}" class="btn btn-primary">Voir tous les contacts →</a>
                </div>
                </div>
        `;
        
        html += `
            </div>
        </div>
    `;
        
        app.innerHTML = html;
        
        // Initialize theme toggle
        initThemeToggle();
        
        // Load contacts
        loadContacts(accountId);
    }
    
    // Load contacts
    async function loadContacts(accountId) {
        const container = document.getElementById('contactsContainer');
        if (!container) return;
        
        try {
        const dbProxy = await window.waitForDbProxy();
            const { data, error } = await dbProxy.select('accounts', { id: accountId }, { select: ['contact_table'], single: true });
            
            if (error || !data) {
                container.innerHTML = '<div class="empty-state"><p>Erreur de chargement</p></div>';
                            return;
                        }
            
            let contacts = [];
            if (data.contact_table) {
                try {
                    contacts = typeof data.contact_table === 'string' ? JSON.parse(data.contact_table) : data.contact_table;
                } catch (e) {
                    contacts = [];
                }
            }
            
            if (!Array.isArray(contacts) || contacts.length === 0) {
                container.innerHTML = '<div class="empty-state"><div class="empty-state-icon">👥</div><p>Aucun contact collecté pour le moment</p></div>';
                            return;
                        }
                
            // Filter out default contact and sort by date
            const filteredContacts = contacts
                .filter(c => c.email !== 'goreview.fr@gmail.com')
                .sort((a, b) => new Date(b.time || b.timestamp || 0) - new Date(a.time || a.timestamp || 0))
                .slice(0, 5);
            
            if (filteredContacts.length === 0) {
                container.innerHTML = '<div class="empty-state"><div class="empty-state-icon">👥</div><p>Aucun contact collecté pour le moment</p></div>';
                    return;
                }
                
            let tableHtml = `
                <table class="contacts-table">
                    <thead>
                        <tr>
                            <th>Nom</th>
                            <th>Prénom</th>
                            <th>Email</th>
                            <th>Date</th>
                        </tr>
                    </thead>
                    <tbody>
            `;
            
            filteredContacts.forEach(c => {
                const dateStr = c.time || c.timestamp;
                let formattedDate = '–';
                if (dateStr) {
                    try {
                        formattedDate = new Date(dateStr).toLocaleDateString('fr-FR', {
                            year: 'numeric', month: '2-digit', day: '2-digit', hour: '2-digit', minute: '2-digit'
                        });
                    } catch (e) {}
                }
                
                tableHtml += `
                    <tr>
                        <td>${escapeHtml(c.nom || '–')}</td>
                        <td>${escapeHtml(c.prenom || '–')}</td>
                        <td><a href="mailto:${escapeHtml(c.email)}">${escapeHtml(c.email || '–')}</a></td>
                        <td>${formattedDate}</td>
                    </tr>
                `;
            });
            
            tableHtml += '</tbody></table>';
            container.innerHTML = tableHtml;
            
        } catch (e) {
            container.innerHTML = '<div class="empty-state"><p>Erreur de chargement</p></div>';
        }
    }
    
    // Clipboard function
    window.copyToClipboard = function(text) {
        navigator.clipboard.writeText(text).then(() => {
            alert('Texte copié !');
        }).catch(() => {
            alert('Erreur lors de la copie');
        });
    };
    
    // Review filtering function
    let currentFilters = {
        rating: 'all',
        response: 'all'
    };
    
    window.filterReviews = function(filterType, value) {
        currentFilters[filterType] = value;
        
        // Update button states
        document.querySelectorAll(`[data-${filterType}]`).forEach(btn => {
            if (btn.getAttribute(`data-${filterType}`) === value) {
                btn.classList.add('active');
            } else {
                btn.classList.remove('active');
            }
        });
        
        // Apply filters to reviews
        const reviewsList = document.getElementById('reviewsManagementList');
        if (!reviewsList) return;
        
        const allReviews = reviewsList.querySelectorAll('.review-item');
        
        allReviews.forEach(reviewEl => {
            const reviewRating = reviewEl.getAttribute('data-rating');
            const reviewResponse = reviewEl.getAttribute('data-response');
            
            let showReview = true;
            
            // Apply rating filter
            if (currentFilters.rating !== 'all') {
                const filterRating = parseInt(currentFilters.rating);
                const itemRating = parseInt(reviewRating);
                
                // For ratings 1-3, show exact match. For 4-5, show >= match
                if (filterRating <= 3) {
                    showReview = itemRating === filterRating;
                } else {
                    showReview = itemRating === filterRating;
                }
            }
            
            // Apply response filter
            if (showReview && currentFilters.response !== 'all') {
                showReview = reviewResponse === currentFilters.response;
            }
            
            // Show or hide review
            reviewEl.style.display = showReview ? 'block' : 'none';
        });
    };
    
    // Sorting function for reviews
    window.sortReviews = function(sortBy) {
        const reviewsList = document.getElementById('reviewsManagementList');
        if (!reviewsList) return;
        
        const reviewsArray = Array.from(reviewsList.querySelectorAll('.review-item'));
        
        reviewsArray.sort((a, b) => {
            const aRating = parseInt(a.getAttribute('data-rating')) || 0;
            const bRating = parseInt(b.getAttribute('data-rating')) || 0;
            const aDate = a.querySelector('.review-date')?.textContent || '';
            const bDate = b.querySelector('.review-date')?.textContent || '';
            
            switch (sortBy) {
                case 'rating-asc':
                    return aRating - bRating;
                case 'rating-desc':
                    return bRating - aRating;
                case 'date-desc':
                    // Parse French dates or ISO dates
                    return parseFrenchDate(bDate) - parseFrenchDate(aDate);
                case 'date-asc':
                    return parseFrenchDate(aDate) - parseFrenchDate(bDate);
                default:
                    return 0;
            }
        });
        
        // Re-append in sorted order
        reviewsArray.forEach(review => reviewsList.appendChild(review));
    };
    
    // Helper to parse dates (handles various formats)
    function parseFrenchDate(dateStr) {
        if (!dateStr) return 0;
        
        // Remove emojis and extra info
        const cleanDate = dateStr.split('•')[0].trim();
        
        // Try to parse relative dates like "il y a 2 jours", "il y a 1 mois"
        const relativeMatch = cleanDate.match(/il y a (\d+) (jour|semaine|mois|an)/i);
        if (relativeMatch) {
            const num = parseInt(relativeMatch[1]);
            const unit = relativeMatch[2].toLowerCase();
            const now = Date.now();
            if (unit.includes('jour')) return now - (num * 24 * 60 * 60 * 1000);
            if (unit.includes('semaine')) return now - (num * 7 * 24 * 60 * 60 * 1000);
            if (unit.includes('mois')) return now - (num * 30 * 24 * 60 * 60 * 1000);
            if (unit.includes('an')) return now - (num * 365 * 24 * 60 * 60 * 1000);
        }
        
        // Try standard date parsing
        const parsed = Date.parse(cleanDate);
        if (!isNaN(parsed)) return parsed;
        
        return 0;
    }
    
    // ═══════════════════════════════════════════════════════════════════
    // MAIN INIT
    // ═══════════════════════════════════════════════════════════════════
                    
                    try {
                            const dbProxy = await window.waitForDbProxy();
                            
        const { data: accountData, error } = await dbProxy.select('accounts', { id: accountId }, { single: true });
        
        if (error || !accountData) {
            document.getElementById('loadingStatus').innerHTML = '❌ Compte introuvable';
            return;
        }
        
        // Check if factory reset
        if (!accountData.business_id && !accountData.company_name && !accountData.redirection_url) {
                            window.location.replace(`/create.html?id=${encodeURIComponent(accountId)}`);
            return;
        }
        
        // Fetch enriched data
        const placeId = accountData.business_id || accountData.place_id;
        const enrichedData = placeId ? await fetchEnrichedData(placeId) : null;
        
        // Render dashboard
        await renderDashboard(accountData, enrichedData);
        
    } catch (e) {
        console.error('Dashboard error:', e);
        document.getElementById('loadingStatus').innerHTML = '❌ Erreur de chargement';
    }
})();
</script>
</body>
</html>
