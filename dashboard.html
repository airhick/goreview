<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard - GoReview</title>
    <meta http-equiv="Content-Security-Policy" content="default-src 'self' http://localhost:*; connect-src 'self' http://localhost:* https://*.googleapis.com https://*.google.com https://maps.googleapis.com https://maps.gstatic.com https://vigutqmfosxbpncussie.supabase.co https://*.netlify.app https://*.netlify.com https://n8n.goreview.fr; img-src 'self' data: https: blob:; script-src 'self' 'unsafe-inline' 'unsafe-eval' https://accounts.google.com https://www.google.com https://*.google.com https://maps.googleapis.com https://cdn.jsdelivr.net; style-src 'self' 'unsafe-inline'; frame-src 'self' http://localhost:* https://www.google.com https://*.google.com https://maps.google.com;">
    <script>
      // Suppress ONLY MCP/BrowserAutomation errors, keep all other errors visible
      (function(){
        const isMCPError = (msg) => {
          if (!msg) return false;
          const str = String(msg).toLowerCase();
          return str.includes('localhost:62462') || 
                 str.includes('browserautomation') || 
                 str.includes('registerwithmcp') || 
                 str.includes('pollforcommands') ||
                 (str.includes('vm') && str.includes('register-iframe'));
        };
        
        // Only suppress console errors that are MCP-related
        const originalError = console.error;
        console.error = function(...args) {
          const isMCP = args.some(arg => isMCPError(String(arg)));
          if (!isMCP) {
            originalError.apply(console, args);
          }
        };
        
        // Suppress fetch errors only for localhost:62462
        const originalFetch = window.fetch;
        window.fetch = function(...args) {
          if (args[0] && args[0].includes && args[0].includes('localhost:62462')) {
            return Promise.reject(new Error('Blocked by dev filter')).catch(() => {});
          }
          return originalFetch.apply(this, args);
        };
        
        // Suppress XMLHttpRequest errors only for localhost:62462
        const originalOpen = XMLHttpRequest.prototype.open;
        XMLHttpRequest.prototype.open = function(method, url, ...rest) {
          if (url && url.includes('localhost:62462')) {
            this.addEventListener('error', () => {}, {once: true});
            this.addEventListener('loadend', () => {}, {once: true});
          }
          return originalOpen.apply(this, [method, url, ...rest]);
        };
      })();
    </script>
    <link rel="stylesheet" href="styles.css">
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script>
        // Force reload of db-proxy.js to avoid cache issues
        (function() {
            const script = document.createElement('script');
            script.src = `db-proxy.js?v=${Date.now()}`;
            script.async = false; // Load synchronously to ensure it's available
            document.head.appendChild(script);
        })();
    </script>
    <script>
        // Session management functions - Global scope
        window.getCookie = function(name) {
            const value = `; ${document.cookie}`;
            const parts = value.split(`; ${name}=`);
            if (parts.length === 2) {
                return decodeURIComponent(parts.pop().split(';').shift());
            }
            return null;
        };

        window.getSession = function() {
            const sessionCookie = window.getCookie('goreview_session');
            if (!sessionCookie) {
                return null;
            }
            try {
                return JSON.parse(sessionCookie);
            } catch (e) {
                console.error('Error parsing session cookie:', e);
                return null;
            }
        };

        // Check session on page load - MUST be done before any other code
        (function() {
            const params = new URLSearchParams(window.location.search);
            const idFromUrl = params.get('id');
            
            // Check if session exists
            const session = window.getSession();
            if (!session || !session.id) {
                // No session, redirect immediately to login
                window.location.replace('/dashboardlogin.html');
                return;
            }
            
            // Verify that session ID matches URL ID (if ID is provided in URL)
            if (idFromUrl && session.id !== idFromUrl) {
                // Session exists but for different account, redirect to login
                window.location.replace('/dashboardlogin.html');
                return;
            }
            
            // Session is valid, store it globally for use in other scripts
            window.currentSession = session;
        })();
    </script>
    <style>
        .centered-card {
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            background: linear-gradient(135deg, #f9fafb 0%, #ffffff 100%);
        }
        .dashboard-wrap {
            background: #fff;
            border-radius: 18px;
            border: 1px solid #e5e7eb;
            box-shadow: 0 10px 25px -5px rgba(0,0,0,0.08);
            max-width: 1000px;
            width: 100%;
            padding: 2rem;
        }
        .dashboard-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 1rem;
            margin-bottom: 1.25rem;
        }
        .dash-brand {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .dash-logo {
            height: 32px;
            width: auto;
        }
        .dashboard-title {
            font-size: 1.5rem;
            margin: 0;
        }
        .cards-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
            gap: 1rem;
        }
        .stars-container {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            margin: 0.75rem 0;
        }
        .stars {
            display: flex;
            gap: 2px;
        }
        .star {
            font-size: 1.5rem;
            color: #d1d5db;
            line-height: 1;
        }
        .star.filled {
            color: #fbbf24;
        }
        .rating-value {
            font-size: 1.25rem;
            font-weight: 700;
            color: #111827;
        }
        .review-count-large {
            font-size: 2rem;
            font-weight: 700;
            color: #6366f1;
            margin: 0.75rem 0;
        }
        .card {
            border: 1px solid #e5e7eb;
            border-radius: 14px;
            padding: 1rem;
            background: #fff;
            display: flex;
            flex-direction: column;
            margin-bottom: 0;
        }
        .card h3 {
            margin: 0 0 0.35rem 0;
            font-size: 1.125rem;
        }
        .card p {
            color: #4b5563;
            margin: 0 0 0.75rem 0;
            font-size: 0.95rem;
        }
        .big-count { font-size: 2.25rem; font-weight: 800; color: #111827; }
        .card .btn-row {
            display: flex;
            gap: 0.5rem;
            flex-wrap: wrap;
            margin-top: auto;
        }
        .btn {
            display: inline-block;
            padding: 0.5rem 0.9rem;
            border-radius: 10px;
            border: 1px solid #e5e7eb;
            text-decoration: none;
            font-weight: 600;
            color: #111827;
            transition: background 0.15s;
        }
        .btn:hover { background: #f3f4f6; }
        .btn-primary { color: #fff; background: #6366f1; border-color: #6366f1; }
        .btn-primary:hover { background: #4f46e5; }
        .muted { color: #6b7280; font-size: 0.9rem; }
        .back-link { display: inline-block; margin-bottom: 2rem; text-decoration: none; color: #6366f1; }
        @media (max-width: 520px) { 
            .dashboard-title { font-size: 1.25rem; }
            .cards-grid {
                grid-template-columns: 1fr;
            }
            .card[style*="grid-column: span 2"] {
                grid-column: span 1 !important;
            }
        }
        .mini-map { width: 100%; height: 200px; border: 1px solid #e5e7eb; border-radius: 12px; }
        /* Contacts table preview */
        .contacts-preview {
            overflow-x: auto;
            margin: 1rem 0;
            border: 1px solid #e5e7eb;
            border-radius: 8px;
            max-height: 400px;
            overflow-y: auto;
        }
        .contacts-preview-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.875rem;
            min-width: 500px;
        }
        .contacts-preview-table thead {
            background: #f9fafb;
            position: sticky;
            top: 0;
            z-index: 1;
        }
        .contacts-preview-table th {
            padding: 0.75rem;
            text-align: left;
            font-weight: 600;
            color: #111827;
            border-bottom: 2px solid #e5e7eb;
            font-size: 0.875rem;
        }
        .contacts-preview-table td {
            padding: 0.75rem;
            border-bottom: 1px solid #f3f4f6;
            color: #4b5563;
        }
        .contacts-preview-table tbody tr:hover {
            background: #f9fafb;
        }
        .contacts-preview-empty {
            padding: 2rem;
            text-align: center;
            color: #6b7280;
            font-size: 0.875rem;
        }
        /* Account Info Grid */
        .account-info-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 1rem;
            margin-top: 1rem;
        }
        .info-item {
            display: flex;
            flex-direction: column;
            gap: 0.25rem;
            padding: 0.75rem;
            background: #f9fafb;
            border-radius: 8px;
            border: 1px solid #e5e7eb;
        }
        .info-item.full-width {
            grid-column: 1 / -1;
        }
        .info-label {
            font-size: 0.75rem;
            font-weight: 600;
            color: #6b7280;
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }
        .info-value {
            font-size: 0.95rem;
            color: #111827;
            font-weight: 500;
            word-break: break-word;
        }
        .info-value a {
            color: #6366f1;
            text-decoration: none;
        }
        .info-value a:hover {
            text-decoration: underline;
        }
        @media (max-width: 640px) {
            .account-info-grid {
                grid-template-columns: 1fr;
            }
        }
        /* Status Menu */
        .status-menu {
            position: relative;
        }
        .status-menu-btn {
            width: 44px;
            height: 44px;
            border: 1px solid #e5e7eb;
            border-radius: 10px;
            background: #fff;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.2s;
            font-size: 18px;
        }
        .status-menu-btn:hover {
            background: #f9fafb;
            border-color: #d1d5db;
        }
        .status-menu-panel {
            position: absolute;
            top: calc(100% + 8px);
            right: 0;
            width: 280px;
            background: #fff;
            border: 1px solid #e5e7eb;
            border-radius: 12px;
            box-shadow: 0 10px 25px -5px rgba(0,0,0,0.15);
            padding: 16px;
            display: none;
            z-index: 100;
        }
        .status-menu-panel.open {
            display: block;
        }
        .status-item {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px;
            border-radius: 8px;
            margin-bottom: 8px;
            transition: background 0.15s;
        }
        .status-item:last-child {
            margin-bottom: 0;
        }
        .status-item:hover {
            background: #f9fafb;
        }
        .status-icon {
            width: 36px;
            height: 36px;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 18px;
            flex-shrink: 0;
        }
        .status-icon.healthy { background: #d1fae5; }
        .status-icon.warning { background: #fef3c7; }
        .status-icon.error { background: #fee2e2; }
        .status-content {
            flex: 1;
            min-width: 0;
        }
        .status-label {
            font-size: 12px;
            color: #6b7280;
            margin-bottom: 4px;
        }
        .status-value {
            font-size: 14px;
            font-weight: 600;
            color: #111827;
            display: flex;
            align-items: center;
            gap: 6px;
        }
        .status-badge {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            flex-shrink: 0;
        }
        .status-badge.green { background: #10b981; }
        .status-badge.orange { background: #f59e0b; }
        .status-badge.red { background: #ef4444; }
        .toggle-visual {
            width: 48px;
            height: 28px;
            border-radius: 9999px;
            background: #e5e7eb;
            position: relative;
            cursor: pointer;
            transition: background 0.2s;
            flex-shrink: 0;
        }
        .toggle-visual.active {
            background: #6366f1;
        }
        .toggle-visual::after {
            content: '';
            position: absolute;
            width: 22px;
            height: 22px;
            border-radius: 50%;
            background: #fff;
            top: 3px;
            left: 3px;
            transition: transform 0.2s;
            box-shadow: 0 1px 3px rgba(0,0,0,0.2);
        }
        .toggle-visual.active::after {
            transform: translateX(20px);
        }
        .stat-visual {
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .stat-bar {
            flex: 1;
            height: 6px;
            background: #e5e7eb;
            border-radius: 9999px;
            overflow: hidden;
        }
        .stat-bar-fill {
            height: 100%;
            background: #6366f1;
            border-radius: 9999px;
            transition: width 0.3s;
        }
        @media (max-width: 640px) {
            .status-menu-panel {
                right: -8px;
                width: calc(100vw - 32px);
                max-width: 280px;
            }
            .status-menu-btn {
                width: 40px;
                height: 40px;
            }
        }
    </style>
</head>
<body>
<div class="centered-card" id="main">
    <!-- Populated by JS -->
</div>
<script>
(async function() {
    // First check: verify session exists before proceeding
    const session = window.getSession();
    if (!session || !session.id) {
        // No valid session, redirect to login
        window.location.replace('/dashboardlogin.html');
        return; // Stop execution
    }
    
    const mount = document.getElementById('main');
    const params = new URLSearchParams(window.location.search);
    const id = params.get('id');
    
    // Second check: verify session ID matches URL ID
    if (id && session.id !== id) {
        // Session exists but for different account
        window.location.replace('/dashboardlogin.html');
        return; // Stop execution
    }
    
    // Use session ID if URL ID is not provided, or use URL ID if it matches session
    const accountId = (id && session.id === id) ? id : session.id;
    
    // If URL has different ID than session, we already redirected above
    // So at this point, accountId is always valid and matches the session

    function setCookie(name, value, days) {
        const d = new Date();
        d.setTime(d.getTime() + (days*24*60*60*1000));
        const expires = "expires=" + d.toUTCString();
        document.cookie = name + "=" + encodeURIComponent(value) + ";" + expires + ";path=/;SameSite=Lax";
    }

    function getCookie(name) {
        const nameEQ = name + "=";
        const ca = document.cookie.split(';');
        for (let c of ca) {
            while (c.charAt(0) === ' ') c = c.substring(1);
            if (c.indexOf(nameEQ) === 0) return decodeURIComponent(c.substring(nameEQ.length));
        }
        return null;
    }

    // Session is already verified above, accountId is always valid at this point
    // No need for additional cookie checks - session cookie handles authentication

    // Status menu toggle
    function initStatusMenu() {
        const btn = document.getElementById('statusMenuBtn');
        const panel = document.getElementById('statusMenuPanel');
        if (!btn || !panel) return;
        
        btn.addEventListener('click', (e) => {
            e.stopPropagation();
            panel.classList.toggle('open');
        });
        
        document.addEventListener('click', (e) => {
            if (!panel.contains(e.target) && !btn.contains(e.target)) {
                panel.classList.remove('open');
            }
        });
    }

    // Load contacts preview from contact_table column
    async function loadContactsPreview() {
        const tbody = document.getElementById('contactsPreviewBody');
        if (!tbody) return;

        try {
            // Wait for db-proxy to be available
            const dbProxy = await window.waitForDbProxy();
            
            // First, get the account data to retrieve contact_table
            const { data: accountData, error: fetchError } = await dbProxy.select('accounts', { id: accountId }, { select: ['contact_table'], single: true });

            if (fetchError) {
                tbody.innerHTML = `<tr><td colspan='4' class='contacts-preview-empty'>Erreur: ${fetchError.message}</td></tr>`;
                return;
            }

            // Parse contact_table (should be a JSON string or already an array)
            let contacts = [];
            if (accountData && accountData.contact_table) {
                try {
                    contacts = typeof accountData.contact_table === 'string' 
                        ? JSON.parse(accountData.contact_table) 
                        : accountData.contact_table;
                    if (!Array.isArray(contacts)) {
                        contacts = [];
                    }
                } catch (parseError) {
                    console.warn('Failed to parse contact_table', parseError);
                    contacts = [];
                }
            }

            // If no contacts and contact_table is empty/null, initialize with example contact
            if (contacts.length === 0) {
                const exampleContact = {
                    nom: 'go',
                    prenom: 'Review',
                    email: 'goreview.fr@gmail.com',
                    time: new Date().toISOString()
                };
                contacts = [exampleContact];
                
                // Save the example contact to contact_table
                try {
                    const dbProxy = await window.waitForDbProxy();
                    await dbProxy.update('accounts', { contact_table: JSON.stringify(contacts) }, { id: accountId });
                } catch (updateError) {
                    console.warn('Failed to initialize contact_table', updateError);
                }
            } else {
                // Normalize date fields - convert 'timestamp' to 'time' for consistency
                contacts = contacts.map(c => {
                    if (c.timestamp && !c.time) {
                        c.time = c.timestamp;
                        delete c.timestamp;
                    }
                    return c;
                });
                
                // Save normalized contacts back to database
                    try {
                        const dbProxy = await window.waitForDbProxy();
                    await dbProxy.update('accounts', { contact_table: JSON.stringify(contacts) }, { id: accountId });
                    } catch (updateError) {
                        console.warn('Failed to save normalized contacts', updateError);
                    }
                
                // Check if the example contact exists, if not add it
                const hasExample = contacts.some(c => 
                    c.email === 'goreview.fr@gmail.com' || 
                    (c.nom === 'go' && c.prenom === 'Review')
                );
                
                if (!hasExample) {
                    const exampleContact = {
                        nom: 'go',
                        prenom: 'Review',
                        email: 'goreview.fr@gmail.com',
                        time: new Date().toISOString()
                    };
                    contacts.unshift(exampleContact); // Add at the beginning
                    
                    // Save updated contacts
                    try {
                        const dbProxy = await window.waitForDbProxy();
                        await dbProxy.update('accounts', { contact_table: JSON.stringify(contacts) }, { id: accountId });
                    } catch (updateError) {
                        console.warn('Failed to update contact_table with example', updateError);
                    }
                }
            }

            // Sort by time (most recent first) - handle both 'time' and 'timestamp' fields
            contacts.sort((a, b) => {
                const timeA = (a.time || a.timestamp) ? new Date(a.time || a.timestamp).getTime() : 0;
                const timeB = (b.time || b.timestamp) ? new Date(b.time || b.timestamp).getTime() : 0;
                return timeB - timeA;
            });

            // Display up to 10 contacts
            const displayContacts = contacts.slice(0, 10);

            if (displayContacts.length === 0) {
                tbody.innerHTML = `<tr><td colspan='4' class='contacts-preview-empty'>Aucun contact enregistr√©</td></tr>`;
                return;
            }

            tbody.innerHTML = displayContacts.map(contact => {
                // Handle both 'time' and 'timestamp' fields
                const dateValue = contact.time || contact.timestamp;
                let date = '-';
                
                if (dateValue) {
                    try {
                        const dateObj = new Date(dateValue);
                        if (!isNaN(dateObj.getTime())) {
                            date = dateObj.toLocaleDateString('fr-FR', {
                                year: 'numeric',
                                month: '2-digit',
                                day: '2-digit',
                                hour: '2-digit',
                                minute: '2-digit'
                            });
                        }
                    } catch (e) {
                        console.warn('Failed to parse date:', dateValue, e);
                        date = '-';
                    }
                }
                
                return `
                    <tr>
                        <td>${contact.nom || '-'}</td>
                        <td>${contact.prenom || '-'}</td>
                        <td>${contact.email || '-'}</td>
                        <td>${date}</td>
                    </tr>
                `;
            }).join('');
        } catch (err) {
            tbody.innerHTML = `<tr><td colspan='4' class='contacts-preview-empty'>Erreur de chargement</td></tr>`;
            console.error('Failed to load contacts', err);
        }
    }

    // Fetch Google Place Details (rating and total reviews only)
    // Using proxy endpoint to avoid CORS issues
    async function fetchGooglePlaceDetails(placeId) {
        // Use local proxy for development, Netlify Function for production
        const isLocalhost = window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1';
        const proxyUrl = isLocalhost 
            ? '/api/google-place-details'  // Local Python proxy
            : '/.netlify/functions/google-place-details';  // Netlify Function
        
        const params = new URLSearchParams({ place_id: placeId });

        try {
            const response = await fetch(`${proxyUrl}?${params.toString()}`);
            
            if (!response.ok) {
                throw new Error(`HTTP ${response.status}: ${response.statusText}`);
            }
            
            const data = await response.json();
            
            if (data.status === 'OK' && data.result) {
                const rating = data.result.rating || null;
                const totalReviews = data.result.user_ratings_total || null;
                
                updateRatingDisplay(rating);
                updateTotalReviewsDisplay(totalReviews);
                
                // Optionally update database with fresh data via webhook
                try {
                    const dbProxy = await window.waitForDbProxy();
                    await dbProxy.update('accounts', {
                        current_rating: rating,
                        tot_review: totalReviews
                    }, { id: accountId });
                } catch (e) {
                    console.warn('Failed to update database with Google data', e);
                }
            } else {
                console.warn('Google Places API error:', data.status, data.error_message);
                // Fallback to database data via webhook
                const dbProxy = await window.waitForDbProxy();
                const { data: accountData } = await dbProxy.select('accounts', { id: accountId }, { select: ['current_rating', 'tot_review'], single: true });
                if (accountData) {
                    updateRatingDisplay(parseFloat(accountData.current_rating) || null);
                    updateTotalReviewsDisplay(parseInt(accountData.tot_review || '0', 10) || null);
                }
            }
        } catch (error) {
            console.error('Failed to fetch Google Place details', error);
            // Fallback to Supabase data on error
            const dbProxy = await window.waitForDbProxy();
            const { data: accountData } = await dbProxy.select('accounts', { id: accountId }, { select: ['current_rating', 'tot_review'], single: true });
            if (accountData) {
                updateRatingDisplay(parseFloat(accountData.current_rating) || null);
                updateTotalReviewsDisplay(parseInt(accountData.tot_review || '0', 10) || null);
            }
        }
    }

    // Update rating display
    function updateRatingDisplay(rating) {
        const starsDisplay = document.getElementById('starsDisplay');
        const ratingValue = document.getElementById('ratingValue');
        
        if (starsDisplay) {
            starsDisplay.innerHTML = '';
            if (rating && rating > 0) {
                for (let i = 1; i <= 5; i++) {
                    const star = document.createElement('span');
                    const isFilled = rating >= i;
                    star.className = 'star' + (isFilled ? ' filled' : '');
                    star.textContent = '‚òÖ';
                    starsDisplay.appendChild(star);
                }
            } else {
                // Show empty stars if no rating
                for (let i = 1; i <= 5; i++) {
                    const star = document.createElement('span');
                    star.className = 'star';
                    star.textContent = '‚òÖ';
                    starsDisplay.appendChild(star);
                }
            }
        }
        
        if (ratingValue) {
            ratingValue.textContent = rating && rating > 0 ? rating.toFixed(1) : '‚Äì';
        }
    }

    // Update total reviews display
    function updateTotalReviewsDisplay(totalReviews) {
        const totalReviewsEl = document.getElementById('totalReviewsCount');
        if (totalReviewsEl) {
            totalReviewsEl.textContent = totalReviews && totalReviews > 0 ? totalReviews.toLocaleString('fr-FR') : '‚Äì';
        }
    }

    // Update status indicators
    function updateStatusMenu(data) {
        if (!data) return;
        
        // Game toggle - Disabled, show "Bient√¥t"
        const gameToggle = document.getElementById('statusGameToggle');
        const gameIcon = document.getElementById('statusGameIcon');
        if (gameToggle) {
            // Disable toggle
            gameToggle.style.opacity = '0.5';
            gameToggle.style.pointerEvents = 'none';
            gameToggle.classList.remove('active');
            // Remove any existing listeners by cloning
            const oldToggle = gameToggle;
            const newToggle = oldToggle.cloneNode(true);
            newToggle.style.opacity = '0.5';
            newToggle.style.pointerEvents = 'none';
            oldToggle.parentNode.replaceChild(newToggle, oldToggle);
        }
        if (gameIcon) {
            gameIcon.className = 'status-icon';
        }

        // Health check
        const healthIssues = [];
        if (!data.business_id && !data.place_id) healthIssues.push('Place ID manquant');
        if (!data.redirection_url) healthIssues.push('Redirection non configur√©e');
        
        const healthIcon = document.getElementById('statusHealthIcon');
        const healthBadge = document.getElementById('statusHealthBadge');
        const healthText = document.getElementById('statusHealthText');
        
        if (healthIssues.length === 0) {
            if (healthIcon) { healthIcon.className = 'status-icon healthy'; healthIcon.textContent = '‚úì'; }
            if (healthBadge) { healthBadge.className = 'status-badge green'; }
            if (healthText) healthText.textContent = 'Op√©rationnel';
        } else {
            if (healthIcon) { healthIcon.className = 'status-icon error'; healthIcon.textContent = '‚ö†'; }
            if (healthBadge) { healthBadge.className = 'status-badge red'; }
            if (healthText) healthText.textContent = healthIssues[0];
        }

        // Redirection
        const redirectBadge = document.getElementById('statusRedirectBadge');
        const redirectText = document.getElementById('statusRedirectText');
        const redirectIcon = document.getElementById('statusRedirectIcon');
        const hasRedirect = !!data.redirection_url;
        if (redirectBadge) redirectBadge.className = `status-badge ${hasRedirect ? 'green' : 'orange'}`;
        if (redirectText) redirectText.textContent = hasRedirect ? 'Configur√©' : 'Non configur√©';
        if (redirectIcon) redirectIcon.className = `status-icon ${hasRedirect ? 'healthy' : 'warning'}`;

        // Database (always healthy if we got data)
        const dbIcon = document.getElementById('statusDbIcon');
        if (dbIcon) dbIcon.className = 'status-icon healthy';

        // Reviews bar (visual scale: 0-50 for better visibility)
        const reviewCount = parseInt(data.review_number || '0', 10);
        const barFill = document.getElementById('statBarFill');
        const countMini = document.getElementById('statCountMini');
        if (barFill) {
            const maxScale = 50;
            const percentage = Math.min((reviewCount / maxScale) * 100, 100);
            barFill.style.width = percentage + '%';
        }
        if (countMini) countMini.textContent = reviewCount;
    }

    mount.innerHTML = `
        <div class='dashboard-wrap'>
            <div class='dashboard-header'>
                <div class='dash-brand'>
                    <img src='logo.png' alt='GoReview' class='dash-logo'>
                    <h1 class='dashboard-title'>Dashboard GoReview <span id='bizName' style='color:#6366f1'>#${accountId}</span></h1>
                </div>
                <div class='status-menu'>
                    <button class='status-menu-btn' id='statusMenuBtn' title='Statut syst√®me'>‚öôÔ∏è</button>
                    <div class='status-menu-panel' id='statusMenuPanel'>
                        <div class='status-item'>
                            <div class='status-icon healthy' id='statusHealthIcon'>‚úì</div>
                            <div class='status-content'>
                                <div class='status-label'>Syst√®me</div>
                                <div class='status-value'>
                                    <span class='status-badge green' id='statusHealthBadge'></span>
                                    <span id='statusHealthText'>Op√©rationnel</span>
                                </div>
                            </div>
                        </div>
                        <div class='status-item'>
                            <div class='status-icon' id='statusGameIcon'>üéÆ</div>
                            <div class='status-content'>
                                <div class='status-label'>Jeu</div>
                                <div class='status-value'>
                                    <div class='toggle-visual' id='statusGameToggle'></div>
                                </div>
                            </div>
                        </div>
                        <div class='status-item'>
                            <div class='status-icon' id='statusDbIcon'>üóÑÔ∏è</div>
                            <div class='status-content'>
                                <div class='status-label'>Base de donn√©es</div>
                                <div class='status-value'>
                                    <span class='status-badge green' id='statusDbBadge'></span>
                                    <span>Connect√©</span>
                                </div>
                            </div>
                        </div>
                        <div class='status-item'>
                            <div class='status-icon' id='statusRedirectIcon'>üîó</div>
                            <div class='status-content'>
                                <div class='status-label'>Redirection</div>
                                <div class='status-value'>
                                    <span class='status-badge' id='statusRedirectBadge'></span>
                                    <span id='statusRedirectText'>-</span>
                                </div>
                            </div>
                        </div>
                        <div class='status-item'>
                            <div class='status-icon' id='statusReviewsIcon'>üìä</div>
                            <div class='status-content'>
                                <div class='status-label'>Avis r√©colt√©s</div>
                                <div class='stat-visual'>
                                    <div class='stat-bar'>
                                        <div class='stat-bar-fill' id='statBarFill' style='width:0%'></div>
                                    </div>
                                    <span id='statCountMini'>0</span>
                                </div>
                            </div>
                        </div>
                        <div class='status-item' style='border-top:1px solid #e5e7eb; padding-top:12px; margin-top:8px;'>
                            <div class='status-icon' style='background:#fee2e2;'>üîÑ</div>
                            <div class='status-content' style='flex:1;'>
                                <div class='status-label'>R√©initialisation</div>
                                <div class='status-value'>
                                    <button id='resetBtn' style='padding:6px 12px; background:#ef4444; color:white; border:none; border-radius:6px; font-size:12px; font-weight:500; cursor:pointer; width:100%;'>
                                        R√©initialiser la plaque
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <p class='muted' style='margin-bottom:1rem;'>G√©rez votre configuration et vos r√©sultats.</p>
            <div class='cards-grid'>
                <div class='card'>
                    <h3>Note moyenne</h3>
                    <div class='stars-container' id='ratingContainer'>
                        <div class='stars' id='starsDisplay'></div>
                        <span class='rating-value' id='ratingValue'>‚Äì</span>
                    </div>
                    <p class='muted'>Note moyenne de votre √©tablissement sur Google.</p>
                </div>
                <div class='card'>
                    <h3>Nombre d'avis</h3>
                    <div class='review-count-large' id='totalReviewsCount'>‚Äì</div>
                    <p class='muted'>Total d'avis sur votre √©tablissement Google.</p>
                </div>
                <div class='card'>
                    <h3>Avis r√©colt√©s</h3>
                    <div class='big-count' id='statsCount'>‚Äì</div>
                    <p class='muted'>Total d'avis g√©n√©r√©s via votre plaque.</p>
                </div>
                <div class='card'>
                    <h3>Jeux</h3>
                    <p>Ajoutez un jeu pour encourager les clients √† laisser un avis.</p>
                    <div style='display:flex; align-items:center; gap:12px; margin:12px 0;'>
                        <div class='toggle-visual' id='cardGameToggle' style='opacity:0.5; pointer-events:none;'></div>
                        <span id='currentGameText' style='font-size:14px; color:#4b5563; flex:1; font-weight:600;'>Bient√¥t</span>
                    </div>
                    <div class='btn-row'>
                        <span style='color:#6b7280; font-size:0.875rem;'>Cette fonctionnalit√© sera disponible prochainement</span>
                    </div>
                </div>
                <div class='card'>
                    <h3>Votre √©tablissement</h3>
                    <iframe id='miniMap' class='mini-map' src='about:blank' loading='lazy' referrerpolicy='no-referrer-when-downgrade'></iframe>
                </div>
            </div>
            <div class='card' style='margin-top:1.5rem;'>
                <h3>Contacts</h3>
                <p>Consultez les contacts collect√©s via la plaque.</p>
                <div class='contacts-preview' id='contactsPreview'>
                    <table class='contacts-preview-table'>
                        <thead>
                            <tr>
                                <th>Nom</th>
                                <th>Pr√©nom</th>
                                <th>Email</th>
                                <th>Date</th>
                            </tr>
                        </thead>
                        <tbody id='contactsPreviewBody'>
                            <tr>
                                <td colspan='4' class='contacts-preview-empty'>Chargement...</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
                <div class='btn-row'>
                    <a id='contactsLink' class='btn-primary btn' href='/contacts.html?id=${encodeURIComponent(accountId)}'>Consulter les contacts</a>
                </div>
            </div>
        </div>
    `;

    // Wait for db-proxy.js to load before using it
    // Make it available globally for all functions
    window.waitForDbProxy = async function() {
        if (window.dbProxy) {
            return window.dbProxy;
        }
        let retries = 0;
        while (!window.dbProxy && retries < 50) {
            await new Promise(resolve => setTimeout(resolve, 100));
            retries++;
        }
        if (!window.dbProxy) {
            throw new Error('db-proxy.js failed to load after 5 seconds');
        }
        return window.dbProxy;
    };

    // Supabase: fetch account row to populate the cards
    try {
        // Init menu after DOM is ready
        setTimeout(() => initStatusMenu(), 0);
        
        // Wait for db-proxy to be available
        const dbProxy = await window.waitForDbProxy();
        
        dbProxy.select('accounts', { id: accountId }, { limit: 1, single: true })
            .then(({ data, error }) => {
                if (error) {
                    console.error('Database error', error);
                    return;
                }
                if (!data) return;
                updateStatusMenu(data);
                // Business name in title
                const name = data.business_name || data.company_name || data.company_nam || ('#' + accountId);
                const titleEl = document.getElementById('bizName');
                if (titleEl) titleEl.textContent = name;
                
                // Fetch rating and total reviews from Google Maps API using business_id (place_id)
                const placeId = data.business_id || data.place_id || null;
                if (placeId) {
                    // Fetch both rating and user_ratings_total from Google Maps API
                    fetchGooglePlaceDetails(placeId);
                } else {
                    // Fallback to Supabase data if no place_id
                    const rating = parseFloat(data.current_rating) || null;
                    updateRatingDisplay(rating);
                    const totalReviews = parseInt(data.tot_review || '0', 10) || null;
                    updateTotalReviewsDisplay(totalReviews);
                }
                
                // Stats (review_number)
                const statsEl = document.getElementById('statsCount');
                if (statsEl) statsEl.textContent = data.review_number || '0';
                // Load contacts preview
                loadContactsPreview();
                // Games card - Show "Bient√¥t" and disable toggle
                const cardGameToggle = document.getElementById('cardGameToggle');
                const currentGameText = document.getElementById('currentGameText');
                
                // Disable toggle and show "Bient√¥t"
                if (cardGameToggle) {
                    cardGameToggle.style.opacity = '0.5';
                    cardGameToggle.style.pointerEvents = 'none';
                    cardGameToggle.classList.remove('active');
                }
                
                if (currentGameText) {
                    currentGameText.textContent = 'Bient√¥t';
                    currentGameText.style.fontWeight = '600';
                }
                // Google Maps card (reuse placeId variable declared above)
                const mapFrame = document.getElementById('miniMap');
                if (placeId && mapFrame) {
                    // Use the Google Maps embed format to avoid X-Frame-Options issues
                    mapFrame.src = `https://www.google.com/maps?q=place_id:${encodeURIComponent(placeId)}&output=embed`;
                }
                
                // Setup reset button
                const resetBtn = document.getElementById('resetBtn');
                if (resetBtn) {
                    resetBtn.addEventListener('click', async function() {
                        if (!confirm('√ätes-vous s√ªr de vouloir r√©initialiser la plaque NFC aux valeurs d\'usine ? Cette action est irr√©versible et supprimera toutes les donn√©es configur√©es.')) {
                            return;
                        }
                        
                        if (!confirm('Confirmez-vous la r√©initialisation ? Toutes les donn√©es seront perdues.')) {
                            return;
                        }
                        
                        resetBtn.disabled = true;
                        resetBtn.textContent = 'R√©initialisation...';
                        
                        try {
                            const dbProxy = await window.waitForDbProxy();
                            
                            // Factory reset values
                            const factoryResetData = {
                                email: null,
                                first_name: null,
                                last_name: null,
                                company_name: null,
                                source_id: null,
                                redirection_url: null,
                                games: null,
                                wich_game: null,
                                review_number: null,
                                contact_table: JSON.stringify([{
                                    nom: 'go',
                                    prenom: 'Review',
                                    email: 'goreview.fr@gmail.com',
                                    time: '2025-11-02T15:28:44.088Z'
                                }]),
                                games_details: null,
                                business_id: null,
                                tot_review: null,
                                current_rating: null,
                                updated_at: new Date().toISOString()
                            };
                            
                            const { error } = await dbProxy.update('accounts', factoryResetData, { id: accountId });
                            
                            if (error) {
                                throw new Error(error.message || 'Erreur lors de la r√©initialisation');
                            }
                            
                            alert('Plaque NFC r√©initialis√©e avec succ√®s ! La page va √™tre recharg√©e.');
                            window.location.reload();
                        } catch (err) {
                            console.error('Reset failed:', err);
                            alert('Erreur lors de la r√©initialisation : ' + (err.message || err));
                            resetBtn.disabled = false;
                            resetBtn.textContent = 'üîÑ R√©initialiser';
                        }
                    });
                }
            });
    } catch (e) {
        console.error('Supabase init failed', e);
    }
})();
</script>
</body>
</html>

