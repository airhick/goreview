<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard - GoReview</title>
    <meta http-equiv="Content-Security-Policy" content="default-src 'self' http://localhost:*; connect-src 'self' http://localhost:* https://*.googleapis.com https://*.google.com https://maps.googleapis.com https://maps.gstatic.com https://vigutqmfosxbpncussie.supabase.co https://*.netlify.app https://*.netlify.com https://n8n.goreview.fr; img-src 'self' data: https: blob:; script-src 'self' 'unsafe-inline' 'unsafe-eval' https://accounts.google.com https://www.google.com https://*.google.com https://maps.googleapis.com https://cdn.jsdelivr.net; style-src 'self' 'unsafe-inline'; frame-src 'self' http://localhost:* https://www.google.com https://*.google.com https://maps.google.com;">
    <script>
      // Suppress ONLY MCP/BrowserAutomation and third-party extension errors, keep our errors visible
      (function(){
        const isMCPError = (msg) => {
          if (!msg) return false;
          const str = String(msg).toLowerCase();
          return str.includes('localhost:62462') || 
                 str.includes('browserautomation') || 
                 str.includes('registerwithmcp') || 
                 str.includes('pollforcommands') ||
                 str.includes('solanaactionscontentscript') ||
                 str.includes('chrome-extension://') ||
                 str.includes('moz-extension://') ||
                 (str.includes('vm') && str.includes('register-iframe'));
        };
        
        // Only suppress console errors that are MCP-related
        const originalError = console.error;
        console.error = function(...args) {
          const isMCP = args.some(arg => isMCPError(String(arg)));
          if (!isMCP) {
            originalError.apply(console, args);
          }
        };
        
        // Suppress fetch errors for dev tools only (allow Google Maps API calls)
        const originalFetch = window.fetch;
        window.fetch = function(...args) {
          const url = args[0] || '';
          if (url.includes && url.includes('localhost:62462')) {
            return Promise.reject(new Error('Blocked by filter')).catch(() => {});
          }
          return originalFetch.apply(this, args);
        };
        
        // Suppress XMLHttpRequest errors only for localhost:62462
        const originalOpen = XMLHttpRequest.prototype.open;
        XMLHttpRequest.prototype.open = function(method, url, ...rest) {
          if (url && url.includes('localhost:62462')) {
            this.addEventListener('error', () => {}, {once: true});
            this.addEventListener('loadend', () => {}, {once: true});
          }
          return originalOpen.apply(this, [method, url, ...rest]);
        };
      })();
    </script>
    <link rel="stylesheet" href="styles.css">
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script>
        // Force reload of db-proxy.js to avoid cache issues
        (function() {
            const script = document.createElement('script');
            script.src = `db-proxy.js?v=${Date.now()}`;
            script.async = false; // Load synchronously to ensure it's available
            document.head.appendChild(script);
        })();
    </script>
    <script>
        // Delete goreview_session cookie on page load
        (function() {
            const cookieName = 'goreview_session';
            const pastDate = 'Thu, 01 Jan 1970 00:00:00 UTC';
            const hostname = window.location.hostname;
            const hostnameParts = hostname.split('.');
            
            // Delete cookie with different paths and domains
            document.cookie = `${cookieName}=;expires=${pastDate};path=/;`;
            document.cookie = `${cookieName}=;expires=${pastDate};path=/;SameSite=Lax;`;
            document.cookie = `${cookieName}=;expires=${pastDate};path=/;SameSite=Strict;`;
            document.cookie = `${cookieName}=;expires=${pastDate};path=/;domain=${hostname};`;
            
            // Delete for parent domain if applicable
            if (hostnameParts.length > 1) {
                const parentDomain = '.' + hostnameParts.slice(-2).join('.');
                document.cookie = `${cookieName}=;expires=${pastDate};path=/;domain=${parentDomain};`;
                const parentDomainNoDot = hostnameParts.slice(-2).join('.');
                document.cookie = `${cookieName}=;expires=${pastDate};path=/;domain=${parentDomainNoDot};`;
            }
            
            console.log('âœ… goreview_session cookie deleted');
        })();
        
        // Function to get cookie value
        function getCookie(name) {
            const value = `; ${document.cookie}`;
            const parts = value.split(`; ${name}=`);
            if (parts.length === 2) {
                return decodeURIComponent(parts.pop().split(';').shift());
            }
            return null;
        }
        
        // Note: Cookie validation is now handled in the async function below
        // to allow time for cookie to be available after redirect
    </script>
    <style>
        .centered-card {
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            background: linear-gradient(135deg, #f9fafb 0%, #ffffff 100%);
        }
        .dashboard-wrap {
            background: #fff;
            border-radius: 18px;
            border: 1px solid #e5e7eb;
            box-shadow: 0 10px 25px -5px rgba(0,0,0,0.08);
            max-width: 1000px;
            width: 100%;
            padding: 2rem;
        }
        .dashboard-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 1rem;
            margin-bottom: 1.25rem;
        }
        .dash-brand {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .dash-logo {
            height: 32px;
            width: auto;
        }
        .dashboard-title {
            font-size: 1.5rem;
            margin: 0;
        }
        .cards-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
            gap: 1rem;
        }
        .stars-container {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            margin: 0.75rem 0;
        }
        .stars {
            display: flex;
            gap: 2px;
        }
        .star {
            font-size: 1.5rem;
            color: #d1d5db;
            line-height: 1;
        }
        .star.filled {
            color: #fbbf24;
        }
        .rating-value {
            font-size: 1.25rem;
            font-weight: 700;
            color: #111827;
        }
        .review-count-large {
            font-size: 2rem;
            font-weight: 700;
            color: #6366f1;
            margin: 0.75rem 0;
        }
        .card {
            border: 1px solid #e5e7eb;
            border-radius: 14px;
            padding: 1rem;
            background: #fff;
            display: flex;
            flex-direction: column;
            margin-bottom: 0;
        }
        .card h3 {
            margin: 0 0 0.35rem 0;
            font-size: 1.125rem;
        }
        .card p {
            color: #4b5563;
            margin: 0 0 0.75rem 0;
            font-size: 0.95rem;
        }
        .big-count { font-size: 2.25rem; font-weight: 800; color: #111827; }
        .card .btn-row {
            display: flex;
            gap: 0.5rem;
            flex-wrap: wrap;
            margin-top: auto;
        }
        .btn {
            display: inline-block;
            padding: 0.5rem 0.9rem;
            border-radius: 10px;
            border: 1px solid #e5e7eb;
            text-decoration: none;
            font-weight: 600;
            color: #111827;
            transition: background 0.15s;
        }
        .btn:hover { background: #f3f4f6; }
        .btn-primary { color: #fff; background: #6366f1; border-color: #6366f1; }
        .btn-primary:hover { background: #4f46e5; }
        .muted { color: #6b7280; font-size: 0.9rem; }
        .back-link { display: inline-block; margin-bottom: 2rem; text-decoration: none; color: #6366f1; }
        @media (max-width: 520px) { 
            .dashboard-title { font-size: 1.25rem; }
            .cards-grid {
                grid-template-columns: 1fr;
            }
            .card[style*="grid-column: span 2"] {
                grid-column: span 1 !important;
            }
        }
        .mini-map { width: 100%; height: 200px; border: 1px solid #e5e7eb; border-radius: 12px; }
        /* Contacts table preview */
        .contacts-preview {
            overflow-x: auto;
            margin: 1rem 0;
            border: 1px solid #e5e7eb;
            border-radius: 8px;
            max-height: 400px;
            overflow-y: auto;
        }
        .contacts-preview-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.875rem;
            min-width: 500px;
        }
        .contacts-preview-table thead {
            background: #f9fafb;
            position: sticky;
            top: 0;
            z-index: 1;
        }
        .contacts-preview-table th {
            padding: 0.75rem;
            text-align: left;
            font-weight: 600;
            color: #111827;
            border-bottom: 2px solid #e5e7eb;
            font-size: 0.875rem;
        }
        .contacts-preview-table td {
            padding: 0.75rem;
            border-bottom: 1px solid #f3f4f6;
            color: #4b5563;
        }
        .contacts-preview-table td.contact-actions {
            text-align: center;
            width: 60px;
        }
        .delete-contact-btn {
            background: none;
            border: none;
            color: #ef4444;
            font-size: 0.95rem;
            cursor: pointer;
            padding: 0.25rem;
            border-radius: 6px;
            transition: background 0.2s, color 0.2s;
        }
        .delete-contact-btn:hover {
            background: rgba(239, 68, 68, 0.1);
            color: #b91c1c;
        }
        .contacts-preview-table tbody tr:hover {
            background: #f9fafb;
        }
        .contacts-preview-empty {
            padding: 2rem;
            text-align: center;
            color: #6b7280;
            font-size: 0.875rem;
        }
        /* Account Info Grid */
        .account-info-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 1rem;
            margin-top: 1rem;
        }
        .info-item {
            display: flex;
            flex-direction: column;
            gap: 0.25rem;
            padding: 0.75rem;
            background: #f9fafb;
            border-radius: 8px;
            border: 1px solid #e5e7eb;
        }
        .info-item.full-width {
            grid-column: 1 / -1;
        }
        .info-label {
            font-size: 0.75rem;
            font-weight: 600;
            color: #6b7280;
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }
        .info-value {
            font-size: 0.95rem;
            color: #111827;
            font-weight: 500;
            word-break: break-word;
        }
        .info-value a {
            color: #6366f1;
            text-decoration: none;
        }
        .info-value a:hover {
            text-decoration: underline;
        }
        @media (max-width: 640px) {
            .account-info-grid {
                grid-template-columns: 1fr;
            }
        }
        /* Status Menu */
        .status-menu {
            position: relative;
        }
        .status-menu-btn {
            width: 44px;
            height: 44px;
            border: 1px solid #e5e7eb;
            border-radius: 10px;
            background: #fff;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.2s;
            font-size: 18px;
        }
        .status-menu-btn:hover {
            background: #f9fafb;
            border-color: #d1d5db;
        }
        .status-menu-panel {
            position: absolute;
            top: calc(100% + 8px);
            right: 0;
            width: 280px;
            background: #fff;
            border: 1px solid #e5e7eb;
            border-radius: 12px;
            box-shadow: 0 10px 25px -5px rgba(0,0,0,0.15);
            padding: 16px;
            display: none;
            z-index: 100;
        }
        .status-menu-panel.open {
            display: block;
        }
        .status-item {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px;
            border-radius: 8px;
            margin-bottom: 8px;
            transition: background 0.15s;
        }
        .status-item:last-child {
            margin-bottom: 0;
        }
        .status-item:hover {
            background: #f9fafb;
        }
        .status-icon {
            width: 36px;
            height: 36px;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 18px;
            flex-shrink: 0;
        }
        .status-icon.healthy { background: #d1fae5; }
        .status-icon.warning { background: #fef3c7; }
        .status-icon.error { background: #fee2e2; }
        .status-content {
            flex: 1;
            min-width: 0;
        }
        .status-label {
            font-size: 12px;
            color: #6b7280;
            margin-bottom: 4px;
        }
        .status-value {
            font-size: 14px;
            font-weight: 600;
            color: #111827;
            display: flex;
            align-items: center;
            gap: 6px;
        }
        .status-badge {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            flex-shrink: 0;
        }
        .status-badge.green { background: #10b981; }
        .status-badge.orange { background: #f59e0b; }
        .status-badge.red { background: #ef4444; }
        .toggle-visual {
            width: 48px;
            height: 28px;
            border-radius: 9999px;
            background: #e5e7eb;
            position: relative;
            cursor: pointer;
            transition: background 0.2s;
            flex-shrink: 0;
        }
        .toggle-visual.active {
            background: #6366f1;
        }
        .toggle-visual::after {
            content: '';
            position: absolute;
            width: 22px;
            height: 22px;
            border-radius: 50%;
            background: #fff;
            top: 3px;
            left: 3px;
            transition: transform 0.2s;
            box-shadow: 0 1px 3px rgba(0,0,0,0.2);
        }
        .toggle-visual.active::after {
            transform: translateX(20px);
        }
        .stat-visual {
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .stat-bar {
            flex: 1;
            height: 6px;
            background: #e5e7eb;
            border-radius: 9999px;
            overflow: hidden;
        }
        .stat-bar-fill {
            height: 100%;
            background: #6366f1;
            border-radius: 9999px;
            transition: width 0.3s;
        }
        @media (max-width: 640px) {
            .status-menu-panel {
                right: -8px;
                width: calc(100vw - 32px);
                max-width: 280px;
            }
            .status-menu-btn {
                width: 40px;
                height: 40px;
            }
        }
        /* Factory Reset Popup */
        .reset-popup-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            z-index: 10000;
            align-items: center;
            justify-content: center;
            padding: 1rem;
        }
        .reset-popup-overlay.show {
            display: flex;
        }
        .reset-popup {
            background: #fff;
            border-radius: 12px;
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
            max-width: 480px;
            width: 100%;
            padding: 0;
            overflow: hidden;
        }
        .reset-popup-header {
            background: #fee2e2;
            padding: 1.25rem;
            border-bottom: 1px solid #fecaca;
        }
        .reset-popup-header h3 {
            margin: 0;
            font-size: 1.25rem;
            font-weight: 600;
            color: #991b1b;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        .reset-popup-body {
            padding: 1.5rem;
        }
        .reset-popup-disclaimer {
            background: #fef2f2;
            border: 1px solid #fecaca;
            border-radius: 8px;
            padding: 1rem;
            margin-bottom: 1.5rem;
        }
        .reset-popup-disclaimer h4 {
            margin: 0 0 0.75rem 0;
            font-size: 0.875rem;
            font-weight: 600;
            color: #991b1b;
        }
        .reset-popup-disclaimer ul {
            margin: 0;
            padding-left: 1.25rem;
            color: #7f1d1d;
            font-size: 0.875rem;
            line-height: 1.6;
        }
        .reset-popup-disclaimer li {
            margin-bottom: 0.5rem;
        }
        .reset-popup-disclaimer li:last-child {
            margin-bottom: 0;
        }
        .reset-popup-warning {
            background: #fef3c7;
            border-left: 4px solid #f59e0b;
            padding: 0.75rem 1rem;
            margin-bottom: 1.5rem;
            border-radius: 4px;
        }
        .reset-popup-warning p {
            margin: 0;
            color: #92400e;
            font-size: 0.875rem;
            font-weight: 500;
        }
        .reset-popup-actions {
            display: flex;
            gap: 0.75rem;
            justify-content: flex-end;
        }
        .reset-popup-btn {
            padding: 0.625rem 1.25rem;
            border-radius: 8px;
            font-size: 0.875rem;
            font-weight: 500;
            cursor: pointer;
            border: none;
            transition: all 0.2s;
        }
        .reset-popup-btn-cancel {
            background: #f3f4f6;
            color: #374151;
        }
        .reset-popup-btn-cancel:hover {
            background: #e5e7eb;
        }
        .reset-popup-btn-continue {
            background: #ef4444;
            color: white;
        }
        .reset-popup-btn-continue:hover {
            background: #dc2626;
        }
        .reset-popup-btn-continue:disabled {
            background: #fca5a5;
            cursor: not-allowed;
        }
    </style>
</head>
<body>
<div class="centered-card" id="main">
    <div style="text-align: center; padding: 3rem;">
        <div style="font-size: 2rem; margin-bottom: 1rem;">â³</div>
        <div style="font-size: 1.25rem; font-weight: 600; color: #6366f1; margin-bottom: 0.5rem;">Chargement du dashboard...</div>
        <div id="loadingStatus" style="font-size: 0.9rem; color: #6b7280;">VÃ©rification de la session...</div>
    </div>
</div>

<!-- Factory Reset Popup -->
<div class="reset-popup-overlay" id="resetPopupOverlay">
    <div class="reset-popup">
        <div class="reset-popup-header">
            <h3>âš ï¸ RÃ©initialisation de la plaque NFC</h3>
        </div>
        <div class="reset-popup-body">
            <div class="reset-popup-disclaimer">
                <h4>Cette action est irrÃ©versible et supprimera :</h4>
                <ul>
                    <li>Toutes les donnÃ©es de configuration</li>
                    <li>Les informations de l'Ã©tablissement</li>
                    <li>L'identifiant Google Maps (Place ID)</li>
                    <li>L'URL de redirection</li>
                    <li>Les statistiques et avis rÃ©coltÃ©s</li>
                    <li>Votre session de connexion</li>
                </ul>
            </div>
            <div class="reset-popup-warning">
                <p><strong>Attention :</strong> La plaque sera remise aux valeurs d'usine. Vous devrez reconfigurer tous les paramÃ¨tres.</p>
            </div>
            <div class="reset-popup-actions">
                <button class="reset-popup-btn reset-popup-btn-cancel" id="resetPopupCancel">Annuler</button>
                <button class="reset-popup-btn reset-popup-btn-continue" id="resetPopupContinue">Continuer</button>
            </div>
        </div>
    </div>
</div>
<script>
(async function() {
    // Get account ID from cookie (required) or URL
    const mount = document.getElementById('main');
    const params = new URLSearchParams(window.location.search);
    const idFromUrl = params.get('id');
    
    // Function to get cookie value
    function getCookie(name) {
        const value = `; ${document.cookie}`;
        const parts = value.split(`; ${name}=`);
        if (parts.length === 2) {
            return decodeURIComponent(parts.pop().split(';').shift());
        }
        return null;
    }
    
    // Prevent infinite redirect loop - check if we've been here multiple times
    const redirectCount = parseInt(window.sessionStorage.getItem('dashboard_load_count') || '0', 10);
    if (redirectCount > 3) {
        console.error('âŒ Redirect loop detected (loaded ' + redirectCount + ' times), clearing session and redirecting to login');
        window.sessionStorage.removeItem('dashboard_load_count');
        window.sessionStorage.removeItem('dashboard_redirect_in_progress');
        // Clear cookie to force re-login
        document.cookie = 'dashboard_sesh=; expires=Thu, 01 Jan 1970 00:00:00 UTC; path=/;';
        // Redirect with error parameter to show message and prevent auto-redirect
        window.location.replace('/dashboardlogin.html?error=auth_failed');
        return;
    }
    
    // Increment load counter
    window.sessionStorage.setItem('dashboard_load_count', String(redirectCount + 1));
    console.log('ğŸ“Š Dashboard load count:', redirectCount + 1);
    
    // Update loading status
    const loadingStatusEl = document.getElementById('loadingStatus');
    if (loadingStatusEl) loadingStatusEl.textContent = 'Recherche du cookie de session...';
    
    // Get ID from cookie (required) - with retry mechanism for cookie availability
    let accountId = null;
    let cookieRetries = 0;
    const maxCookieRetries = 20; // Wait up to 2 seconds for cookie
    
    console.log('â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•');
    console.log('ğŸš€ DASHBOARD PAGE LOADED');
    console.log('â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•');
    console.log('ğŸ“ Current URL:', window.location.href);
    console.log('ğŸ” ID from URL parameter:', idFromUrl);
    console.log('ğŸª ALL COOKIES:', document.cookie);
    console.log('ğŸª Cookie count:', document.cookie ? document.cookie.split(';').length : 0);
    console.log('ğŸ” Looking for: dashboard_sesh');
    console.log('ğŸ” Cookie contains dashboard_sesh:', document.cookie.includes('dashboard_sesh'));
    console.log('â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•');
    
    while (!accountId && cookieRetries < maxCookieRetries) {
        try {
            const cookieValue = getCookie('dashboard_sesh');
            if (cookieValue) {
                console.log('ğŸ“¦ Raw cookie value found (attempt ' + (cookieRetries + 1) + ')');
                const cookieData = JSON.parse(cookieValue);
                if (cookieData && cookieData.id) {
                    accountId = cookieData.id;
                    window.currentAccountEmail = cookieData.email; // Store for later use
                    console.log('âœ… dashboard_sesh cookie found with ID:', accountId);
                    console.log('ğŸ“§ Email from cookie:', cookieData.email);
                    break;
                }
            } else {
                if (cookieRetries === 0 || cookieRetries % 5 === 0) {
                    console.log('â³ Cookie not found yet (attempt ' + (cookieRetries + 1) + '/' + maxCookieRetries + ')');
                }
            }
        } catch (e) {
            console.warn('âš ï¸ Error parsing dashboard_sesh cookie (attempt ' + (cookieRetries + 1) + '):', e);
        }
        
        if (!accountId) {
            cookieRetries++;
            if (cookieRetries < maxCookieRetries) {
                await new Promise(resolve => setTimeout(resolve, 100));
            }
        }
    }
    
    // If no cookie after retries, redirect to login with error message
    if (!accountId) {
        console.log('â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•');
        console.log('âŒ AUTHENTICATION FAILED - NO COOKIE FOUND');
        console.log('â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•');
        console.log('Retries attempted:', maxCookieRetries);
        console.log('Final cookie check:', getCookie('dashboard_sesh'));
        console.log('All cookies:', document.cookie);
        console.log('Reason: dashboard_sesh cookie not found after multiple attempts');
        console.log('Action: Redirecting to login page with error');
        console.log('â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•');
        
        if (loadingStatusEl) {
            loadingStatusEl.innerHTML = 'âŒ Session introuvable<br><small style="font-size:0.8em;">Redirection vers la page de connexion...</small>';
            loadingStatusEl.style.color = '#ef4444';
        }
        
        // Clear session storage to prevent loops
        window.sessionStorage.removeItem('dashboard_redirect_in_progress');
        window.sessionStorage.removeItem('dashboard_load_count');
        
        // Redirect to login with error parameter (prevents auto-redirect loop)
        await new Promise(resolve => setTimeout(resolve, 1000));
        window.location.replace('/dashboardlogin.html?error=session_expired');
        return; // Stop execution
    }
    
    console.log('âœ… Cookie authentication successful!');
    if (loadingStatusEl) loadingStatusEl.textContent = 'âœ… Session trouvÃ©e - Validation en cours...';
    
    // Normalize IDs to strings for comparison (URL params are always strings)
    const accountIdStr = String(accountId);
    const idFromUrlStr = idFromUrl ? String(idFromUrl) : null;
    
    console.log('ğŸ” Normalized comparison:');
    console.log('   Cookie ID (string):', accountIdStr, '(type:', typeof accountIdStr + ')');
    console.log('   URL ID (string):', idFromUrlStr, '(type:', typeof idFromUrlStr + ')');
    
    // If ID in URL, verify it matches cookie (using string comparison)
    if (idFromUrlStr && idFromUrlStr !== accountIdStr) {
        console.log('â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•');
        console.log('âŒ AUTHENTICATION FAILED - ID MISMATCH');
        console.log('â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•');
        console.log('URL ID:', idFromUrlStr);
        console.log('Cookie ID:', accountIdStr);
        console.log('Reason: ID in URL does not match ID in cookie');
        console.log('Action: Redirecting to login page with error');
        console.log('â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•');
        
        if (loadingStatusEl) {
            loadingStatusEl.textContent = 'âŒ Erreur d\'authentification - Redirection...';
            loadingStatusEl.style.color = '#ef4444';
        }
        
        // Clear session storage to prevent loops
        window.sessionStorage.removeItem('dashboard_redirect_in_progress');
        window.sessionStorage.removeItem('dashboard_load_count');
        
        // Redirect to login with error parameter (prevents auto-redirect loop)
        await new Promise(resolve => setTimeout(resolve, 1000));
        window.location.replace('/dashboardlogin.html?error=invalid_session');
        return; // Stop execution
    }
    
    // Use cookie ID (it's the source of truth)
    // Update URL to show ID (optional, for bookmarking)
    if (!idFromUrlStr || idFromUrlStr !== accountIdStr) {
        console.log('â„¹ï¸ Updating URL to match cookie ID:', accountIdStr);
        const newUrl = `/dashboard.html?id=${encodeURIComponent(accountIdStr)}`;
        window.history.replaceState(null, '', newUrl);
    }
    
    // Ensure accountId is in its original format for database queries
    console.log('âœ… Using account ID:', accountId, '(original type preserved)');
    
    // Clear redirect protection flags since we're successfully loading with valid credentials
    window.sessionStorage.removeItem('dashboard_redirect_in_progress');
    window.sessionStorage.removeItem('dashboard_load_count');
    
    console.log('â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•');
    console.log('âœ… AUTHENTICATION SUCCESSFUL');
    console.log('â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•');
    console.log('Account ID:', accountId);
    console.log('Email:', window.currentAccountEmail || 'Unknown');
    console.log('Session validated successfully');
    console.log('â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•');
    
    if (loadingStatusEl) {
        loadingStatusEl.textContent = 'âœ… Authentification rÃ©ussie - Chargement des donnÃ©es...';
        loadingStatusEl.style.color = '#10b981';
    }
    
    // Make accountId globally accessible for debugging
    window.currentAccountId = accountId;

    // Status menu toggle
    function initStatusMenu() {
        const btn = document.getElementById('statusMenuBtn');
        const panel = document.getElementById('statusMenuPanel');
        if (!btn || !panel) return;
        
        btn.addEventListener('click', (e) => {
            e.stopPropagation();
            panel.classList.toggle('open');
        });
        
        document.addEventListener('click', (e) => {
            if (!panel.contains(e.target) && !btn.contains(e.target)) {
                panel.classList.remove('open');
            }
        });
    }

    function updateReviewStatsFromContacts(count) {
        const safeCount = Math.max(Number(count) || 0, 0);
        const statsEl = document.getElementById('statsCount');
        const countMini = document.getElementById('statCountMini');
        const barFill = document.getElementById('statBarFill');
        
        if (statsEl) statsEl.textContent = safeCount.toString();
        if (countMini) countMini.textContent = safeCount.toString();
        if (barFill) {
            const maxScale = 50;
            const percentage = Math.min((safeCount / maxScale) * 100, 100);
            barFill.style.width = percentage + '%';
        }
    }
    let previewContacts = [];
    const DEFAULT_CONTACT_EMAIL = 'goreview.fr@gmail.com';
    function escapeHtml(value) {
        if (typeof value !== 'string') return value || '';
        return value
            .replace(/&/g, '&amp;')
            .replace(/</g, '&lt;')
            .replace(/>/g, '&gt;')
            .replace(/"/g, '&quot;')
            .replace(/'/g, '&#39;');
    }
    function isDefaultPreviewContact(contact) {
        if (!contact || !contact.email) return false;
        return contact.email.toLowerCase() === DEFAULT_CONTACT_EMAIL;
    }

    // Load contacts preview from contact_table column
    async function loadContactsPreview() {
        const tbody = document.getElementById('contactsPreviewBody');
        if (!tbody) return;

        try {
            // Use accountId from global scope or window
            const currentAccountId = accountId || window.currentAccountId;
            console.log('ğŸ“‹ loadContactsPreview - Account ID:', currentAccountId);
            
            if (!currentAccountId) {
                console.error('âŒ No account ID available in loadContactsPreview');
                return;
            }
            
            // Wait for db-proxy to be available
            const dbProxy = await window.waitForDbProxy();
            
            // First, get the account data to retrieve contact_table
            const { data: accountData, error: fetchError } = await dbProxy.select('accounts', { id: currentAccountId }, { select: ['contact_table'], single: true });

            if (fetchError) {
                tbody.innerHTML = `<tr><td colspan='5' class='contacts-preview-empty'>Erreur: ${fetchError.message}</td></tr>`;
                return;
            }

            // Parse contact_table (should be a JSON string or already an array)
            let contacts = [];
            if (accountData && accountData.contact_table) {
                try {
                    contacts = typeof accountData.contact_table === 'string' 
                        ? JSON.parse(accountData.contact_table) 
                        : accountData.contact_table;
                    if (!Array.isArray(contacts)) {
                        contacts = [];
                    }
                } catch (parseError) {
                    console.warn('Failed to parse contact_table', parseError);
                    contacts = [];
                }
            }

            // If no contacts and contact_table is empty/null, initialize with example contact
            if (contacts.length === 0) {
                const exampleContact = {
                    nom: 'go',
                    prenom: 'Review',
                    email: 'goreview.fr@gmail.com',
                    time: new Date().toISOString()
                };
                contacts = [exampleContact];
                
                // Save the example contact to contact_table
                try {
                    const dbProxy = await window.waitForDbProxy();
                    await dbProxy.update('accounts', { contact_table: JSON.stringify(contacts) }, { id: accountId });
                } catch (updateError) {
                    console.warn('Failed to initialize contact_table', updateError);
                }
            } else {
                // Normalize date fields - convert 'timestamp' to 'time' for consistency
                contacts = contacts.map(c => {
                    if (c.timestamp && !c.time) {
                        c.time = c.timestamp;
                        delete c.timestamp;
                    }
                    return c;
                });
                
                // Save normalized contacts back to database
                    try {
                        const dbProxy = await window.waitForDbProxy();
                    await dbProxy.update('accounts', { contact_table: JSON.stringify(contacts) }, { id: accountId });
                    } catch (updateError) {
                        console.warn('Failed to save normalized contacts', updateError);
                    }
                
                // Check if the example contact exists, if not add it
                const hasExample = contacts.some(c => 
                    c.email === 'goreview.fr@gmail.com' || 
                    (c.nom === 'go' && c.prenom === 'Review')
                );
                
                if (!hasExample) {
                    const exampleContact = {
                        nom: 'go',
                        prenom: 'Review',
                        email: 'goreview.fr@gmail.com',
                        time: new Date().toISOString()
                    };
                    contacts.unshift(exampleContact); // Add at the beginning
                    
                    // Save updated contacts
                    try {
                        const dbProxy = await window.waitForDbProxy();
                        await dbProxy.update('accounts', { contact_table: JSON.stringify(contacts) }, { id: accountId });
                    } catch (updateError) {
                        console.warn('Failed to update contact_table with example', updateError);
                    }
                }
            }

            // Sort by time (most recent first) - handle both 'time' and 'timestamp' fields
            contacts.sort((a, b) => {
                const timeA = (a.time || a.timestamp) ? new Date(a.time || a.timestamp).getTime() : 0;
                const timeB = (b.time || b.timestamp) ? new Date(b.time || b.timestamp).getTime() : 0;
                return timeB - timeA;
            });

            previewContacts = contacts;
            const effectiveContactCount = Math.max(previewContacts.length - 1, 0);
            updateReviewStatsFromContacts(effectiveContactCount);
            renderContactsPreviewTable();
        } catch (err) {
            tbody.innerHTML = `<tr><td colspan='5' class='contacts-preview-empty'>Erreur de chargement</td></tr>`;
            console.error('Failed to load contacts', err);
        }
    }

    function renderContactsPreviewTable() {
        const tbody = document.getElementById('contactsPreviewBody');
        if (!tbody) return;
        if (!previewContacts.length) {
            tbody.innerHTML = `<tr><td colspan='5' class='contacts-preview-empty'>Aucun contact enregistrÃ©</td></tr>`;
            return;
        }
        const displayContacts = previewContacts.map((contact, index) => ({ contact, index })).slice(0, 10);
        tbody.innerHTML = displayContacts.map(({ contact, index }) => {
            const nom = escapeHtml(contact.nom || 'â€“');
            const prenom = escapeHtml(contact.prenom || 'â€“');
            const email = escapeHtml(contact.email || 'â€“');
            const dateValue = contact.time || contact.timestamp;
            let date = '-';
            if (dateValue) {
                try {
                    const dateObj = new Date(dateValue);
                    if (!isNaN(dateObj.getTime())) {
                        date = dateObj.toLocaleDateString('fr-FR', {
                            year: 'numeric',
                            month: '2-digit',
                            day: '2-digit',
                            hour: '2-digit',
                            minute: '2-digit'
                        });
                    }
                } catch (e) {
                    console.warn('Failed to parse date:', dateValue, e);
                    date = '-';
                }
            }
            const isDefault = isDefaultPreviewContact(contact);
            const actionButton = isDefault
                ? `<button class="delete-contact-btn" title="Contact systÃ¨me" disabled>ğŸ”’</button>`
                : `<button class="delete-contact-btn" data-index="${index}" title="Supprimer ce contact">ğŸ—‘ï¸</button>`;
            return `
                <tr>
                    <td>${nom}</td>
                    <td>${prenom}</td>
                    <td><a href="mailto:${email}" style="color: #6366f1; text-decoration: none;">${email}</a></td>
                    <td>${date}</td>
                    <td class="contact-actions">
                        ${actionButton}
                    </td>
                </tr>
            `;
        }).join('');
    }

    async function handleDeletePreviewContact(index) {
        if (index < 0 || index >= previewContacts.length) return;
        const contact = previewContacts[index];
        if (isDefaultPreviewContact(contact)) {
            alert('Ce contact systÃ¨me ne peut pas Ãªtre supprimÃ©.');
            return;
        }
        const label = `${contact?.prenom || ''} ${contact?.nom || ''}`.trim() || contact?.email || 'ce contact';
        const confirmed = window.confirm(`Supprimer ${label} ? Cette action est dÃ©finitive.`);
        if (!confirmed) return;
        try {
            previewContacts.splice(index, 1);
            const dbProxy = await window.waitForDbProxy();
            await dbProxy.update('accounts', { contact_table: JSON.stringify(previewContacts) }, { id: accountId });
            const effectiveContactCount = Math.max(previewContacts.length - 1, 0);
            updateReviewStatsFromContacts(effectiveContactCount);
            renderContactsPreviewTable();
        } catch (error) {
            console.error('Failed to delete contact', error);
            alert('Impossible de supprimer ce contact. Veuillez rÃ©essayer.');
        }
    }

    // Fetch rating and total reviews from Google Places API
    async function fetchGooglePlaceDetails(placeId) {
        if (!placeId) {
            console.log('ğŸ“Š No place_id provided, showing empty state');
            updateRatingDisplay(null);
            updateTotalReviewsDisplay(null);
            return;
        }
        
        console.log('ğŸ“Š Fetching Google Places details for place_id:', placeId);
        
        try {
            // Use the local server proxy endpoint to avoid CORS issues
            const isLocalhost = window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1';
            const apiUrl = isLocalhost 
                ? `/api/google-place-details?place_id=${encodeURIComponent(placeId)}`
                : `https://maps.googleapis.com/maps/api/place/details/json?place_id=${encodeURIComponent(placeId)}&fields=rating,user_ratings_total&key=AIzaSyC1zqymSXocGXuCEVvpzXERWYwIzimV0Oo`;
            
            const response = await fetch(apiUrl);
            
            if (!response.ok) {
                throw new Error(`HTTP ${response.status}: ${response.statusText}`);
            }
            
            const data = await response.json();
            
            if (data.status === 'OK' && data.result) {
                const rating = data.result.rating || null;
                const totalReviews = data.result.user_ratings_total || null;
                
                console.log('âœ… Google Places data received:', { rating, totalReviews });
                
                updateRatingDisplay(rating);
                updateTotalReviewsDisplay(totalReviews);
            } else {
                console.warn('âš ï¸ Google Places API returned non-OK status:', data.status, data.error_message);
                // Show empty state if API returns error
                updateRatingDisplay(null);
                updateTotalReviewsDisplay(null);
            }
        } catch (error) {
            console.error('âŒ Error fetching Google Places details:', error);
            // Show empty state on error
            updateRatingDisplay(null);
            updateTotalReviewsDisplay(null);
        }
    }

    // Update rating display
    function updateRatingDisplay(rating) {
        const starsDisplay = document.getElementById('starsDisplay');
        const ratingValue = document.getElementById('ratingValue');
        
        if (starsDisplay) {
            starsDisplay.innerHTML = '';
            if (rating && rating > 0) {
                for (let i = 1; i <= 5; i++) {
                    const star = document.createElement('span');
                    const isFilled = rating >= i;
                    star.className = 'star' + (isFilled ? ' filled' : '');
                    star.textContent = 'â˜…';
                    starsDisplay.appendChild(star);
                }
            } else {
                // Show empty stars if no rating
                for (let i = 1; i <= 5; i++) {
                    const star = document.createElement('span');
                    star.className = 'star';
                    star.textContent = 'â˜…';
                    starsDisplay.appendChild(star);
                }
            }
        }
        
        if (ratingValue) {
            ratingValue.textContent = rating && rating > 0 ? rating.toFixed(1) : 'â€“';
        }
    }

    // Update total reviews display
    function updateTotalReviewsDisplay(totalReviews) {
        const totalReviewsEl = document.getElementById('totalReviewsCount');
        if (totalReviewsEl) {
            totalReviewsEl.textContent = totalReviews && totalReviews > 0 ? totalReviews.toLocaleString('fr-FR') : 'â€“';
        }
    }

    // Update status indicators
    function updateStatusMenu(data) {
        if (!data) return;
        
        // Game toggle - Disabled, show "BientÃ´t"
        const gameToggle = document.getElementById('statusGameToggle');
        const gameIcon = document.getElementById('statusGameIcon');
        if (gameToggle) {
            // Disable toggle
            gameToggle.style.opacity = '0.5';
            gameToggle.style.pointerEvents = 'none';
            gameToggle.classList.remove('active');
            // Remove any existing listeners by cloning
            const oldToggle = gameToggle;
            const newToggle = oldToggle.cloneNode(true);
            newToggle.style.opacity = '0.5';
            newToggle.style.pointerEvents = 'none';
            oldToggle.parentNode.replaceChild(newToggle, oldToggle);
        }
        if (gameIcon) {
            gameIcon.className = 'status-icon';
        }

        // Health check
        const healthIssues = [];
        if (!data.business_id && !data.place_id) healthIssues.push('Place ID manquant');
        if (!data.redirection_url) healthIssues.push('Redirection non configurÃ©e');
        
        const healthIcon = document.getElementById('statusHealthIcon');
        const healthBadge = document.getElementById('statusHealthBadge');
        const healthText = document.getElementById('statusHealthText');
        
        if (healthIssues.length === 0) {
            if (healthIcon) { healthIcon.className = 'status-icon healthy'; healthIcon.textContent = 'âœ“'; }
            if (healthBadge) { healthBadge.className = 'status-badge green'; }
            if (healthText) healthText.textContent = 'OpÃ©rationnel';
        } else {
            if (healthIcon) { healthIcon.className = 'status-icon error'; healthIcon.textContent = 'âš '; }
            if (healthBadge) { healthBadge.className = 'status-badge red'; }
            if (healthText) healthText.textContent = healthIssues[0];
        }

        // Redirection
        const redirectBadge = document.getElementById('statusRedirectBadge');
        const redirectText = document.getElementById('statusRedirectText');
        const redirectIcon = document.getElementById('statusRedirectIcon');
        const hasRedirect = !!data.redirection_url;
        if (redirectBadge) redirectBadge.className = `status-badge ${hasRedirect ? 'green' : 'orange'}`;
        if (redirectText) redirectText.textContent = hasRedirect ? 'ConfigurÃ©' : 'Non configurÃ©';
        if (redirectIcon) redirectIcon.className = `status-icon ${hasRedirect ? 'healthy' : 'warning'}`;

        // Database (always healthy if we got data)
        const dbIcon = document.getElementById('statusDbIcon');
        if (dbIcon) dbIcon.className = 'status-icon healthy';

        // Reviews bar (visual scale: 0-50 for better visibility)
        const reviewCount = parseInt(data.review_number || '0', 10);
        const barFill = document.getElementById('statBarFill');
        const countMini = document.getElementById('statCountMini');
        if (barFill) {
            const maxScale = 50;
            const percentage = Math.min((reviewCount / maxScale) * 100, 100);
            barFill.style.width = percentage + '%';
        }
        if (countMini) countMini.textContent = reviewCount;
    }

    mount.innerHTML = `
        <div class='dashboard-wrap'>
            <div class='dashboard-header'>
                <div class='dash-brand'>
                    <img src='logo.png' alt='GoReview' class='dash-logo'>
                    <h1 class='dashboard-title'>Dashboard GoReview <span id='bizName' style='color:#6366f1'>#${accountId}</span></h1>
                </div>
                <div class='status-menu'>
                    <button class='status-menu-btn' id='statusMenuBtn' title='Statut systÃ¨me'>âš™ï¸</button>
                    <div class='status-menu-panel' id='statusMenuPanel'>
                        <div class='status-item'>
                            <div class='status-icon healthy' id='statusHealthIcon'>âœ“</div>
                            <div class='status-content'>
                                <div class='status-label'>SystÃ¨me</div>
                                <div class='status-value'>
                                    <span class='status-badge green' id='statusHealthBadge'></span>
                                    <span id='statusHealthText'>OpÃ©rationnel</span>
                                </div>
                            </div>
                        </div>
                        <div class='status-item'>
                            <div class='status-icon' id='statusGameIcon'>ğŸ®</div>
                            <div class='status-content'>
                                <div class='status-label'>Jeu</div>
                                <div class='status-value'>
                                    <div class='toggle-visual' id='statusGameToggle'></div>
                                </div>
                            </div>
                        </div>
                        <div class='status-item'>
                            <div class='status-icon' id='statusDbIcon'>ğŸ—„ï¸</div>
                            <div class='status-content'>
                                <div class='status-label'>Base de donnÃ©es</div>
                                <div class='status-value'>
                                    <span class='status-badge green' id='statusDbBadge'></span>
                                    <span>ConnectÃ©</span>
                                </div>
                            </div>
                        </div>
                        <div class='status-item'>
                            <div class='status-icon' id='statusRedirectIcon'>ğŸ”—</div>
                            <div class='status-content'>
                                <div class='status-label'>Redirection</div>
                                <div class='status-value'>
                                    <span class='status-badge' id='statusRedirectBadge'></span>
                                    <span id='statusRedirectText'>-</span>
                                </div>
                            </div>
                        </div>
                        <div class='status-item'>
                            <div class='status-icon' id='statusReviewsIcon'>ğŸ“Š</div>
                            <div class='status-content'>
                                <div class='status-label'>Avis rÃ©coltÃ©s</div>
                                <div class='stat-visual'>
                                    <div class='stat-bar'>
                                        <div class='stat-bar-fill' id='statBarFill' style='width:0%'></div>
                                    </div>
                                    <span id='statCountMini'>0</span>
                                </div>
                            </div>
                        </div>
                        <div class='status-item' style='border-top:1px solid #e5e7eb; padding-top:12px; margin-top:8px;'>
                            <div class='status-icon' style='background:#fee2e2;'>ğŸ”„</div>
                            <div class='status-content' style='flex:1;'>
                                <div class='status-label'>RÃ©initialisation</div>
                                <div class='status-value'>
                                    <button id='resetBtn' style='padding:6px 12px; background:#ef4444; color:white; border:none; border-radius:6px; font-size:12px; font-weight:500; cursor:pointer; width:100%;'>
                                        RÃ©initialiser la plaque
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <p class='muted' style='margin-bottom:1rem;'>GÃ©rez votre configuration et vos rÃ©sultats.</p>
            <div class='cards-grid'>
                <div class='card'>
                    <h3>Note moyenne</h3>
                    <div class='stars-container' id='ratingContainer'>
                        <div class='stars' id='starsDisplay'></div>
                        <span class='rating-value' id='ratingValue'>â€“</span>
                    </div>
                    <p class='muted'>Note moyenne de votre Ã©tablissement sur Google.</p>
                </div>
                <div class='card'>
                    <h3>Nombre d'avis</h3>
                    <div class='review-count-large' id='totalReviewsCount'>â€“</div>
                    <p class='muted'>Total d'avis sur votre Ã©tablissement Google.</p>
                </div>
                <div class='card'>
                    <h3>Avis rÃ©coltÃ©s</h3>
                    <div class='big-count' id='statsCount'>â€“</div>
                    <p class='muted'>Total d'avis gÃ©nÃ©rÃ©s via votre plaque.</p>
                </div>
                <div class='card'>
                    <h3>Jeux</h3>
                    <p>Ajoutez un jeu pour encourager les clients Ã  laisser un avis.</p>
                    <div style='display:flex; align-items:center; gap:12px; margin:12px 0;'>
                        <div class='toggle-visual' id='cardGameToggle' style='opacity:0.5; pointer-events:none;'></div>
                        <span id='currentGameText' style='font-size:14px; color:#4b5563; flex:1; font-weight:600;'>BientÃ´t</span>
                    </div>
                    <div class='btn-row'>
                        <span style='color:#6b7280; font-size:0.875rem;'>Cette fonctionnalitÃ© sera disponible prochainement</span>
                    </div>
                </div>
                <div class='card'>
                    <h3>Votre Ã©tablissement</h3>
                    <iframe id='miniMap' class='mini-map' src='about:blank' loading='lazy' referrerpolicy='no-referrer-when-downgrade'></iframe>
                </div>
            </div>
            <div class='card' style='margin-top:1.5rem;'>
                <h3>Contacts</h3>
                <p>Consultez les contacts collectÃ©s via la plaque.</p>
                <div class='contacts-preview' id='contactsPreview'>
                    <table class='contacts-preview-table'>
                        <thead>
                            <tr>
                                <th>Nom</th>
                                <th>PrÃ©nom</th>
                                <th>Email</th>
                                <th>Date</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id='contactsPreviewBody'>
                            <tr>
                                <td colspan='5' class='contacts-preview-empty'>Chargement...</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
                <div class='btn-row'>
                    <a id='contactsLink' class='btn-primary btn' href='/contacts.html'>Consulter les contacts</a>
                </div>
            </div>
        </div>
    `;
    const contactsPreviewBodyEl = document.getElementById('contactsPreviewBody');
    if (contactsPreviewBodyEl) {
        contactsPreviewBodyEl.addEventListener('click', (event) => {
            const btn = event.target.closest('.delete-contact-btn');
            if (!btn) return;
            const index = parseInt(btn.dataset.index, 10);
            if (Number.isNaN(index)) return;
            handleDeletePreviewContact(index);
        });
    }

    // Wait for db-proxy.js to load before using it
    // Make it available globally for all functions
    window.waitForDbProxy = async function() {
        if (window.dbProxy) {
            return window.dbProxy;
        }
        let retries = 0;
        while (!window.dbProxy && retries < 50) {
            await new Promise(resolve => setTimeout(resolve, 100));
            retries++;
        }
        if (!window.dbProxy) {
            throw new Error('db-proxy.js failed to load after 5 seconds');
        }
        return window.dbProxy;
    };

    // Supabase: fetch account row to populate the cards
    try {
        console.log('ğŸ”„ Starting dashboard data load...');
        console.log('ğŸ“‹ Account ID:', accountId);
        
        // Init menu after DOM is ready
        setTimeout(() => initStatusMenu(), 0);
        
        // Wait for db-proxy to be available
        console.log('â³ Waiting for dbProxy...');
        const dbProxy = await window.waitForDbProxy();
        console.log('âœ… dbProxy loaded');
        
        console.log('ğŸ“¤ Fetching account data for ID:', accountId);
        dbProxy.select('accounts', { id: accountId }, { limit: 1, single: true })
            .then(({ data, error }) => {
                console.log('ğŸ“¥ Account data response received');
                console.log('ğŸ“¥ Data:', data);
                console.log('ğŸ“¥ Error:', error);
                
                if (error) {
                    console.error('âŒ Database error', error);
                    return;
                }
                if (!data) {
                    console.error('âŒ No data returned from database');
                    return;
                }
                
                // Check if account is factory reset (all essential fields are null/empty)
                const isFactoryReset = !data.business_id && 
                                      !data.company_name && 
                                      !data.first_name && 
                                      !data.last_name && 
                                      !data.redirection_url;
                
                if (isFactoryReset) {
                    console.log('âš ï¸ Account appears to be factory reset, redirecting to /create?id=' + accountId);
                    // Redirect to create page to reconfigure
                    window.location.replace(`/create.html?id=${encodeURIComponent(accountId)}`);
                    return;
                }
                
                updateStatusMenu(data);
                // Business name in title
                const name = data.business_name || data.company_name || data.company_nam || ('#' + accountId);
                const titleEl = document.getElementById('bizName');
                if (titleEl) titleEl.textContent = name;
                
                // Fetch rating and total reviews from Google Maps API using business_id (place_id)
                const placeId = data.business_id || data.place_id || null;
                if (placeId) {
                    // Fetch both rating and user_ratings_total from Google Maps API
                    fetchGooglePlaceDetails(placeId);
                } else {
                    // Fallback to Supabase data if no place_id
                    const rating = parseFloat(data.current_rating) || null;
                    updateRatingDisplay(rating);
                    const totalReviews = parseInt(data.tot_review || '0', 10) || null;
                    updateTotalReviewsDisplay(totalReviews);
                }
                
                // Stats (review_number)
                const statsEl = document.getElementById('statsCount');
                if (statsEl) statsEl.textContent = data.review_number || '0';
                // Load contacts preview
                loadContactsPreview();
                // Games card - Show "BientÃ´t" and disable toggle
                const cardGameToggle = document.getElementById('cardGameToggle');
                const currentGameText = document.getElementById('currentGameText');
                
                // Disable toggle and show "BientÃ´t"
                if (cardGameToggle) {
                    cardGameToggle.style.opacity = '0.5';
                    cardGameToggle.style.pointerEvents = 'none';
                    cardGameToggle.classList.remove('active');
                }
                
                if (currentGameText) {
                    currentGameText.textContent = 'BientÃ´t';
                    currentGameText.style.fontWeight = '600';
                }
                // Google Maps card (reuse placeId variable declared above)
                const mapFrame = document.getElementById('miniMap');
                if (placeId && mapFrame) {
                    // Use the Google Maps embed format to avoid X-Frame-Options issues
                    mapFrame.src = `https://www.google.com/maps?q=place_id:${encodeURIComponent(placeId)}&output=embed`;
                }
                
                // Setup reset button
                const resetBtn = document.getElementById('resetBtn');
                const resetPopupOverlay = document.getElementById('resetPopupOverlay');
                const resetPopupCancel = document.getElementById('resetPopupCancel');
                const resetPopupContinue = document.getElementById('resetPopupContinue');
                
                // Function to show reset popup
                function showResetPopup() {
                    if (resetPopupOverlay) {
                        resetPopupOverlay.classList.add('show');
                    }
                }
                
                // Function to hide reset popup
                function hideResetPopup() {
                    if (resetPopupOverlay) {
                        resetPopupOverlay.classList.remove('show');
                    }
                }
                
                // Function to perform factory reset
                async function performFactoryReset() {
                    if (resetBtn) {
                        resetBtn.disabled = true;
                        resetBtn.textContent = 'RÃ©initialisation...';
                    }
                    
                    if (resetPopupContinue) {
                        resetPopupContinue.disabled = true;
                        resetPopupContinue.textContent = 'RÃ©initialisation en cours...';
                    }
                    
                    try {
                            const dbProxy = await window.waitForDbProxy();
                            
                            // Factory reset values
                            const factoryResetData = {
                                email: null,
                                first_name: null,
                                last_name: null,
                                company_name: null,
                                source_id: null,
                                redirection_url: null,
                                games: null,
                                wich_game: null,
                                review_number: null,
                                contact_table: JSON.stringify([{
                                    nom: 'go',
                                    prenom: 'Review',
                                    email: 'goreview.fr@gmail.com',
                                    time: '2025-11-02T15:28:44.088Z'
                                }]),
                                games_details: null,
                                business_id: null,
                                tot_review: null,
                                current_rating: null,
                                updated_at: new Date().toISOString()
                            };
                            
                            const { error } = await dbProxy.update('accounts', factoryResetData, { id: accountId });
                            
                            if (error) {
                                throw new Error(error.message || 'Erreur lors de la rÃ©initialisation');
                            }
                            
                            // No cookies to delete (system doesn't use cookies anymore)
                            console.log('âœ… Reset completed (no cookies to delete)');
                            
                            // Hide popup and redirect
                            hideResetPopup();
                            
                            // Small delay to show success state
                            await new Promise(resolve => setTimeout(resolve, 500));
                            
                            // Redirect to create page instead of reloading dashboard
                            window.location.replace(`/create.html?id=${encodeURIComponent(accountId)}`);
                        } catch (err) {
                            console.error('Reset failed:', err);
                            
                            // Re-enable buttons
                            if (resetBtn) {
                                resetBtn.disabled = false;
                                resetBtn.textContent = 'RÃ©initialiser la plaque';
                            }
                            if (resetPopupContinue) {
                                resetPopupContinue.disabled = false;
                                resetPopupContinue.textContent = 'Continuer';
                            }
                            
                            // Show error in popup
                            const warningEl = document.querySelector('.reset-popup-warning');
                            if (warningEl) {
                                warningEl.style.background = '#fee2e2';
                                warningEl.style.borderLeftColor = '#ef4444';
                                warningEl.innerHTML = `<p style="color:#991b1b;"><strong>Erreur :</strong> ${err.message || 'Une erreur est survenue lors de la rÃ©initialisation.'}</p>`;
                            }
                        }
                    }
                
                // Event listeners
                if (resetBtn) {
                    resetBtn.addEventListener('click', function() {
                        showResetPopup();
                    });
                }
                
                if (resetPopupCancel) {
                    resetPopupCancel.addEventListener('click', function() {
                        hideResetPopup();
                    });
                }
                
                if (resetPopupContinue) {
                    resetPopupContinue.addEventListener('click', function() {
                        performFactoryReset();
                    });
                }
                
                // Close popup when clicking outside
                if (resetPopupOverlay) {
                    resetPopupOverlay.addEventListener('click', function(e) {
                        if (e.target === resetPopupOverlay) {
                            hideResetPopup();
                        }
                    });
                }
                
                // Close popup with Escape key
                document.addEventListener('keydown', function(e) {
                    if (e.key === 'Escape' && resetPopupOverlay && resetPopupOverlay.classList.contains('show')) {
                        hideResetPopup();
                    }
                });
            });
    } catch (e) {
        console.error('Supabase init failed', e);
    }
})();
</script>
</body>
</html>

