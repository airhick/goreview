<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard - GoReview</title>
    <link rel="stylesheet" href="styles.css">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Lexend:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        .dashboard-container {
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            background: linear-gradient(135deg, #f9fafb 0%, #ffffff 100%);
            padding: var(--spacing-md);
        }

        .dashboard-card {
            background: white;
            border-radius: var(--radius-lg);
            box-shadow: var(--shadow-xl);
            padding: var(--spacing-lg);
            width: 100%;
            max-width: 450px;
            position: relative;
        }

        .login-form, .dashboard-content {
            display: none;
        }

        .login-form.active, .dashboard-content.active {
            display: block;
        }

        .login-form h2, .dashboard-content h2 {
            font-size: 2rem;
            font-weight: 800;
            margin-bottom: var(--spacing-sm);
            color: var(--text-primary);
            text-align: center;
        }

        .login-form p {
            color: var(--text-secondary);
            text-align: center;
            margin-bottom: var(--spacing-md);
        }

        .form-group {
            margin-bottom: var(--spacing-md);
        }

        .form-group label {
            display: block;
            font-weight: 600;
            margin-bottom: 0.5rem;
            color: var(--text-primary);
        }

        .form-group input {
            width: 100%;
            padding: 0.75rem 1rem;
            border: 1px solid var(--border-color);
            border-radius: var(--radius-sm);
            font-size: 1rem;
            font-family: inherit;
            transition: border-color 0.2s, box-shadow 0.2s;
        }

        .form-group input:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.1);
        }

        .form-group input[type="email"] {
            margin-bottom: var(--spacing-sm);
        }

        .btn-full {
            width: 100%;
            padding: 0.875rem 1.5rem;
            font-size: 1rem;
        }

        .error-message {
            background: #fee2e2;
            color: #991b1b;
            padding: 0.75rem 1rem;
            border-radius: var(--radius-sm);
            margin-bottom: var(--spacing-md);
            font-size: 0.875rem;
            display: none;
        }

        .error-message.show {
            display: block;
        }

        .success-message {
            background: #d1fae5;
            color: #065f46;
            padding: 0.75rem 1rem;
            border-radius: var(--radius-sm);
            margin-bottom: var(--spacing-md);
            font-size: 0.875rem;
            display: none;
        }

        .success-message.show {
            display: block;
        }

        .loading {
            display: none;
            text-align: center;
            color: var(--text-secondary);
            margin-top: var(--spacing-sm);
        }

        .loading.show {
            display: block;
        }

        .dashboard-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: var(--spacing-lg);
            padding-bottom: var(--spacing-md);
            border-bottom: 1px solid var(--border-color);
        }

        .dashboard-header h2 {
            margin: 0;
            text-align: left;
        }

        .user-info {
            background: var(--bg-accent);
            padding: var(--spacing-md);
            border-radius: var(--radius-md);
            margin-bottom: var(--spacing-md);
        }

        .user-info p {
            margin: 0.5rem 0;
            color: var(--text-secondary);
        }

        .user-info strong {
            color: var(--text-primary);
            font-weight: 600;
        }

        .logout-btn {
            background: #ef4444;
            color: white;
        }

        .logout-btn:hover {
            background: #dc2626;
        }

        .back-link {
            display: inline-block;
            color: var(--primary-color);
            text-decoration: none;
            margin-bottom: var(--spacing-md);
            font-weight: 500;
            transition: opacity 0.2s;
        }

        .back-link:hover {
            opacity: 0.8;
        }

        .magic-link-note {
            font-size: 0.875rem;
            color: var(--text-secondary);
            text-align: center;
            margin-top: var(--spacing-sm);
        }

        .dashboard-welcome {
            padding: var(--spacing-md);
            background: var(--bg-accent);
            border-radius: var(--radius-md);
        }

        .dashboard-welcome h3 {
            margin-top: 0;
            margin-bottom: var(--spacing-sm);
        }

        .dashboard-welcome p {
            color: var(--text-secondary);
            margin-bottom: 0;
        }
    </style>
</head>
<body>
    <div class="dashboard-container">
        <div class="dashboard-card">
            <a href="index.html" class="back-link">← Retour à l'accueil</a>
            
            <!-- Login Form -->
            <div id="loginForm" class="login-form active">
                <h2>Connexion</h2>
                <p>Connectez-vous à votre tableau de bord GoReview</p>
                
                <div id="errorMessage" class="error-message"></div>
                <div id="successMessage" class="success-message"></div>
                
                <form id="emailLoginForm">
                    <div class="form-group">
                        <label for="email">Adresse email</label>
                        <input type="email" id="email" name="email" required placeholder="votre@email.com" autocomplete="email">
                    </div>
                    
                    <button type="submit" class="btn-primary btn-full">
                        Se connecter
                    </button>
                </form>
                
                <div id="loading" class="loading">
                    Envoi du lien de connexion...
                </div>
                
                <p class="magic-link-note">
                    Vous recevrez un lien de connexion par email.
                </p>
            </div>

            <!-- Dashboard Content -->
            <div id="dashboardContent" class="dashboard-content">
                <div class="dashboard-header">
                    <h2>Dashboard</h2>
                    <button id="logoutBtn" class="btn-secondary logout-btn">Déconnexion</button>
                </div>
                
                <div class="user-info">
                    <p><strong>Email:</strong> <span id="userEmail"></span></p>
                    <p><strong>Connecté le:</strong> <span id="loginTime"></span></p>
                </div>

                <div class="dashboard-welcome">
                    <h3>Bienvenue sur votre dashboard !</h3>
                    <p>
                        Votre tableau de bord vous permet de gérer vos avis et contacts clients.
                        Les fonctionnalités complètes seront bientôt disponibles.
                    </p>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Supabase Configuration
        const SUPABASE_URL = 'https://vigutqmfosxbpncussie.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InZpZ3V0cW1mb3N4YnBuY3Vzc2llIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjE1ODQ3NTIsImV4cCI6MjA3NzE2MDc1Mn0.0dL13sBjbCiLrgZe15y4JOL2QXKGkz56PtifpSPJq-E';

        // Initialize Supabase client
        const supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

        // Cookie helpers
        function setCookie(name, value, days) {
            const date = new Date();
            date.setTime(date.getTime() + (days * 24 * 60 * 60 * 1000));
            const expires = "expires=" + date.toUTCString();
            document.cookie = name + "=" + value + ";" + expires + ";path=/;SameSite=Lax";
        }

        function getCookie(name) {
            const nameEQ = name + "=";
            const ca = document.cookie.split(';');
            for(let i = 0; i < ca.length; i++) {
                let c = ca[i];
                while (c.charAt(0) === ' ') c = c.substring(1, c.length);
                if (c.indexOf(nameEQ) === 0) return c.substring(nameEQ.length, c.length);
            }
            return null;
        }

        function deleteCookie(name) {
            document.cookie = name + "=; expires=Thu, 01 Jan 1970 00:00:00 UTC; path=/;";
        }

        // UI Elements
        const loginForm = document.getElementById('loginForm');
        const dashboardContent = document.getElementById('dashboardContent');
        const emailLoginForm = document.getElementById('emailLoginForm');
        const logoutBtn = document.getElementById('logoutBtn');
        const errorMessage = document.getElementById('errorMessage');
        const successMessage = document.getElementById('successMessage');
        const loading = document.getElementById('loading');
        const userEmailSpan = document.getElementById('userEmail');
        const loginTimeSpan = document.getElementById('loginTime');

        // Show error message
        function showError(message) {
            errorMessage.textContent = message;
            errorMessage.classList.add('show');
            successMessage.classList.remove('show');
            setTimeout(() => {
                errorMessage.classList.remove('show');
            }, 5000);
        }

        // Show success message
        function showSuccess(message) {
            successMessage.textContent = message;
            successMessage.classList.add('show');
            errorMessage.classList.remove('show');
            setTimeout(() => {
                successMessage.classList.remove('show');
            }, 5000);
        }

        // Check if user is already logged in
        async function checkSession() {
            try {
                // Check cookie first
                const sessionCookie = getCookie('goreview_session');
                
                if (sessionCookie) {
                    // Try to get current session from Supabase
                    const { data: { session }, error } = await supabaseClient.auth.getSession();
                    
                    if (session && !error) {
                        // User is authenticated
                        showDashboard(session.user);
                        return true;
                    } else {
                        // Cookie exists but session is invalid, clear it
                        deleteCookie('goreview_session');
                    }
                }

                // Listen for auth state changes (for magic link)
                supabaseClient.auth.onAuthStateChange((event, session) => {
                    if (event === 'SIGNED_IN' && session) {
                        // Save session to cookie
                        setCookie('goreview_session', session.access_token, 30); // 30 days
                        showDashboard(session.user);
                    } else if (event === 'SIGNED_OUT') {
                        deleteCookie('goreview_session');
                        showLogin();
                    }
                });

                return false;
            } catch (error) {
                console.error('Error checking session:', error);
                return false;
            }
        }

        // Show dashboard
        function showDashboard(user) {
            loginForm.classList.remove('active');
            dashboardContent.classList.add('active');
            
            userEmailSpan.textContent = user.email;
            loginTimeSpan.textContent = new Date().toLocaleString('fr-FR');
        }

        // Show login form
        function showLogin() {
            loginForm.classList.add('active');
            dashboardContent.classList.remove('active');
            emailLoginForm.reset();
        }

        // Email login form handler
        emailLoginForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const email = document.getElementById('email').value.trim();
            
            if (!email) {
                showError('Veuillez entrer une adresse email valide');
                return;
            }

            loading.classList.add('show');
            errorMessage.classList.remove('show');
            successMessage.classList.remove('show');

            try {
                const { error } = await supabaseClient.auth.signInWithOtp({
                    email: email,
                    options: {
                        emailRedirectTo: window.location.origin + '/dashboard'
                    }
                });

                loading.classList.remove('show');

                if (error) {
                    showError(error.message || 'Erreur lors de l\'envoi du lien de connexion');
                } else {
                    showSuccess('Lien de connexion envoyé ! Vérifiez votre boîte email.');
                    emailLoginForm.reset();
                }
            } catch (error) {
                loading.classList.remove('show');
                showError('Une erreur est survenue. Veuillez réessayer.');
                console.error('Login error:', error);
            }
        });

        // Logout handler
        logoutBtn.addEventListener('click', async () => {
            try {
                await supabaseClient.auth.signOut();
                deleteCookie('goreview_session');
                showLogin();
                showSuccess('Vous avez été déconnecté avec succès.');
            } catch (error) {
                console.error('Logout error:', error);
                showError('Erreur lors de la déconnexion');
            }
        });

        // Check for magic link in URL
        function handleMagicLink() {
            const hashParams = new URLSearchParams(window.location.hash.substring(1));
            const accessToken = hashParams.get('access_token');
            const type = hashParams.get('type');
            
            if (type === 'recovery') {
                // Handle password recovery
                console.log('Password recovery token received');
            }
            
            // Clear hash from URL
            if (accessToken || type) {
                window.history.replaceState(null, null, window.location.pathname);
            }
        }

        // Initialize
        handleMagicLink();
        checkSession();
    </script>
</body>
</html>

