<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Jeux - GoReview</title>
    <link rel="stylesheet" href="styles.css">
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        .centered-card { min-height: 100vh; display:flex; align-items:center; justify-content:center; background: linear-gradient(135deg, #f9fafb 0%, #ffffff 100%); }
        .wrap { background:#ffffff; border:1px solid #e5e7eb; border-radius:20px; box-shadow:0 20px 30px -15px rgba(37,99,235,0.25); width:100%; max-width:820px; padding:2rem; }
        .header { display:flex; align-items:center; justify-content:space-between; margin-bottom:1rem; }
        .title { margin:0; font-size:1.5rem; }
        .grid { display:grid; grid-template-columns: repeat(auto-fit, minmax(260px,1fr)); gap:1rem; }
        .option { border:1px solid #e3eafc; border-radius:16px; padding:1.1rem; display:flex; flex-direction:column; gap:0.6rem; background:linear-gradient(180deg, #ffffff 0%, #f8fbff 100%); box-shadow:0 6px 18px -10px rgba(37,99,235,0.35); }
        .option-head { display:flex; align-items:center; justify-content:space-between; gap:0.5rem; }
        .option-title { display:flex; align-items:center; gap:0.6rem; }
        .icon { width:40px; height:40px; display:inline-flex; align-items:center; justify-content:center; border-radius:12px; background:#e0e7ff; color:#1e3a8a; box-shadow:inset 0 0 0 1px #c7d2fe; }
        .option h3 { margin:0 0 0.35rem 0; font-size:1.125rem; }
        .btn { display:inline-block; padding:0.55rem 1rem; border-radius:12px; border:1px solid #dbe2ff; text-decoration:none; font-weight:600; color:#0f172a; background:#ffffff; }
        .btn:hover { background:#eef2ff; border-color:#c7d2fe; }
        .btn-primary { color:#fff; background:linear-gradient(135deg,#2563eb,#4f46e5); border-color:#4f46e5; box-shadow:0 8px 20px -8px rgba(59,130,246,0.6); }
        .btn-primary:hover { background:linear-gradient(135deg,#1d4ed8,#4338ca); }
        .muted { color:#6b7280; font-size:0.95rem; }
        /* Toggle switch */
        .toggle { position:relative; width:56px; height:32px; background:#e5e7eb; border-radius:9999px; cursor:pointer; display:inline-flex; align-items:center; padding:4px; transition:background .2s, box-shadow .2s; box-shadow: inset 0 0 0 1px #d1d5db; }
        .toggle[aria-checked="true"] { background:#6366f1; box-shadow: inset 0 0 0 1px #6366f1; }
        .toggle:focus-visible { outline: none; box-shadow: 0 0 0 3px rgba(99,102,241,0.35), inset 0 0 0 1px #6366f1; }
        .knob { width:24px; height:24px; background:#ffffff; border-radius:9999px; transform:translateX(0); transition: transform .2s; box-shadow: 0 1px 3px rgba(0,0,0,.15); }
        .toggle[aria-checked="true"] .knob { transform: translateX(24px); }
        .row { display:flex; align-items:center; justify-content:space-between; gap:0.75rem; }
        .section { border:1px solid #e5e7eb; border-radius:14px; padding:1rem; margin-bottom:1rem; }
        .badge { display:inline-block; padding:0.25rem 0.5rem; background:#f3f4f6; border-radius:9999px; font-size:0.85rem; color:#374151; }
    </style>
</head>
<body>
<div class="centered-card" id="root"></div>
<script>
(function(){
  const root = document.getElementById('root');
  const params = new URLSearchParams(window.location.search);
  const id = params.get('id');
  if (!id) {
    window.location.replace('/dashboardlogin.html');
    return;
  }
  const link = (path) => `${path}?id=${encodeURIComponent(id)}`;
  root.innerHTML = `
    <div class='wrap'>
      <div class='header'>
        <h1 class='title'>Choisissez un jeu</h1>
        <a class='btn' href='/dashboard.html?id=${encodeURIComponent(id)}'>&larr; Dashboard</a>
      </div>
      <div class='section row'>
        <div>
          <strong>Jeu</strong>
          <div class='muted'>Activer ou d√©sactiver les jeux</div>
        </div>
        <div id='toggleMaster' class='toggle' role='switch' aria-checked='false' tabindex='0'>
          <div class='knob'></div>
        </div>
      </div>
      <p class='muted' style='margin-bottom:1rem'>Les jeux permettent d'offrir une r√©compense de votre choix pour inciter les clients √† laisser un avis. Le jeu sera affich√© apr√®s la publication de l'avis pour encourager la participation.</p>
      <div class='grid'>
        <div class='option' data-game='roulette'>
          <div class='option-head'>
            <div class='option-title'>
              <div class='icon'>üé°</div>
              <h3>Roue de la chance</h3>
            </div>
            <div class='row'>
              <div class='toggle' role='switch' aria-checked='false' tabindex='0' title='Activer ce jeu'></div>
            </div>
          </div>
          <p class='muted'>Tournez la roue pour tenter de gagner une r√©compense.</p>
          <a class='btn-primary btn' href='${link('/games/roulette.html')}'>Configurer</a>
        </div>
        <div class='option' data-game='dice'>
          <div class='option-head'>
            <div class='option-title'>
              <div class='icon'>üé≤</div>
              <h3>D√©</h3>
            </div>
            <div class='row'>
              <div class='toggle' role='switch' aria-checked='false' tabindex='0' title='Activer ce jeu'></div>
            </div>
          </div>
          <p class='muted'>Lancez un d√© pour tenter de gagner une r√©compense.</p>
          <a class='btn-primary btn' href='${link('/games/dice.html')}'>Configurer</a>
        </div>
        <div class='option' data-game='coin'>
          <div class='option-head'>
            <div class='option-title'>
              <div class='icon'>ü™ô</div>
              <h3>Pile ou face</h3>
            </div>
            <div class='row'>
              <div class='toggle' role='switch' aria-checked='false' tabindex='0' title='Activer ce jeu'></div>
            </div>
          </div>
          <p class='muted'>Pile ou face pour tenter de gagner une r√©compense.</p>
          <a class='btn-primary btn' href='${link('/games/coin.html')}'>Configurer</a>
        </div>
        <div class='option' data-game='balldrop'>
          <div class='option-head'>
            <div class='option-title'>
              <div class='icon'>üèÄ</div>
              <h3>Ball Drop</h3>
            </div>
            <div class='row'>
              <div class='toggle' role='switch' aria-checked='false' tabindex='0' title='Activer ce jeu'></div>
            </div>
          </div>
          <p class='muted'>Faites tomber la balle et visez la bonne case.</p>
          <a class='btn-primary btn' href='${link('/games/balldrop.html')}'>Configurer</a>
        </div>
      </div>
    </div>
  `;

  // Local state (client-side only for now)
  const keyPrefix = `goreview_games_${id}_`;
  const get = (k, d=null) => JSON.parse(localStorage.getItem(keyPrefix+k) ?? 'null') ?? d;
  const set = (k, v) => localStorage.setItem(keyPrefix+k, JSON.stringify(v));

  // Supabase client
  const SUPABASE_URL = 'https://vigutqmfosxbpncussie.supabase.co';
  const SUPABASE_SERVICE_ROLE = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InZpZ3V0cW1mb3N4YnBuY3Vzc2llIiwicm9sZSI6InNlcnZpY2Vfcm9sZSIsImlhdCI6MTc2MTU4NDc1MiwiZXhwIjoyMDc3MTYwNzUyfQ.WPhspJ5LQ7E6k9sUFJsaISU6eVcJnIPGYv0GPGQfd98';
  const sb = supabase.createClient(SUPABASE_URL, SUPABASE_SERVICE_ROLE);
  const updateAccount = async (fields) => {
    try {
      await sb.from('accounts').update(fields).eq('id', id);
    } catch (e) { console.warn('Supabase update failed', e); }
  };
  const fetchAccount = async () => {
    try {
      const { data } = await sb.from('accounts').select('*').eq('id', id).limit(1).maybeSingle();
      return data || null;
    } catch (e) { console.warn('Supabase fetch failed', e); return null; }
  };

  // Position toggle (before/after review)
  const masterEl = document.getElementById('toggleMaster');

  // Game activation toggles (mutually exclusive)
  const savedGame = get('active_game', null);
  const cards = root.querySelectorAll('.option[data-game]');
  cards.forEach(card => {
    const game = card.getAttribute('data-game');
    const sw = card.querySelector('.toggle');
    if (!sw) return;
    sw.setAttribute('aria-checked', savedGame === game ? 'true' : 'false');
    const onToggle = () => {
      const isActive = sw.getAttribute('aria-checked') === 'true';
      // deactivate all
      root.querySelectorAll('.option[data-game] .toggle').forEach(t => t.setAttribute('aria-checked', 'false'));
      // activate this if previously off
      const newState = !isActive;
      if (newState) {
        sw.setAttribute('aria-checked', 'true');
        set('active_game', game);
        updateAccount({ games: true, wich_game: game });
      } else {
        set('active_game', null);
        updateAccount({ games: false, wich_game: null });
      }
    };
    sw.addEventListener('click', onToggle);
    sw.addEventListener('keydown', e => { if (e.key === 'Enter' || e.key === ' ') { e.preventDefault(); onToggle(); } });
  });

  // Master toggle handlers
  if (masterEl) {
    const setAllOff = () => {
      root.querySelectorAll('.option[data-game] .toggle').forEach(t => t.setAttribute('aria-checked','false'));
      set('active_game', null);
    };
    const toggleMaster = () => {
      const next = masterEl.getAttribute('aria-checked') !== 'true';
      masterEl.setAttribute('aria-checked', next ? 'true' : 'false');
      if (!next) { setAllOff(); updateAccount({ games:false, wich_game:null }); }
      else { updateAccount({ games:true }); }
    };
    masterEl.addEventListener('click', toggleMaster);
    masterEl.addEventListener('keydown', e => { if (e.key==='Enter'||e.key===' '){ e.preventDefault(); toggleMaster(); }});
  }

  // Initialize from Supabase if available
  (async function initFromRemote(){
    const row = await fetchAccount();
    if (!row) return;
    // master
    if (masterEl) masterEl.setAttribute('aria-checked', row.games ? 'true' : 'false');
    // active game
    if (row.wich_game) {
      set('active_game', row.wich_game);
      root.querySelectorAll('.option[data-game] .toggle').forEach(t => {
        const g = t.closest('.option').getAttribute('data-game');
        t.setAttribute('aria-checked', g === row.wich_game ? 'true' : 'false');
      });
    }
  })();
})();
</script>
</body>
</html>


