<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    
    <!-- Favicon -->
    <link rel="icon" type="image/png" href="/logo.png">
    <link rel="apple-touch-icon" href="/logo.png">
    
    <title>Carte des √©tablissements | GoReview</title>
    <meta name="description" content="D√©couvrez tous les √©tablissements √©quip√©s GoReview sur une carte interactive.">
    
    <!-- Mapbox GL JS -->
    <script src='https://api.mapbox.com/mapbox-gl-js/v3.3.0/mapbox-gl.js'></script>
    <link href='https://api.mapbox.com/mapbox-gl-js/v3.3.0/mapbox-gl.css' rel='stylesheet' />
    
    <!-- Supabase -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    
    <!-- Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Lexend:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        :root {
            --primary-color: #6366f1;
            --primary-dark: #4f46e5;
            --secondary-color: #8b5cf6;
            --text-primary: #111827;
            --text-secondary: #6b7280;
            --bg-primary: #ffffff;
            --bg-secondary: #f9fafb;
            --border-color: #e5e7eb;
            --success-color: #10b981;
        }
        
        body {
            font-family: 'Lexend', 'Helvetica Neue', Helvetica, Arial, sans-serif;
            background: #0a0a0f;
            color: white;
            overflow: hidden;
        }
        
        /* Navigation */
        .navbar {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            background: rgba(10, 10, 15, 0.85);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border-bottom: 1px solid rgba(255, 255, 255, 0.08);
            z-index: 1000;
            padding: 0.75rem 1.5rem;
        }
        
        .nav-content {
            max-width: 1400px;
            margin: 0 auto;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }
        
        .nav-logo {
            display: flex;
            align-items: center;
            text-decoration: none;
            gap: 0.75rem;
            font-size: 1.25rem;
            font-weight: 700;
            color: white;
        }
        
        .logo-img {
            height: 32px;
            width: auto;
        }
        
        .nav-stats {
            display: flex;
            align-items: center;
            gap: 2rem;
        }
        
        .stat-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 0.15rem;
        }
        
        .stat-value {
            font-size: 1.5rem;
            font-weight: 800;
            background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }
        
        .stat-label {
            font-size: 0.7rem;
            font-weight: 500;
            color: rgba(255, 255, 255, 0.5);
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }
        
        .nav-actions {
            display: flex;
            align-items: center;
            gap: 1rem;
        }
        
        .btn-primary {
            padding: 0.625rem 1.25rem;
            background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
            color: white;
            border: none;
            border-radius: 0.5rem;
            font-size: 0.875rem;
            font-weight: 600;
            cursor: pointer;
            text-decoration: none;
            transition: all 0.2s;
            font-family: inherit;
        }
        
        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(99, 102, 241, 0.4);
        }
        
        /* Map Container */
        #map {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            width: 100%;
            height: 100%;
        }
        
        /* Loading Overlay */
        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: #0a0a0f;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 2000;
            transition: opacity 0.5s ease, visibility 0.5s ease;
        }
        
        .loading-overlay.hidden {
            opacity: 0;
            visibility: hidden;
        }
        
        .loader {
            width: 60px;
            height: 60px;
            border: 3px solid rgba(99, 102, 241, 0.2);
            border-top-color: var(--primary-color);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        
        .loading-text {
            margin-top: 1.5rem;
            font-size: 1rem;
            font-weight: 500;
            color: rgba(255, 255, 255, 0.7);
        }
        
        /* Custom Mapbox Popup */
        .mapboxgl-popup {
            max-width: 320px !important;
        }
        
        .mapboxgl-popup-content {
            background: rgba(15, 15, 20, 0.95);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 16px;
            padding: 0;
            box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.6);
            overflow: hidden;
        }
        
        .mapboxgl-popup-close-button {
            color: rgba(255, 255, 255, 0.6);
            font-size: 20px;
            padding: 8px 12px;
            right: 4px;
            top: 4px;
        }
        
        .mapboxgl-popup-close-button:hover {
            color: white;
            background: transparent;
        }
        
        .mapboxgl-popup-tip {
            border-top-color: rgba(15, 15, 20, 0.95) !important;
        }
        
        .popup-content {
            padding: 1.25rem;
        }
        
        .popup-header {
            display: flex;
            align-items: flex-start;
            gap: 0.75rem;
            margin-bottom: 1rem;
        }
        
        .popup-icon {
            width: 44px;
            height: 44px;
            background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
        }
        
        .popup-icon svg {
            width: 22px;
            height: 22px;
            color: white;
        }
        
        .popup-title {
            flex: 1;
        }
        
        .popup-title h3 {
            font-size: 1rem;
            font-weight: 700;
            color: white;
            margin-bottom: 0.25rem;
            line-height: 1.3;
        }
        
        .popup-type {
            font-size: 0.75rem;
            color: rgba(255, 255, 255, 0.5);
            font-weight: 500;
        }
        
        .popup-stats {
            display: flex;
            gap: 1rem;
            margin-bottom: 1rem;
            padding: 0.75rem;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 10px;
        }
        
        .popup-stat {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        
        .popup-stat-icon {
            color: #fbbf24;
        }
        
        .popup-stat-value {
            font-size: 0.9rem;
            font-weight: 700;
            color: white;
        }
        
        .popup-stat-label {
            font-size: 0.75rem;
            color: rgba(255, 255, 255, 0.5);
        }
        
        .popup-address {
            font-size: 0.8rem;
            color: rgba(255, 255, 255, 0.6);
            line-height: 1.5;
            display: flex;
            align-items: flex-start;
            gap: 0.5rem;
        }
        
        .popup-address svg {
            width: 14px;
            height: 14px;
            flex-shrink: 0;
            margin-top: 2px;
            opacity: 0.5;
        }
        
        /* Custom Marker */
        .custom-marker {
            width: 36px;
            height: 36px;
            background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
            border: 3px solid rgba(255, 255, 255, 0.9);
            border-radius: 50%;
            cursor: pointer;
            box-shadow: 0 4px 15px rgba(99, 102, 241, 0.5);
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .custom-marker:hover {
            transform: scale(1.2);
            box-shadow: 0 8px 25px rgba(99, 102, 241, 0.6);
        }
        
        .custom-marker svg {
            width: 16px;
            height: 16px;
            color: white;
        }
        
        /* Info Panel */
        .info-panel {
            position: fixed;
            bottom: 2rem;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(15, 15, 20, 0.9);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 16px;
            padding: 1rem 2rem;
            z-index: 100;
            display: flex;
            align-items: center;
            gap: 2rem;
        }
        
        .info-item {
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }
        
        .info-icon {
            width: 40px;
            height: 40px;
            background: rgba(99, 102, 241, 0.15);
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--primary-color);
        }
        
        .info-text strong {
            display: block;
            font-size: 1.1rem;
            font-weight: 700;
            color: white;
        }
        
        .info-text span {
            font-size: 0.75rem;
            color: rgba(255, 255, 255, 0.5);
        }
        
        /* Globe controls hint */
        .controls-hint {
            position: fixed;
            bottom: 2rem;
            right: 2rem;
            background: rgba(15, 15, 20, 0.8);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 12px;
            padding: 1rem;
            z-index: 100;
            font-size: 0.75rem;
            color: rgba(255, 255, 255, 0.6);
            max-width: 180px;
        }
        
        .controls-hint strong {
            color: white;
            display: block;
            margin-bottom: 0.5rem;
        }
        
        .controls-hint p {
            margin: 0.25rem 0;
        }
        
        /* Responsive */
        @media (max-width: 768px) {
            .nav-stats {
                display: none;
            }
            
            .info-panel {
                left: 1rem;
                right: 1rem;
                transform: none;
                flex-direction: column;
                gap: 1rem;
                padding: 1rem;
            }
            
            .controls-hint {
                display: none;
            }
            
            .logo-text {
                display: none;
            }
        }
    </style>
</head>
<body>
    <!-- Loading Overlay -->
    <div class="loading-overlay" id="loadingOverlay">
        <div class="loader"></div>
        <p class="loading-text">Chargement du globe...</p>
    </div>
    
    <!-- Navigation -->
    <nav class="navbar">
        <div class="nav-content">
            <a href="/" class="nav-logo">
                <img src="logo.png" alt="GoReview Logo" class="logo-img">
                <span class="logo-text">GoReview</span>
            </a>
            
            <div class="nav-stats">
                <div class="stat-item">
                    <span class="stat-value" id="totalEstablishments">-</span>
                    <span class="stat-label">√âtablissements</span>
                </div>
                <div class="stat-item">
                    <span class="stat-value" id="totalCountries">-</span>
                    <span class="stat-label">Pays</span>
                </div>
            </div>
            
            <div class="nav-actions">
                <a href="/" class="btn-primary">Obtenir ma plaque</a>
            </div>
        </div>
    </nav>
    
    <!-- Map -->
    <div id="map"></div>
    
    <!-- Controls Hint -->
    <div class="controls-hint">
        <strong>üåç Navigation</strong>
        <p>üñ±Ô∏è Glisser pour tourner</p>
        <p>üîç Molette pour zoomer</p>
        <p>üìç Cliquer sur un point</p>
    </div>

    <script>
        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        // MAPBOX ACCESS TOKEN - IMPORTANT!
        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        // Pour obtenir votre token gratuit:
        // 1. Cr√©ez un compte sur https://account.mapbox.com/auth/signup/
        // 2. Copiez votre "Default public token" depuis https://account.mapbox.com/access-tokens/
        // 3. Remplacez le token ci-dessous
        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        mapboxgl.accessToken = 'pk.eyJ1IjoiZmVlbGxpa2VlcmljIiwiYSI6ImNreTFrbWMzMjBjaDEycXFuaWxvdzFmN2EifQ.N-M2P4MOUTjMU27tyIJq6Q';
        
        // Supabase config
        const SUPABASE_URL = 'https://vigutqmfosxbpncussie.supabase.co';
        const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InZpZ3V0cW1mb3N4YnBuY3Vzc2llIiwicm9sZSI6InNlcnZpY2Vfcm9sZSIsImlhdCI6MTc2MTU4NDc1MiwiZXhwIjoyMDc3MTYwNzUyfQ.WPhspJ5LQ7E6k9sUFJsaISU6eVcJnIPGYv0GPGQfd98';
        
        let map;
        let markers = [];
        
        // Initialize Supabase client
        const supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
        
        // Initialize map
        async function initMap() {
            // Check if token is configured
            if (!mapboxgl.accessToken || mapboxgl.accessToken === 'VOTRE_TOKEN_MAPBOX_ICI') {
                showTokenError();
                return;
            }
            
            try {
                map = new mapboxgl.Map({
                    container: 'map',
                    style: 'mapbox://styles/mapbox/satellite-v9',
                    center: [2.3522, 46.6034], // France center
                    zoom: 4,
                    projection: 'globe', // Enable globe projection
                    maxPitch: 85
                });
                
                // Handle map errors
                map.on('error', (e) => {
                    console.error('Mapbox error:', e);
                    if (e.error && e.error.status === 401) {
                        showTokenError();
                    }
                });
                
                // Add atmosphere and fog for globe effect
                map.on('style.load', () => {
                    map.setFog({
                        color: 'rgb(10, 10, 15)',
                        'high-color': 'rgb(36, 36, 60)',
                        'horizon-blend': 0.1,
                        'space-color': 'rgb(10, 10, 15)',
                        'star-intensity': 0.6
                    });
                });
                
                // Add navigation controls
                map.addControl(new mapboxgl.NavigationControl({
                    visualizePitch: true
                }), 'top-right');
                
                // Wait for map to load
                map.on('load', async () => {
                    await loadEstablishments();
                    document.getElementById('loadingOverlay').classList.add('hidden');
                });
            } catch (error) {
                console.error('Failed to initialize map:', error);
                showTokenError();
            }
        }
        
        // Show token configuration error
        function showTokenError() {
            const overlay = document.getElementById('loadingOverlay');
            overlay.innerHTML = `
                <div style="text-align: center; max-width: 500px; padding: 2rem;">
                    <div style="font-size: 4rem; margin-bottom: 1rem;">üó∫Ô∏è</div>
                    <h2 style="font-size: 1.5rem; font-weight: 700; margin-bottom: 1rem; color: white;">
                        Configuration Mapbox requise
                    </h2>
                    <p style="color: rgba(255,255,255,0.7); margin-bottom: 1.5rem; line-height: 1.6;">
                        Pour afficher la carte, vous devez configurer votre token Mapbox.
                    </p>
                    <div style="background: rgba(255,255,255,0.1); border-radius: 12px; padding: 1.25rem; text-align: left; margin-bottom: 1.5rem;">
                        <p style="font-weight: 600; color: white; margin-bottom: 0.75rem;">üìã Instructions :</p>
                        <ol style="color: rgba(255,255,255,0.8); padding-left: 1.25rem; line-height: 1.8;">
                            <li>Cr√©ez un compte gratuit sur <a href="https://account.mapbox.com/auth/signup/" target="_blank" style="color: #818cf8;">mapbox.com</a></li>
                            <li>Copiez votre token depuis <a href="https://account.mapbox.com/access-tokens/" target="_blank" style="color: #818cf8;">Access Tokens</a></li>
                            <li>Ouvrez <code style="background: rgba(0,0,0,0.3); padding: 2px 6px; border-radius: 4px;">map.html</code></li>
                            <li>Remplacez <code style="background: rgba(0,0,0,0.3); padding: 2px 6px; border-radius: 4px;">pk.eyJ1IjoiZmVlbGxpa2VlcmljIiwiYSI6ImNreTFrbWMzMjBjaDEycXFuaWxvdzFmN2EifQ.N-M2P4MOUTjMU27tyIJq6Q</code></li>
                        </ol>
                    </div>
                    <a href="/" style="display: inline-block; padding: 0.75rem 1.5rem; background: linear-gradient(135deg, #6366f1, #8b5cf6); color: white; text-decoration: none; border-radius: 8px; font-weight: 600;">
                        Retour √† l'accueil
                    </a>
                </div>
            `;
        }
        
        // Fetch establishments from Supabase
        async function loadEstablishments() {
            try {
                const { data, error } = await supabaseClient
                    .from('accounts')
                    .select('id, name, email, business_details, current_rating, tot_review');
                
                if (error) {
                    console.error('Erreur Supabase:', error);
                    return;
                }
                
                console.log(`‚úÖ ${data.length} √©tablissements charg√©s`);
                
                // Filter establishments with coordinates
                const establishmentsWithCoords = data.filter(est => {
                    if (!est.business_details) return false;
                    
                    let details;
                    try {
                        details = typeof est.business_details === 'string' 
                            ? JSON.parse(est.business_details) 
                            : est.business_details;
                    } catch (e) {
                        return false;
                    }
                    
                    return details.gps_coordinates && 
                           details.gps_coordinates.latitude && 
                           details.gps_coordinates.longitude;
                });
                
                console.log(`üìç ${establishmentsWithCoords.length} avec coordonn√©es GPS`);
                
                // Update stats
                document.getElementById('totalEstablishments').textContent = establishmentsWithCoords.length;
                
                // Count unique countries (simplified - count based on rough coordinates)
                const countries = new Set();
                establishmentsWithCoords.forEach(est => {
                    const details = typeof est.business_details === 'string' 
                        ? JSON.parse(est.business_details) 
                        : est.business_details;
                    const lat = details.gps_coordinates.latitude;
                    const lng = details.gps_coordinates.longitude;
                    
                    // Simple country detection based on coordinates
                    if (lat >= 41 && lat <= 51 && lng >= -5 && lng <= 10) countries.add('France');
                    else if (lat >= 45 && lat <= 48 && lng >= 5 && lng <= 11) countries.add('Suisse');
                    else if (lat >= 36 && lat <= 44 && lng >= -10 && lng <= 4) countries.add('Espagne');
                    else if (lat >= 36 && lat <= 47 && lng >= 6 && lng <= 19) countries.add('Italie');
                    else if (lat >= 47 && lat <= 55 && lng >= 5 && lng <= 15) countries.add('Allemagne');
                    else if (lat >= 49 && lat <= 52 && lng >= 2 && lng <= 7) countries.add('Belgique');
                    else countries.add('Autre');
                });
                document.getElementById('totalCountries').textContent = countries.size;
                
                // Add markers to map
                addMarkers(establishmentsWithCoords);
                
                // Fit bounds to show all markers
                if (establishmentsWithCoords.length > 0) {
                    const bounds = new mapboxgl.LngLatBounds();
                    establishmentsWithCoords.forEach(est => {
                        const details = typeof est.business_details === 'string' 
                            ? JSON.parse(est.business_details) 
                            : est.business_details;
                        bounds.extend([
                            details.gps_coordinates.longitude,
                            details.gps_coordinates.latitude
                        ]);
                    });
                    
                    map.fitBounds(bounds, {
                        padding: 100,
                        maxZoom: 12
                    });
                }
                
            } catch (err) {
                console.error('Erreur:', err);
            }
        }
        
        // Add markers to map
        function addMarkers(establishments) {
            establishments.forEach(est => {
                const details = typeof est.business_details === 'string' 
                    ? JSON.parse(est.business_details) 
                    : est.business_details;
                
                const coords = details.gps_coordinates;
                const name = details.name || est.name || '√âtablissement';
                const address = details.address || '';
                const type = details.type ? (Array.isArray(details.type) ? details.type[0] : details.type) : '';
                const rating = details.rating || est.current_rating || null;
                const reviews = details.reviews || est.tot_review || null;
                
                // Create custom marker element
                const markerEl = document.createElement('div');
                markerEl.className = 'custom-marker';
                markerEl.innerHTML = `
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <path d="M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0 1 18 0z"></path>
                        <circle cx="12" cy="10" r="3"></circle>
                    </svg>
                `;
                
                // Create popup content
                const popupContent = `
                    <div class="popup-content">
                        <div class="popup-header">
                            <div class="popup-icon">
                                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <path d="M3 21l1.65-3.8a9 9 0 1 1 3.4 2.9L3 21"></path>
                                    <path d="M9 10a.5.5 0 0 0 1 0V9a.5.5 0 0 0-1 0v1zm0 0a5 5 0 0 0 5 5m0 0a.5.5 0 0 0 0-1 .5.5 0 0 0 0 1z"></path>
                                </svg>
                            </div>
                            <div class="popup-title">
                                <h3>${escapeHtml(name)}</h3>
                                ${type ? `<span class="popup-type">${escapeHtml(type)}</span>` : ''}
                            </div>
                        </div>
                        ${(rating || reviews) ? `
                        <div class="popup-stats">
                            ${rating ? `
                            <div class="popup-stat">
                                <span class="popup-stat-icon">‚≠ê</span>
                                <span class="popup-stat-value">${parseFloat(rating).toFixed(1)}</span>
                            </div>
                            ` : ''}
                            ${reviews ? `
                            <div class="popup-stat">
                                <span class="popup-stat-value">${parseInt(reviews).toLocaleString('fr-FR')}</span>
                                <span class="popup-stat-label">avis</span>
                            </div>
                            ` : ''}
                        </div>
                        ` : ''}
                        ${address ? `
                        <div class="popup-address">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0 1 18 0z"></path>
                                <circle cx="12" cy="10" r="3"></circle>
                            </svg>
                            <span>${escapeHtml(address)}</span>
                        </div>
                        ` : ''}
                    </div>
                `;
                
                // Create popup
                const popup = new mapboxgl.Popup({
                    offset: 25,
                    closeButton: true,
                    closeOnClick: true,
                    maxWidth: '320px'
                }).setHTML(popupContent);
                
                // Create marker and add to map
                const marker = new mapboxgl.Marker(markerEl)
                    .setLngLat([coords.longitude, coords.latitude])
                    .setPopup(popup)
                    .addTo(map);
                
                markers.push(marker);
            });
        }
        
        // Escape HTML to prevent XSS
        function escapeHtml(text) {
            if (!text) return '';
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }
        
        // Initialize on page load
        document.addEventListener('DOMContentLoaded', initMap);
    </script>
</body>
</html>
