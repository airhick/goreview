<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    
    <!-- Google tag (gtag.js) -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=GT-KVN9PZLV"></script>
    <script>
      window.dataLayer = window.dataLayer || [];
      function gtag(){dataLayer.push(arguments);}
      gtag('js', new Date());

      gtag('config', 'GT-KVN9PZLV');
    </script>
    
    <!-- Favicon -->
    <link rel="icon" type="image/png" href="/logo.png">
    <link rel="apple-touch-icon" href="/logo.png">
    
    <title>Carte des √©tablissements | GoReview</title>
    <meta name="description" content="D√©couvrez tous les √©tablissements √©quip√©s GoReview sur une carte interactive.">
    
    <!-- Mapbox GL JS -->
    <script src='https://api.mapbox.com/mapbox-gl-js/v3.3.0/mapbox-gl.js'></script>
    <link href='https://api.mapbox.com/mapbox-gl-js/v3.3.0/mapbox-gl.css' rel='stylesheet' />
    
    <!-- Supabase -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    
    <!-- Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Lexend:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        :root {
            --primary-color: #6366f1;
            --primary-dark: #4f46e5;
            --secondary-color: #8b5cf6;
            --text-primary: #111827;
            --text-secondary: #6b7280;
            --bg-primary: #ffffff;
            --bg-secondary: #f9fafb;
            --border-color: #e5e7eb;
            --success-color: #10b981;
        }
        
        body {
            font-family: 'Lexend', 'Helvetica Neue', Helvetica, Arial, sans-serif;
            background: #0a0a0f;
            color: white;
            overflow: hidden;
        }
        
        /* Navigation - Liquid Glass Effect */
        .navbar {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            background: rgba(255, 255, 255, 0.05);
            backdrop-filter: blur(30px) saturate(180%);
            -webkit-backdrop-filter: blur(30px) saturate(180%);
            border-bottom: 1px solid rgba(255, 255, 255, 0.18);
            box-shadow: 0 8px 32px 0 rgba(0, 0, 0, 0.1);
            z-index: 1000;
            padding: 0.75rem 1.5rem;
        }
        
        .navbar::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(
                180deg,
                rgba(255, 255, 255, 0.1) 0%,
                rgba(255, 255, 255, 0.05) 50%,
                rgba(255, 255, 255, 0.02) 100%
            );
            pointer-events: none;
            border-radius: 0 0 20px 20px;
        }
        
        .nav-content {
            max-width: 1400px;
            margin: 0 auto;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }
        
        .nav-logo {
            display: flex;
            align-items: center;
            text-decoration: none;
            gap: 0.75rem;
            font-size: 1.25rem;
            font-weight: 700;
            color: white;
        }
        
        .logo-img {
            height: 32px;
            width: auto;
        }
        
        .nav-stats {
            display: flex;
            align-items: center;
            gap: 2rem;
        }
        
        .stat-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 0.15rem;
        }
        
        .stat-value {
            font-size: 1.5rem;
            font-weight: 800;
            background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }
        
        .stat-label {
            font-size: 0.7rem;
            font-weight: 500;
            color: rgba(255, 255, 255, 0.5);
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }
        
        .nav-actions {
            display: flex;
            align-items: center;
            gap: 1rem;
        }
        
        .btn-primary {
            padding: 0.625rem 1.25rem;
            background: white;
            color: black;
            border: 2px solid black;
            border-radius: 0.5rem;
            font-size: 0.875rem;
            font-weight: 600;
            cursor: pointer;
            text-decoration: none;
            transition: all 0.2s;
            font-family: inherit;
        }
        
        .btn-primary:hover {
            transform: translateY(-2px);
            background: black;
            color: white;
            box-shadow: 0 8px 20px rgba(0, 0, 0, 0.3);
        }
        
        /* Halo lumineux autour du globe - wrapper */
        .map-wrapper {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            width: 100%;
            height: 100%;
            overflow: hidden;
        }
        
        /* Map Container */
        #map {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            width: 100%;
            height: 100%;
            z-index: 1;
        }
        
        .map-wrapper::before {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 160%;
            height: 160%;
            background: radial-gradient(
                circle at center,
                rgba(99, 102, 241, 0.4) 0%,
                rgba(139, 92, 246, 0.3) 20%,
                rgba(99, 102, 241, 0.2) 35%,
                rgba(139, 92, 246, 0.15) 45%,
                rgba(99, 102, 241, 0.1) 55%,
                rgba(139, 92, 246, 0.05) 65%,
                transparent 75%
            );
            border-radius: 50%;
            pointer-events: none;
            z-index: 0;
            animation: pulse-halo-outer 6s ease-in-out infinite;
            filter: blur(50px);
            box-shadow: 0 0 100px rgba(99, 102, 241, 0.3), 0 0 200px rgba(139, 92, 246, 0.2);
        }
        
        .map-wrapper::after {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 130%;
            height: 130%;
            background: radial-gradient(
                circle at center,
                transparent 0%,
                transparent 30%,
                rgba(139, 92, 246, 0.4) 45%,
                rgba(99, 102, 241, 0.3) 55%,
                rgba(139, 92, 246, 0.2) 65%,
                rgba(99, 102, 241, 0.1) 75%,
                transparent 90%
            );
            border-radius: 50%;
            pointer-events: none;
            z-index: 0;
            animation: pulse-halo-inner 5s ease-in-out infinite;
            filter: blur(35px);
            box-shadow: 0 0 80px rgba(139, 92, 246, 0.4), 0 0 150px rgba(99, 102, 241, 0.2);
        }
        
        @keyframes pulse-halo-outer {
            0%, 100% {
                opacity: 0.8;
                transform: translate(-50%, -50%) scale(1);
            }
            50% {
                opacity: 1;
                transform: translate(-50%, -50%) scale(1.1);
            }
        }
        
        @keyframes pulse-halo-inner {
            0%, 100% {
                opacity: 0.9;
                transform: translate(-50%, -50%) scale(1);
            }
            50% {
                opacity: 1;
                transform: translate(-50%, -50%) scale(1.06);
            }
        }
        
        #map {
            position: relative;
            z-index: 1;
        }
        
        /* Loading Overlay */
        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: #0a0a0f;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 2000;
            transition: opacity 0.5s ease, visibility 0.5s ease;
        }
        
        .loading-overlay.hidden {
            opacity: 0;
            visibility: hidden;
        }
        
        .loader {
            width: 60px;
            height: 60px;
            border: 3px solid rgba(99, 102, 241, 0.2);
            border-top-color: var(--primary-color);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        
        .loading-text {
            margin-top: 1.5rem;
            font-size: 1rem;
            font-weight: 500;
            color: rgba(255, 255, 255, 0.7);
        }
        
        /* Custom Mapbox Popup */
        .mapboxgl-popup {
            max-width: 320px !important;
        }
        
        .mapboxgl-popup-content {
            background: rgba(15, 15, 20, 0.95);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 16px;
            padding: 0;
            box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.6);
            overflow: hidden;
        }
        
        .mapboxgl-popup-close-button {
            color: rgba(255, 255, 255, 0.6);
            font-size: 20px;
            padding: 8px 12px;
            right: 4px;
            top: 4px;
        }
        
        .mapboxgl-popup-close-button:hover {
            color: white;
            background: transparent;
        }
        
        .mapboxgl-popup-tip {
            border-top-color: rgba(15, 15, 20, 0.95) !important;
        }
        
        .popup-content {
            padding: 1.25rem;
        }
        
        .popup-header {
            display: flex;
            align-items: flex-start;
            gap: 0.75rem;
            margin-bottom: 1rem;
        }
        
        .popup-icon {
            width: 44px;
            height: 44px;
            background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
            overflow: hidden;
        }
        
        .popup-logo {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        
        .popup-icon svg {
            width: 22px;
            height: 22px;
            color: white;
        }
        
        .popup-title {
            flex: 1;
        }
        
        .popup-title h3 {
            font-size: 1rem;
            font-weight: 700;
            color: white;
            margin-bottom: 0.25rem;
            line-height: 1.3;
        }
        
        .popup-type {
            font-size: 0.75rem;
            color: rgba(255, 255, 255, 0.5);
            font-weight: 500;
        }
        
        .popup-stats {
            display: flex;
            gap: 1rem;
            margin-bottom: 1rem;
            padding: 0.75rem;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 10px;
        }
        
        .popup-stat {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        
        .popup-stat-icon {
            color: #fbbf24;
        }
        
        .popup-stat-value {
            font-size: 0.9rem;
            font-weight: 700;
            color: white;
        }
        
        .popup-stat-label {
            font-size: 0.75rem;
            color: rgba(255, 255, 255, 0.5);
        }
        
        .popup-address {
            font-size: 0.8rem;
            color: rgba(255, 255, 255, 0.6);
            line-height: 1.5;
            display: flex;
            align-items: flex-start;
            gap: 0.5rem;
        }
        
        .popup-address svg {
            width: 14px;
            height: 14px;
            flex-shrink: 0;
            margin-top: 2px;
            opacity: 0.5;
        }
        
        .popup-goreview-stats {
            margin-top: 1rem;
            padding: 0.75rem;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 10px;
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }
        
        .popup-stat-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 0.85rem;
        }
        
        .popup-stat-value-small {
            font-weight: 700;
            color: white;
        }
        
        .popup-actions {
            margin-top: 1rem;
            padding-top: 1rem;
            border-top: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        .popup-button {
            display: inline-flex;
            align-items: center;
            padding: 0.625rem 1rem;
            background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
            color: white;
            text-decoration: none;
            border-radius: 8px;
            font-size: 0.85rem;
            font-weight: 600;
            transition: all 0.2s;
            width: 100%;
            justify-content: center;
        }
        
        .popup-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(99, 102, 241, 0.4);
        }
        
        /* Marker Details - Forms around the marker itself */
        .marker-details-wrapper {
            position: relative;
            display: inline-block;
        }
        
        .marker-details-content {
            position: fixed;
            background: rgba(255, 255, 255, 0.05);
            backdrop-filter: blur(12px) saturate(180%);
            -webkit-backdrop-filter: blur(12px) saturate(180%);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 20px;
            padding: 1.5rem;
            min-width: 280px;
            max-width: 320px;
            box-shadow: 0 8px 32px 0 rgba(0, 0, 0, 0.2), 
                        inset 0 1px 2px 0 rgba(255, 255, 255, 0.2),
                        0 0 0 0.5px rgba(255, 255, 255, 0.1);
            pointer-events: auto;
            z-index: 10000 !important;
            transform: translateX(-50%);
            display: none;
        }
        
        .marker-details-content::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(
                135deg,
                rgba(255, 255, 255, 0.12) 0%,
                rgba(255, 255, 255, 0.06) 50%,
                rgba(255, 255, 255, 0.03) 100%
            );
            border-radius: 20px;
            pointer-events: none;
            opacity: 0.8;
        }
        
        .marker-details-content::after {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 40%;
            background: linear-gradient(
                180deg,
                rgba(255, 255, 255, 0.15) 0%,
                rgba(255, 255, 255, 0.05) 50%,
                transparent 100%
            );
            border-radius: 20px 20px 0 0;
            pointer-events: none;
        }
        
        .marker-details-content .close-btn {
            position: absolute;
            top: 0.75rem;
            right: 0.75rem;
            width: 28px;
            height: 28px;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.15);
            border: 1px solid rgba(255, 255, 255, 0.2);
            color: rgba(255, 255, 255, 0.8);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s;
            font-size: 18px;
            line-height: 1;
            z-index: 2;
            backdrop-filter: blur(10px);
        }
        
        .marker-details-content .close-btn:hover {
            background: rgba(255, 255, 255, 0.25);
            color: white;
            border-color: rgba(255, 255, 255, 0.3);
        }
        
        /* Custom Marker */
        .custom-marker {
            width: 48px;
            height: 48px;
            background: transparent;
            border: 2px solid rgba(255, 255, 255, 0.95);
            border-radius: 50%;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            overflow: hidden;
            box-shadow: none;
        }
        
        .custom-marker:hover {
            transform: scale(1.15);
            border-color: rgba(255, 255, 255, 1);
        }
        
        .marker-logo-container {
            width: 100%;
            height: 100%;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .marker-logo {
            width: 100%;
            height: 100%;
            object-fit: cover;
            border-radius: 50%;
        }
        
        .marker-icon-fallback {
            width: 100%;
            height: 100%;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .custom-marker svg {
            width: 20px;
            height: 20px;
            color: white;
        }
        
        /* Info Panel */
        .info-panel {
            position: fixed;
            bottom: 2rem;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(15, 15, 20, 0.9);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 16px;
            padding: 1rem 2rem;
            z-index: 100;
            display: flex;
            align-items: center;
            gap: 2rem;
        }
        
        .info-item {
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }
        
        .info-icon {
            width: 40px;
            height: 40px;
            background: rgba(99, 102, 241, 0.15);
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--primary-color);
        }
        
        .info-text strong {
            display: block;
            font-size: 1.1rem;
            font-weight: 700;
            color: white;
        }
        
        .info-text span {
            font-size: 0.75rem;
            color: rgba(255, 255, 255, 0.5);
        }
        
        /* Hide Mapbox logo and attributions */
        .mapboxgl-ctrl-logo,
        .mapboxgl-ctrl-attrib {
            display: none !important;
        }
        
        /* Responsive */
        @media (max-width: 768px) {
            .nav-stats {
                display: none;
            }
            
            .info-panel {
                left: 1rem;
                right: 1rem;
                transform: none;
                flex-direction: column;
                gap: 1rem;
                padding: 1rem;
            }
            
        .logo-text {
            display: none !important;
        }
        }
        
        /* Embed mode - hide navbar and halo effects */
        body.embed-mode .navbar {
            display: none !important;
        }
        
        body.embed-mode .map-wrapper::before,
        body.embed-mode .map-wrapper::after {
            display: none;
        }
    </style>
</head>
<body>
    <!-- Loading Overlay -->
    <div class="loading-overlay" id="loadingOverlay">
        <div class="loader"></div>
        <p class="loading-text">Chargement du globe...</p>
    </div>
    
    <!-- Navigation -->
    <nav class="navbar">
        <div class="nav-content">
            <a href="/" class="nav-logo">
                <img src="logo.png" alt="GoReview Logo" class="logo-img">
            </a>
            
            <div class="nav-actions">
                <a href="/" class="btn-primary">Obtenir ma plaque</a>
            </div>
        </div>
    </nav>
    
    <!-- Map -->
    <div class="map-wrapper">
        <div id="map"></div>
    </div>
    

    <script>
        // Check if embedded mode (hide navbar in embed)
        const urlParams = new URLSearchParams(window.location.search);
        const isEmbedded = urlParams.get('embed') === 'true';
        
        if (isEmbedded) {
            // Hide navbar and adjust map in embed mode
            document.addEventListener('DOMContentLoaded', () => {
                const navbar = document.querySelector('.navbar');
                if (navbar) navbar.style.display = 'none';
                
                // Make map wrapper start from top
                const mapWrapper = document.querySelector('.map-wrapper');
                if (mapWrapper) mapWrapper.style.paddingTop = '0';
                
                // Add embed class to body for any additional styling
                document.body.classList.add('embed-mode');
            });
        }
        
        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        // MAPBOX ACCESS TOKEN - IMPORTANT!
        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        // Pour obtenir votre token gratuit:
        // 1. Cr√©ez un compte sur https://account.mapbox.com/auth/signup/
        // 2. Copiez votre "Default public token" depuis https://account.mapbox.com/access-tokens/
        // 3. Remplacez le token ci-dessous
        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        mapboxgl.accessToken = 'pk.eyJ1IjoiZmVlbGxpa2VlcmljIiwiYSI6ImNreTFrbWMzMjBjaDEycXFuaWxvdzFmN2EifQ.N-M2P4MOUTjMU27tyIJq6Q';
        
        // Supabase config
        const SUPABASE_URL = 'https://vigutqmfosxbpncussie.supabase.co';
        const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InZpZ3V0cW1mb3N4YnBuY3Vzc2llIiwicm9sZSI6InNlcnZpY2Vfcm9sZSIsImlhdCI6MTc2MTU4NDc1MiwiZXhwIjoyMDc3MTYwNzUyfQ.WPhspJ5LQ7E6k9sUFJsaISU6eVcJnIPGYv0GPGQfd98';
        
        let map;
        let markers = [];
        
        // Initialize Supabase client
        const supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
        
        // Initialize map
        async function initMap() {
            // Check if token is configured
            if (!mapboxgl.accessToken || mapboxgl.accessToken === 'VOTRE_TOKEN_MAPBOX_ICI') {
                showTokenError();
                return;
            }
            
            try {
                map = new mapboxgl.Map({
                    container: 'map',
                    style: 'mapbox://styles/mapbox/satellite-v9',
                    center: [0, 0], // Start at world view
                    zoom: 1, // Start zoomed out to show entire globe
                    projection: 'globe', // Enable globe projection
                    maxPitch: 85
                });
                
                // Handle map errors
                map.on('error', (e) => {
                    console.error('Mapbox error:', e);
                    if (e.error && e.error.status === 401) {
                        showTokenError();
                    }
                });
                
                // Add atmosphere and fog for globe effect with luminous halo
                map.on('style.load', () => {
                    map.setFog({
                        color: 'rgb(10, 10, 15)',
                        'high-color': 'rgb(60, 50, 100)', // More purple/blue for luminous effect
                        'horizon-blend': 0.3, // Increased for smoother glow
                        'space-color': 'rgb(20, 15, 35)', // Slightly lighter space color
                        'star-intensity': 0.8 // Brighter stars
                    });
                    
                    // Add additional glow effect through lighting (using new API)
                    map.setLights([{
                        'id': 'flat-light',
                        'type': 'flat',
                        'properties': {
                            'anchor': 'viewport',
                            'color': 'white',
                            'intensity': 0.8
                        }
                    }]);
                });
                
                // Add navigation controls
                map.addControl(new mapboxgl.NavigationControl({
                    visualizePitch: true
                }), 'top-right');
                
                // Markers are automatically synchronized by Mapbox
                // No additional handling needed - Mapbox handles positioning during zoom/move
                
                // Wait for map to load
                map.on('load', async () => {
                    await loadEstablishments();
                    document.getElementById('loadingOverlay').classList.add('hidden');
                });
            } catch (error) {
                console.error('Failed to initialize map:', error);
                showTokenError();
            }
        }
        
        // Show token configuration error
        function showTokenError() {
            const overlay = document.getElementById('loadingOverlay');
            overlay.innerHTML = `
                <div style="text-align: center; max-width: 500px; padding: 2rem;">
                    <div style="font-size: 4rem; margin-bottom: 1rem;">üó∫Ô∏è</div>
                    <h2 style="font-size: 1.5rem; font-weight: 700; margin-bottom: 1rem; color: white;">
                        Configuration Mapbox requise
                    </h2>
                    <p style="color: rgba(255,255,255,0.7); margin-bottom: 1.5rem; line-height: 1.6;">
                        Pour afficher la carte, vous devez configurer votre token Mapbox.
                    </p>
                    <div style="background: rgba(255,255,255,0.1); border-radius: 12px; padding: 1.25rem; text-align: left; margin-bottom: 1.5rem;">
                        <p style="font-weight: 600; color: white; margin-bottom: 0.75rem;">üìã Instructions :</p>
                        <ol style="color: rgba(255,255,255,0.8); padding-left: 1.25rem; line-height: 1.8;">
                            <li>Cr√©ez un compte gratuit sur <a href="https://account.mapbox.com/auth/signup/" target="_blank" style="color: #818cf8;">mapbox.com</a></li>
                            <li>Copiez votre token depuis <a href="https://account.mapbox.com/access-tokens/" target="_blank" style="color: #818cf8;">Access Tokens</a></li>
                            <li>Ouvrez <code style="background: rgba(0,0,0,0.3); padding: 2px 6px; border-radius: 4px;">map.html</code></li>
                            <li>Remplacez <code style="background: rgba(0,0,0,0.3); padding: 2px 6px; border-radius: 4px;">pk.eyJ1IjoiZmVlbGxpa2VlcmljIiwiYSI6ImNreTFrbWMzMjBjaDEycXFuaWxvdzFmN2EifQ.N-M2P4MOUTjMU27tyIJq6Q</code></li>
                        </ol>
                    </div>
                    <a href="/" style="display: inline-block; padding: 0.75rem 1.5rem; background: linear-gradient(135deg, #6366f1, #8b5cf6); color: white; text-decoration: none; border-radius: 8px; font-weight: 600;">
                        Retour √† l'accueil
                    </a>
                </div>
            `;
        }
        
        // Geocode address using Nominatim (OpenStreetMap)
        async function geocodeAddress(address) {
            if (!address || address.trim() === '') return null;
            
            try {
                const response = await fetch(
                    `https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(address)}&limit=1`,
                    {
                        headers: {
                            'User-Agent': 'GoReview/1.0'
                        }
                    }
                );
                
                if (!response.ok) return null;
                
                const data = await response.json();
                if (data && data.length > 0) {
                    return {
                        latitude: parseFloat(data[0].lat),
                        longitude: parseFloat(data[0].lon)
                    };
                }
            } catch (error) {
                console.warn('Erreur g√©ocodage:', address, error);
            }
            return null;
        }
        
        // Fetch establishments from Supabase
        async function loadEstablishments() {
            try {
                const { data, error } = await supabaseClient
                    .from('accounts')
                    .select('id, company_name, email, business_details, adress, created_at, contact_table, business_id, longitude_latitude, profile_picture');
                
                if (error) {
                    console.error('Erreur Supabase:', error);
                    console.error('D√©tails:', JSON.stringify(error, null, 2));
                    return;
                }
                
                console.log(`‚úÖ ${data.length} √©tablissements charg√©s`);
                
                // Filter establishments with company_name
                const establishmentsWithName = data.filter(est => {
                    return est.company_name && est.company_name.trim() !== '';
                });
                
                console.log(`üè¢ ${establishmentsWithName.length} avec nom d'entreprise`);
                
                // Process establishments to get coordinates from longitude_latitude column
                const establishmentsWithCoords = [];
                let fromColumnCount = 0;
                let geocodedCount = 0;
                
                for (let i = 0; i < establishmentsWithName.length; i++) {
                    const est = establishmentsWithName[i];
                    let coords = null;
                    
                    // Priority 1: Use longitude_latitude column (format: "longitude;latitude")
                    if (est.longitude_latitude && est.longitude_latitude.trim() !== '') {
                        try {
                            const parts = est.longitude_latitude.split(';');
                            if (parts.length === 2) {
                                const longitude = parseFloat(parts[0].trim());
                                const latitude = parseFloat(parts[1].trim());
                                
                                if (!isNaN(longitude) && !isNaN(latitude) && 
                                    longitude >= -180 && longitude <= 180 &&
                                    latitude >= -90 && latitude <= 90) {
                                    coords = {
                                        longitude: longitude,
                                        latitude: latitude
                                    };
                                    fromColumnCount++;
                                }
                            }
                        } catch (e) {
                            console.warn('Erreur parsing longitude_latitude pour', est.company_name, e);
                        }
                    }
                    
                    // Priority 2: Fallback to business_details GPS if longitude_latitude not available
                    if (!coords && est.business_details) {
                        try {
                            const details = typeof est.business_details === 'string' 
                                ? JSON.parse(est.business_details) 
                                : est.business_details;
                            
                            if (details.gps_coordinates && 
                                details.gps_coordinates.latitude && 
                                details.gps_coordinates.longitude) {
                                coords = {
                                    longitude: details.gps_coordinates.longitude,
                                    latitude: details.gps_coordinates.latitude
                                };
                            }
                        } catch (e) {
                            console.warn('Erreur parsing business_details pour', est.company_name);
                        }
                    }
                    
                    // Priority 3: Fallback to geocoding if no coordinates found
                    if (!coords) {
                        const addressToGeocode = est.adress || (est.business_details && (() => {
                            try {
                                const details = typeof est.business_details === 'string' 
                                    ? JSON.parse(est.business_details) 
                                    : est.business_details;
                                return details.address;
                            } catch (e) {
                                return null;
                            }
                        })());
                        
                        if (addressToGeocode) {
                            coords = await geocodeAddress(addressToGeocode);
                            if (coords) {
                                geocodedCount++;
                                // Rate limiting: wait 1 second between geocoding requests
                                await new Promise(resolve => setTimeout(resolve, 1000));
                            }
                        }
                    }
                    
                    if (coords) {
                        establishmentsWithCoords.push({
                            ...est,
                            _coords: coords
                        });
                    }
                    
                    // Show progress every 50 establishments
                    if ((i + 1) % 50 === 0) {
                        console.log(`‚è≥ Traitement: ${i + 1}/${establishmentsWithName.length}... (${establishmentsWithCoords.length} avec coordonn√©es)`);
                    }
                }
                
                console.log(`üìç ${establishmentsWithCoords.length} √©tablissements avec coordonn√©es (${fromColumnCount} depuis longitude_latitude, ${geocodedCount} g√©ocod√©es)`);
                
                // Add markers to map
                addMarkers(establishmentsWithCoords);
                
                // Animated sequence: directly fly to France
                if (establishmentsWithCoords.length > 0) {
                    // Directly fly to France (center of France coordinates)
                    map.flyTo({
                        center: [2.3522, 46.6034], // France center
                        zoom: 5.5,
                        duration: 2500,
                        essential: true,
                        pitch: 0,
                        bearing: 0
                    });
                } else {
                    // If no establishments, just fly to France
                    map.flyTo({
                        center: [2.3522, 46.6034],
                        zoom: 5.5,
                        duration: 2500,
                        essential: true
                    });
                }
                
            } catch (err) {
                console.error('Erreur:', err);
            }
        }
        
        // Calculate statistics for an establishment
        function calculateStats(est) {
            const details = typeof est.business_details === 'string' 
                ? JSON.parse(est.business_details) 
                : (est.business_details || {});
            
            // Anciennet√© √† GoReview
            const createdAt = est.created_at ? new Date(est.created_at) : null;
            const daysSinceCreation = createdAt ? Math.floor((Date.now() - createdAt.getTime()) / (1000 * 60 * 60 * 24)) : 0;
            const anciennete = daysSinceCreation > 365 
                ? `${Math.floor(daysSinceCreation / 365)} an${Math.floor(daysSinceCreation / 365) > 1 ? 's' : ''}`
                : daysSinceCreation > 30
                ? `${Math.floor(daysSinceCreation / 30)} mois`
                : `${daysSinceCreation} jour${daysSinceCreation > 1 ? 's' : ''}`;
            
            // Avis r√©colt√©s via GoReview (depuis business_details ou 0 par d√©faut)
            // Note: review_number n'existe pas dans la table, on utilise 0 par d√©faut
            // ou on pourrait extraire depuis business_details si disponible
            const reviewsGoReview = 0; // √Ä mettre √† jour si une colonne existe ou si stock√© dans business_details
            
            // Avis par jour
            const reviewsPerDay = daysSinceCreation > 0 ? (reviewsGoReview / daysSinceCreation).toFixed(2) : 0;
            
            // Boost de prix d'avis (rating actuel vs rating initial - √† estimer)
            const currentRating = parseFloat(details.rating) || null;
            const boost = currentRating ? `${currentRating.toFixed(1)}/5` : 'N/A';
            
            // Nombre de contacts r√©colt√©s
            let contactsCount = 0;
            if (est.contact_table) {
                try {
                    const contacts = typeof est.contact_table === 'string' 
                        ? JSON.parse(est.contact_table) 
                        : est.contact_table;
                    contactsCount = Array.isArray(contacts) ? contacts.length : 0;
                } catch (e) {
                    contactsCount = 0;
                }
            }
            
            return {
                anciennete,
                reviewsGoReview,
                reviewsPerDay,
                boost,
                contactsCount,
                currentRating,
                totalReviews: parseInt(details.reviews) || 0
            };
        }
        
        // Add markers to map
        function addMarkers(establishments) {
            establishments.forEach(est => {
                const details = typeof est.business_details === 'string' 
                    ? JSON.parse(est.business_details) 
                    : (est.business_details || {});
                
                const coords = est._coords; // Use the processed coordinates
                const name = details.name || est.company_name || '√âtablissement';
                const address = details.address || est.adress || '';
                const type = details.type ? (Array.isArray(details.type) ? details.type[0] : details.type) : '';
                const rating = details.rating || null;
                const reviews = details.reviews || null;
                const placeId = est.business_id || details.place_id || null;
                
                // Calculate stats
                const stats = calculateStats(est);
                
                // Google Maps link
                const googleMapsLink = placeId 
                    ? `https://www.google.com/maps/place/?q=place_id:${placeId}`
                    : address 
                    ? `https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(address)}`
                    : null;
                
                // Try to use profile_picture first, then business_details fields, then fallback
                // Check multiple possible image sources from Serp API data
                let logoUrl = null;
                
                // Check all possible image sources
                if (est.profile_picture && est.profile_picture.startsWith('http')) {
                    logoUrl = est.profile_picture;
                } else if (details.thumbnail && details.thumbnail.startsWith('http')) {
                    logoUrl = details.thumbnail;
                } else if (details.images && Array.isArray(details.images) && details.images.length > 0) {
                    logoUrl = details.images[0];
                } else if (details.photos && Array.isArray(details.photos) && details.photos.length > 0) {
                    logoUrl = typeof details.photos[0] === 'string' ? details.photos[0] : details.photos[0]?.url;
                } else if (details.logo && details.logo.startsWith('http')) {
                    logoUrl = details.logo;
                } else if (details.main_image && details.main_image.startsWith('http')) {
                    logoUrl = details.main_image;
                }
                
                // Use fallback if no valid image found
                if (!logoUrl) {
                    logoUrl = '/logo.png';
                }
                
                // Debug: log image sources for first few establishments
                if (markers.length < 10) {
                    console.log(`üñºÔ∏è ${name}:`, {
                        profile_picture: est.profile_picture,
                        thumbnail: details.thumbnail,
                        images: details.images,
                        photos: details.photos,
                        using: logoUrl
                    });
                }
                
                // Create popup content - simplified with only essential info
                const popupContent = `
                    <div class="popup-content" style="position: relative; z-index: 1;">
                        <div class="popup-title" style="margin-bottom: 1.5rem;">
                            <h3 style="font-size: 1.25rem; font-weight: 700; color: white; margin: 0;">${escapeHtml(name)}</h3>
                        </div>
                        
                        <div class="popup-goreview-stats" style="display: flex; flex-direction: column; gap: 1rem; margin-bottom: 1rem;">
                            <div class="popup-stat-row" style="display: flex; justify-content: space-between; align-items: center; font-size: 0.95rem;">
                                <span style="color: rgba(255, 255, 255, 0.7);">üìÖ Anciennet√©</span>
                                <span style="font-weight: 700; color: white;">${stats.anciennete}</span>
                            </div>
                        </div>
                        
                        ${address ? `
                        <div style="margin-bottom: 1rem; padding-top: 1rem; border-top: 1px solid rgba(255, 255, 255, 0.1);">
                            <div style="display: flex; align-items: flex-start; gap: 0.5rem; font-size: 0.9rem; color: rgba(255, 255, 255, 0.8); line-height: 1.5;">
                                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="width: 16px; height: 16px; flex-shrink: 0; margin-top: 2px; opacity: 0.6;">
                                    <path d="M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0 1 18 0z"></path>
                                    <circle cx="12" cy="10" r="3"></circle>
                                </svg>
                                <span>${escapeHtml(address)}</span>
                            </div>
                        </div>
                        ` : ''}
                        
                        ${googleMapsLink ? `
                        <div style="margin-top: 0.5rem;">
                            <a href="${googleMapsLink}" target="_blank" style="display: inline-flex; align-items: center; justify-content: center; width: 100%; padding: 0.75rem 1rem; background: rgba(255, 255, 255, 0.1); border: 1px solid rgba(255, 255, 255, 0.2); border-radius: 12px; color: white; text-decoration: none; font-size: 0.9rem; font-weight: 600; transition: all 0.2s; backdrop-filter: blur(10px);">
                                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="width: 18px; height: 18px; margin-right: 8px;">
                                    <path d="M18 13v6a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h6"></path>
                                    <polyline points="15 3 21 3 21 9"></polyline>
                                    <line x1="10" y1="14" x2="21" y2="3"></line>
                                </svg>
                                Voir sur Google Maps
                            </a>
                        </div>
                        ` : ''}
                    </div>
                `;
                
                // Create marker wrapper with details
                const markerWrapper = document.createElement('div');
                markerWrapper.className = 'marker-details-wrapper';
                
                // Create custom marker element with logo
                const markerEl = document.createElement('div');
                markerEl.className = 'custom-marker';
                markerEl.innerHTML = `
                    <div class="marker-logo-container">
                        <img src="${logoUrl}" alt="${escapeHtml(name)}" class="marker-logo" onerror="this.style.display='none'; this.nextElementSibling.style.display='flex';">
                        <div class="marker-icon-fallback" style="display: none;">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0 1 18 0z"></path>
                                <circle cx="12" cy="10" r="3"></circle>
                            </svg>
                        </div>
                    </div>
                `;
                
                // Create details content - add to body, not marker wrapper
                const detailsContent = document.createElement('div');
                detailsContent.className = 'marker-details-content';
                detailsContent.innerHTML = `
                    <button class="close-btn" onclick="this.closest('.marker-details-content').style.display='none'; document.querySelectorAll('.marker-details-wrapper').forEach(w => w.classList.remove('expanded'))">√ó</button>
                    ${popupContent}
                `;
                detailsContent.style.display = 'none';
                document.body.appendChild(detailsContent);
                
                // Create marker and add to map
                // Use markerEl directly for accurate positioning
                const marker = new mapboxgl.Marker(markerEl, {
                    anchor: 'center'
                })
                    .setLngLat([coords.longitude, coords.latitude])
                    .addTo(map);
                
                // Store marker reference for positioning details
                marker._detailsWrapper = markerWrapper;
                marker._detailsContent = detailsContent;
                
                // Handle marker click to expand details around the marker
                markerEl.addEventListener('click', (e) => {
                    e.stopPropagation();
                    console.log('Marker clicked!', name);
                    
                    // Close any other expanded markers
                    document.querySelectorAll('.marker-details-content').forEach(content => {
                        if (content !== detailsContent) {
                            content.style.display = 'none';
                        }
                    });
                    document.querySelectorAll('.marker-details-wrapper.expanded').forEach(wrapper => {
                        wrapper.classList.remove('expanded');
                    });
                    
                    // Toggle this marker's details
                    const isExpanded = markerWrapper.classList.contains('expanded');
                    markerWrapper.classList.toggle('expanded');
                    
                    if (!isExpanded) {
                        // Show and position details
                        console.log('Showing details for', name);
                        detailsContent.style.display = 'block';
                        detailsContent.style.zIndex = '10000';
                        updateDetailsPosition(marker);
                    } else {
                        // Hide details
                        console.log('Hiding details for', name);
                        detailsContent.style.display = 'none';
                    }
                });
                
                // Update details position on map move/zoom
                const updateDetailsPosition = (markerInstance) => {
                    if (!markerInstance._detailsWrapper.classList.contains('expanded')) return;
                    if (markerInstance._detailsContent.style.display === 'none') return;
                    
                    const markerRect = markerInstance._element.getBoundingClientRect();
                    const detailsContent = markerInstance._detailsContent;
                    
                    // Position details below marker, centered
                    const left = markerRect.left + (markerRect.width / 2);
                    const top = markerRect.bottom + 12;
                    
                    detailsContent.style.left = `${left}px`;
                    detailsContent.style.top = `${top}px`;
                    detailsContent.style.transform = 'translateX(-50%)';
                    detailsContent.style.opacity = '1';
                    detailsContent.style.visibility = 'visible';
                    
                    console.log('Positioning details at:', left, top);
                };
                
                map.on('move', () => {
                    if (markerWrapper.classList.contains('expanded')) {
                        updateDetailsPosition(marker);
                    }
                });
                
                map.on('zoom', () => {
                    if (markerWrapper.classList.contains('expanded')) {
                        updateDetailsPosition(marker);
                    }
                });
                
                // Close details when clicking outside
                map.getContainer().addEventListener('click', (e) => {
                    if (!markerEl.contains(e.target) && !detailsContent.contains(e.target)) {
                        markerWrapper.classList.remove('expanded');
                        detailsContent.style.display = 'none';
                    }
                });
                
                markers.push(marker);
            });
        }
        
        // Escape HTML to prevent XSS
        function escapeHtml(text) {
            if (!text) return '';
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }
        
        // Initialize on page load
        document.addEventListener('DOMContentLoaded', initMap);
    </script>
</body>
</html>
