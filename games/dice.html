<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Configurer - Dé</title>
  <link rel="stylesheet" href="../styles.css" />
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <style>
    .page { min-height:100vh; display:flex; align-items:center; justify-content:center; background:#ffffff; }
    .card { width:100%; max-width:880px; background:#ffffff; border-radius:18px; box-shadow:0 10px 25px -5px rgba(0,0,0,0.08); padding:1.9rem; position:relative; overflow:hidden; border:1px solid #e5e7eb; }
    .grid { display:grid; grid-template-columns: repeat(auto-fit,minmax(260px,1fr)); gap:0.75rem; }
    label { font-weight:600; display:block; margin-bottom:0.35rem; }
    input, select { width:100%; padding:0.7rem 0.9rem; border:1px solid #dde3ff; border-radius:14px; background:#ffffff; color:#111827; box-shadow:inset 0 1px 0 rgba(255,255,255,0.6); }
    input::placeholder { color:#9ca3af; }
    .actions { display:flex; gap:0.5rem; margin-top:1rem; }
    .btn { display:inline-block; padding:0.72rem 1.05rem; border-radius:14px; border:1px solid #dbe2ff; text-decoration:none; font-weight:700; color:#0f172a; background:linear-gradient(180deg,#ffffff,#f8fbff); transition:transform .18s ease, box-shadow .18s ease, background .18s ease; box-shadow: 0 6px 12px -8px rgba(2,6,23,0.25), inset 0 1px 0 rgba(255,255,255,0.6); }
    .btn:hover { background:linear-gradient(180deg,#ffffff,#eef2ff); transform:translateY(-1px); box-shadow:0 10px 18px -10px rgba(2,6,23,0.35); }
    .btn-primary { color:#fff; background:linear-gradient(135deg,#2563eb,#7c3aed); border-color:#6d28d9; box-shadow:0 14px 30px -14px rgba(67,56,202,0.65), inset 0 1px 0 rgba(255,255,255,0.25); }
    .btn-primary:hover { background:linear-gradient(135deg,#1d4ed8,#6d28d9); }
    .muted { color:#6b7280; font-size:0.95rem; }
    .preview { margin-top:1rem; border:1px solid #dbe2ff; border-radius:18px; padding:1rem; background:linear-gradient(180deg,#ffffff 0%, #f1f5ff 100%); text-align:center; }
    .die { width:120px; height:120px; margin:0 auto 12px; border-radius:18px; background:linear-gradient(180deg,#ffffff,#f1f5ff); border:1px solid #c7d2fe; display:grid; grid-template-columns:repeat(3,1fr); grid-template-rows:repeat(3,1fr); padding:12px; gap:6px; box-shadow:0 14px 26px -16px rgba(37,99,235,0.45), inset 0 -20px 40px -30px rgba(2,6,23,0.12); transition: transform .65s cubic-bezier(.2,.8,.2,1); transform: rotate3d(1,1,0, var(--rot, 0deg)); }
    .pip { width:14px; height:14px; border-radius:50%; background:radial-gradient(circle at 30% 30%, #93c5fd, #2563eb); margin:auto; box-shadow:0 0 0 2px #bfdbfe inset, 0 2px 4px rgba(2,6,23,0.25); }
    .badge { display:inline-block; padding:4px 8px; border-radius:9999px; border:1px solid #d1fae5; background:#ecfdf5; color:#065f46; font-weight:700; font-size:12px; }
    /* White slider styling */
    input[type=range] { -webkit-appearance:none; appearance:none; height:10px; background:#ffffff; border:1px solid #dbe2ff; border-radius:9999px; box-shadow:inset 0 1px 0 rgba(255,255,255,0.6); }
    input[type=range]:focus { outline:none; }
    input[type=range]::-webkit-slider-thumb { -webkit-appearance:none; appearance:none; width:20px; height:20px; border-radius:50%; background:#ffffff; border:1px solid #c7d2fe; box-shadow:0 4px 10px -6px rgba(2,6,23,0.25), inset 0 1px 0 rgba(255,255,255,0.8); cursor:pointer; }
    input[type=range]::-moz-range-thumb { width:20px; height:20px; border-radius:50%; background:#ffffff; border:1px solid #c7d2fe; box-shadow:0 4px 10px -6px rgba(2,6,23,0.25), inset 0 1px 0 rgba(255,255,255,0.8); cursor:pointer; }
    input[type=range]::-moz-range-track { height:10px; background:#ffffff; border:1px solid #dbe2ff; border-radius:9999px; }
  </style>
</head>
<body>
  <div class="page">
    <div class="card">
      <div style="display:flex;justify-content:space-between;align-items:center;">
        <h1 style="margin:0;">Dé</h1>
        <a class="btn" id="back">&larr; Retour</a>
      </div>
      <p class="muted">Définissez la récompense et la probabilité de gain. Exemple: gagner si le dé affiche 6.</p>

      <div class="grid">
        <div>
          <label for="reward">Récompense (texte)</label>
          <div style="display:flex; gap:6px; align-items:center;">
            <input id="reward" type="text" placeholder="Ex: Boisson offerte" />
            <button id="addReward" type="button" class="btn" title="Ajouter">+</button>
            <button id="commitReward" type="button" class="btn" title="Valider">Valider</button>
          </div>
        </div>
        <div>
          <label>Probabilité de gain: <span id="winRateView">16%</span></label>
          <input id="winRateRange" type="range" min="1" max="100" value="16" />
          <input id="winRate" type="hidden" value="16" />
        </div>
        
      </div>
      <div class="grid" style="margin-top:0.75rem;">
        <div style="grid-column:1/-1;">
          <label>Récompenses</label>
          <div id="rewardsList" class="chips"></div>
        </div>
      </div>

      <div class="preview" id="preview">
        <div class="die" id="die"></div>
        <div id="cubeWrap" style="width:140px;height:140px;margin:0 auto 10px; perspective:900px; display:none;">
          <div id="cube" style="width:100%;height:100%; position:relative; transform-style:preserve-3d; transform: rotateX(0deg) rotateY(0deg); transition: transform .8s cubic-bezier(.2,.8,.2,1);">
            <div class="cube-face" data-face="1" style="position:absolute; inset:0; transform: translateZ(70px); background:linear-gradient(180deg,#ffffff,#f1f5ff); border:1px solid #c7d2fe; border-radius:18px; display:grid; grid-template-columns:repeat(3,1fr); grid-template-rows:repeat(3,1fr); padding:12px; gap:6px;"></div>
            <div class="cube-face" data-face="2" style="position:absolute; inset:0; transform: rotateY(90deg) translateZ(70px); background:linear-gradient(180deg,#ffffff,#f1f5ff); border:1px solid #c7d2fe; border-radius:18px;"></div>
            <div class="cube-face" data-face="3" style="position:absolute; inset:0; transform: rotateY(180deg) translateZ(70px); background:linear-gradient(180deg,#ffffff,#f1f5ff); border:1px solid #c7d2fe; border-radius:18px;"></div>
            <div class="cube-face" data-face="4" style="position:absolute; inset:0; transform: rotateY(-90deg) translateZ(70px); background:linear-gradient(180deg,#ffffff,#f1f5ff); border:1px solid #c7d2fe; border-radius:18px;"></div>
            <div class="cube-face" data-face="5" style="position:absolute; inset:0; transform: rotateX(90deg) translateZ(70px); background:linear-gradient(180deg,#ffffff,#f1f5ff); border:1px solid #c7d2fe; border-radius:18px;"></div>
            <div class="cube-face" data-face="6" style="position:absolute; inset:0; transform: rotateX(-90deg) translateZ(70px); background:linear-gradient(180deg,#ffffff,#f1f5ff); border:1px solid #c7d2fe; border-radius:18px;"></div>
          </div>
        </div>
        <div class="muted">Probabilité: <strong id="pwin">16%</strong></div>
        <div class="actions" style="justify-content:center;margin-top:10px">
          <button id="roll" class="btn">Lancer</button>
          <span id="rollResult" class="badge" style="display:none"></span>
        </div>
      </div>

      <div class="actions">
        <button id="save" class="btn-primary">Enregistrer</button>
        <button id="reset" class="btn">Réinitialiser</button>
      </div>
    </div>
  </div>

  <script>
    (function(){
      const params = new URLSearchParams(window.location.search);
      const id = params.get('id');
      if (!id) { window.location.replace('/dashboardlogin.html'); return; }
      const SUPABASE_URL = 'https://vigutqmfosxbpncussie.supabase.co';
      const SUPABASE_SERVICE_ROLE = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InZpZ3V0cW1mb3N4YnBuY3Vzc2llIiwicm9sZSI6InNlcnZpY2Vfcm9sZSIsImlhdCI6MTc2MTU4NDc1MiwiZXhwIjoyMDc3MTYwNzUyfQ.WPhspJ5LQ7E6k9sUFJsaISU6eVcJnIPGYv0GPGQfd98';
      const sb = supabase.createClient(SUPABASE_URL, SUPABASE_SERVICE_ROLE);
      const key = (k) => `goreview_gamecfg_${id}_dice_${k}`;
      const get = (k,d=null)=> JSON.parse(localStorage.getItem(key(k)) ?? 'null') ?? d;
      const set = (k,v)=> localStorage.setItem(key(k), JSON.stringify(v));
      const $ = (s)=>document.getElementById(s);

      document.getElementById('back').href = `/games.html?id=${encodeURIComponent(id)}`;

      ['reward','winRate'].forEach(f=>{ const el=$(f); const val=get(f,''); if(el && val!==null) el.value = val; });
      function rewardsFromStorage(){ const saved=get('rewards',null); return Array.isArray(saved)? saved : []; }
      function setRewards(list){ set('rewards', list); }
      function getRewards(){ return get('rewards', []); }
      function renderRewards(){ const wrap=document.getElementById('rewardsList'); if(!wrap) return; wrap.innerHTML=''; getRewards().forEach((v,i)=>{ const s=document.createElement('span'); s.className='chip'; s.textContent=v; s.style.cursor='pointer'; s.title='Cliquez pour supprimer'; s.addEventListener('click',()=>{ const next=getRewards().filter((_,j)=>j!==i); setRewards(next); renderRewards(); }); wrap.appendChild(s); }); }
      // sync range and hidden value
      const rangeEl = document.getElementById('winRateRange');
      const winRateHidden = document.getElementById('winRate');
      const winRateView = document.getElementById('winRateView');
      if (rangeEl && winRateHidden && winRateView) {
        const syncFromRange = ()=>{ winRateHidden.value = String(rangeEl.value); winRateView.textContent = `${rangeEl.value}%`; renderPreview(); };
        rangeEl.addEventListener('input', syncFromRange);
        // initialize
        syncFromRange();
      }

      function renderDie(n){
        const die = document.getElementById('die');
        die.innerHTML = '';
        const p = ()=>{ const d=document.createElement('div'); d.className='pip'; return d; };
        const layout = {1:[5],2:[1,9],3:[1,5,9],4:[1,3,7,9],5:[1,3,5,7,9],6:[1,3,4,6,7,9]}[n]||[];
        for(let i=1;i<=9;i++){ die.appendChild(layout.includes(i)?p():document.createElement('div')); }
      }
      function renderPreview(){
        const rateEl = document.getElementById('winRate');
        const rateVal = rateEl && typeof rateEl.value !== 'undefined' ? rateEl.value : '16';
        const rate = Math.max(0, Math.min(100, parseInt(rateVal||'16',10) || 0));
        renderDie(6);
        const pwinEl = document.getElementById('pwin');
        if (pwinEl) pwinEl.textContent = rate + '%';
      }
      renderPreview();
      ['winRate'].forEach(function(name){ const el = document.getElementById(name); if (el) el.addEventListener('input', renderPreview); });
      // Roll preview animation
      const dieEl = document.getElementById('die');
      const rollBtn = document.getElementById('roll');
      const rollResult = document.getElementById('rollResult');
      // Build pips for static die
      function fillPips(el, n){
        el.innerHTML = '';
        const p = ()=>{ const d=document.createElement('div'); d.className='pip'; return d; };
        const layout = {1:[5],2:[1,9],3:[1,5,9],4:[1,3,7,9],5:[1,3,5,7,9],6:[1,3,4,6,7,9]}[n]||[];
        for(let i=1;i<=9;i++){ el.appendChild(layout.includes(i)?p():document.createElement('div')); }
      }
      fillPips(dieEl, 6);
      setRewards(rewardsFromStorage());
      renderRewards();
      const addRewardBtn = document.getElementById('addReward');
      const commitRewardBtn = document.getElementById('commitReward');
      const rewardInput = document.getElementById('reward');
      function commitReward(){ const v=(rewardInput.value||'').trim(); if(!v) return; const next=getRewards(); next.push(v); setRewards(next); rewardInput.value=''; renderRewards(); }
      if (addRewardBtn) addRewardBtn.addEventListener('click', commitReward);
      if (commitRewardBtn) commitRewardBtn.addEventListener('click', commitReward);
      // 3D cube setup
      const cubeWrap = document.getElementById('cubeWrap');
      const cube = document.getElementById('cube');
      // Add pips to each cube face based on face number
      (function buildCubeFaces(){
        const layoutMap = {1:[5],2:[1,9],3:[1,5,9],4:[1,3,7,9],5:[1,3,5,7,9],6:[1,3,4,6,7,9]};
        document.querySelectorAll('.cube-face').forEach(face=>{
          const n = parseInt(face.getAttribute('data-face')||'1',10);
          face.style.display = 'grid';
          face.style.gridTemplateColumns = 'repeat(3,1fr)';
          face.style.gridTemplateRows = 'repeat(3,1fr)';
          face.style.padding = '12px';
          face.style.gap = '6px';
          face.innerHTML = '';
          const layout = layoutMap[n] || [];
          for(let i=1;i<=9;i++){
            if (layout.includes(i)){
              const d=document.createElement('div'); d.className='pip'; face.appendChild(d);
            } else {
              face.appendChild(document.createElement('div'));
            }
          }
        });
      })();
      const faceToRotation = {
        1: [0,0],       // front
        2: [0,-90],     // right
        3: [0,180],     // back
        4: [0,90],      // left
        5: [-90,0],     // top
        6: [90,0]       // bottom
      };
      function show3D(){ cubeWrap.style.display='block'; dieEl.style.display='none'; }
      function hide3D(){ cubeWrap.style.display='none'; dieEl.style.display='block'; }
      if (rollBtn) {
        rollBtn.addEventListener('click', ()=>{
          const rateEl = document.getElementById('winRate');
          const rate = Math.max(0, Math.min(100, parseInt((rateEl&&rateEl.value)||'0',10) || 0));
          rollResult.style.display = 'none';
          show3D();
          const n = 1 + Math.floor(Math.random()*6);
          const extraTurns = 2 + Math.floor(Math.random()*2);
          const [rx, ry] = faceToRotation[n];
          cube.style.transition = 'transform .9s cubic-bezier(.2,.8,.2,1)';
          cube.style.transform = `rotateX(${rx+extraTurns*360}deg) rotateY(${ry+extraTurns*360}deg)`;
          setTimeout(()=>{
            const win = (Math.random()*100 < rate);
            rollResult.textContent = win ? 'Gagné' : 'Perdu';
            rollResult.style.display = '';
            setTimeout(()=>{ hide3D(); fillPips(dieEl, n); }, 500);
          }, 900);
        });
      }
      document.getElementById('save').addEventListener('click', async ()=>{
        ['reward','winRate'].forEach(f=> set(f, $(f).value));
        const reward = $('#reward').value || '';
        const winRate = $('#winRate').value || '';
        const rewards = getRewards();
        const paramsStr = new URLSearchParams({ id, game:'dice', reward, wr: winRate, rewards: rewards.join('|') }).toString();
        const redir = `${location.origin}/company.html?${paramsStr}`;
        try { await sb.from('accounts').update({ games:true, wich_game:'dice', redirection_url: redir, games_details: JSON.stringify({ rewards, winRate: Number(winRate), reward }) }).eq('id', id); } catch(_){ }
        alert('Configuration enregistrée.');
      });
      document.getElementById('reset').addEventListener('click', ()=>{
        ['reward','winRate'].forEach(f=> set(f,''));
        window.location.reload();
      });
    })();
  </script>
</body>
</html>


