<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Configurer - Ball Drop</title>
  <link rel="stylesheet" href="../styles.css" />
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <style>
    .page { min-height:100vh; display:flex; align-items:center; justify-content:center; background:#ffffff; }
    .card { width:100%; max-width:880px; background:#ffffff; border-radius:18px; box-shadow:0 10px 25px -5px rgba(0,0,0,0.08); padding:1.9rem; position:relative; overflow:hidden; border:1px solid #e5e7eb; }
    .grid { display:grid; grid-template-columns: repeat(auto-fit,minmax(260px,1fr)); gap:0.75rem; }
    label { font-weight:600; display:block; margin-bottom:0.35rem; }
    input { width:100%; padding:0.7rem 0.9rem; border:1px solid #dde3ff; border-radius:14px; background:#ffffff; color:#111827; box-shadow:inset 0 1px 0 rgba(255,255,255,0.6); }
    input::placeholder { color:#9ca3af; }
    .actions { display:flex; gap:0.5rem; margin-top:1rem; }
    .btn { display:inline-block; padding:0.72rem 1.05rem; border-radius:14px; border:1px solid #dbe2ff; text-decoration:none; font-weight:700; color:#0f172a; background:linear-gradient(180deg,#ffffff,#f8fbff); transition:transform .18s ease, box-shadow .18s ease, background .18s ease; box-shadow: 0 6px 12px -8px rgba(2,6,23,0.25), inset 0 1px 0 rgba(255,255,255,0.6); }
    .btn:hover { background:linear-gradient(180deg,#ffffff,#eef2ff); transform:translateY(-1px); box-shadow:0 10px 18px -10px rgba(2,6,23,0.35); }
    .btn-primary { color:#fff; background:linear-gradient(135deg,#2563eb,#7c3aed); border-color:#6d28d9; box-shadow:0 14px 30px -14px rgba(67,56,202,0.65), inset 0 1px 0 rgba(255,255,255,0.25); }
    .btn-primary:hover { background:linear-gradient(135deg,#1d4ed8,#6d28d9); }
    .muted { color:#6b7280; font-size:0.95rem; }
    .preview { margin-top:1rem; border:1px solid #dbe2ff; border-radius:18px; padding:1rem; background:linear-gradient(180deg,#ffffff 0%, #f1f5ff 100%); }
    .slots { display:flex; gap:8px; justify-content:center; flex-wrap:wrap; margin-top:6px; }
    .slot { padding:6px 10px; border-radius:9999px; background:#e0e7ff; border:1px solid #c7d2fe; color:#1e3a8a; font-size:12px; }
    .slot.active { background:#d1fae5; border-color:#34d399; color:#065f46; }
    .drop-wrap { display:flex; align-items:flex-start; justify-content:center; gap:16px; margin:10px 0; }
    .track { width:12px; height:160px; background:linear-gradient(180deg,#e0e7ff,#c7d2fe); border-radius:9999px; position:relative; box-shadow:inset 0 0 0 1px #c7d2fe, 0 10px 24px -18px rgba(2,6,23,0.35); }
    .ball { width:20px; height:20px; border-radius:9999px; background:radial-gradient(circle at 30% 30%, #ffffff, #93c5fd); border:1px solid #c7d2fe; position:absolute; left:50%; transform:translate(-50%, var(--y, 0)); box-shadow:0 8px 18px -12px rgba(37,99,235,0.5); transition: transform .7s cubic-bezier(.2,.8,.2,1); }
    .badge { display:inline-block; padding:4px 8px; border-radius:9999px; border:1px solid #d1fae5; background:#ecfdf5; color:#065f46; font-weight:700; font-size:12px; }
  </style>
</head>
<body>
  <div class="page">
    <div class="card">
      <div style="display:flex;justify-content:space-between;align-items:center;">
        <h1 style="margin:0;">Ball Drop</h1>
        <a class="btn" id="back">&larr; Retour</a>
      </div>
      <p class="muted">Définissez la récompense et la probabilité de gain.</p>

      <div class="grid">
        <div>
          <label for="reward">Récompense (texte)</label>
          <div style="display:flex; gap:6px; align-items:center;">
            <input id="reward" type="text" placeholder="Ex: -5€" />
            <button id="addReward" type="button" class="btn" title="Ajouter">+</button>
            <button id="commitReward" type="button" class="btn" title="Valider">Valider</button>
          </div>
        </div>
        <div>
          <label for="winRate">Probabilité de gain (%)</label>
          <input id="winRate" type="number" min="0" max="100" step="1" value="25" />
        </div>
      </div>

      <div class="grid" style="margin-top:0.75rem;">
        <div style="grid-column:1/-1;">
          <label>Récompenses</label>
          <div id="rewardsList" class="slots"></div>
        </div>
      </div>

      <div class="preview" id="preview">
        <div class="muted" style="text-align:center">Probabilité de gain: <strong id="pwin">25%</strong></div>
        <div class="drop-wrap">
          <div class="track" style="display:flex;align-items:center;justify-content:center;">
            <canvas id="dropCanvas" width="180" height="160" style="display:block"></canvas>
          </div>
          <div style="flex:1">
            <div class="slots" id="slots"></div>
            <div class="actions" style="margin-top:8px;">
              <button id="drop" type="button" class="btn">Simuler</button>
              <span id="dropResult" class="badge" style="display:none"></span>
            </div>
          </div>
        </div>
      </div>

      <div class="actions">
        <button id="save" class="btn-primary">Enregistrer</button>
        <button id="reset" class="btn">Réinitialiser</button>
      </div>
    </div>
  </div>

  <script>
    (function(){
      const params = new URLSearchParams(window.location.search);
      const id = params.get('id');
      if (!id) { window.location.replace('/dashboardlogin.html'); return; }
      const SUPABASE_URL = 'https://vigutqmfosxbpncussie.supabase.co';
      const SUPABASE_SERVICE_ROLE = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InZpZ3V0cW1mb3N4YnBuY3Vzc2llIiwicm9sZSI6InNlcnZpY2Vfcm9sZSIsImlhdCI6MTc2MTU4NDc1MiwiZXhwIjoyMDc3MTYwNzUyfQ.WPhspJ5LQ7E6k9sUFJsaISU6eVcJnIPGYv0GPGQfd98';
      const sb = supabase.createClient(SUPABASE_URL, SUPABASE_SERVICE_ROLE);
      const key = (k) => `goreview_gamecfg_${id}_balldrop_${k}`;
      const get = (k,d=null)=> JSON.parse(localStorage.getItem(key(k)) ?? 'null') ?? d;
      const set = (k,v)=> localStorage.setItem(key(k), JSON.stringify(v));
      const $ = (s)=>document.getElementById(s);

      document.getElementById('back').href = `/games.html?id=${encodeURIComponent(id)}`;

      ['reward','winRate'].forEach(f=>{ const el=$(f); const val=get(f,''); if(el && val!==null) el.value = val; });
      function rewardsFromStorage(){ const saved=get('rewards',null); const legacy=['slot1','slot2','slot3'].map(k=>get(k,'')).filter(Boolean); return Array.isArray(saved)&&saved.length?saved:legacy; }
      function setRewards(list){ set('rewards', list); }
      function getRewards(){ return get('rewards', []); }
      function renderPreview(){
        const rate = Math.max(0, Math.min(100, parseInt($('#winRate').value||'0',10)||0));
        document.getElementById('pwin').textContent = rate + '%';
        const slots = document.getElementById('slots');
        slots.innerHTML = '';
        getRewards().forEach(v=>{ const s=document.createElement('span'); s.className='slot'; s.textContent=v; slots.appendChild(s); });
      }
      renderPreview();
      ['winRate'].forEach(id=> $('#'+id).addEventListener('input', renderPreview));
      setRewards(rewardsFromStorage());
      const addRewardBtn = document.getElementById('addReward');
      const commitRewardBtn = document.getElementById('commitReward');
      const rewardInput = document.getElementById('reward');
      function renderRewards(){ const wrap=document.getElementById('rewardsList'); if(!wrap) return; wrap.innerHTML=''; getRewards().forEach((v,i)=>{ const s=document.createElement('span'); s.className='slot'; s.textContent=v; s.style.cursor='pointer'; s.title='Cliquez pour supprimer'; s.addEventListener('click',()=>{ const next=getRewards().filter((_,j)=>j!==i); setRewards(next); renderRewards(); renderPreview(); }); wrap.appendChild(s); }); }
      function commitReward(){ const v=(rewardInput.value||'').trim(); if(!v) return; const next=getRewards(); next.push(v); setRewards(next); rewardInput.value=''; renderRewards(); renderPreview(); }
      if (addRewardBtn) addRewardBtn.addEventListener('click', commitReward);
      if (commitRewardBtn) commitRewardBtn.addEventListener('click', commitReward);
      renderRewards();
      // Drop preview interaction
      const dropBtn = document.getElementById('drop');
      const dropResult = document.getElementById('dropResult');
      const dropCanvas = document.getElementById('dropCanvas');
      const dctx = dropCanvas.getContext('2d');
      function sizeDropCanvas(){
        const dpr = window.devicePixelRatio || 1;
        const rect = dropCanvas.getBoundingClientRect();
        const w = Math.max(140, Math.floor(rect.width));
        const h = Math.max(140, Math.floor(rect.height));
        dropCanvas.width = Math.floor(w * dpr);
        dropCanvas.height = Math.floor(h * dpr);
        dctx.setTransform(dpr,0,0,dpr,0,0);
      }
      function drawBoard(pegs){
        sizeDropCanvas();
        dctx.clearRect(0,0,dropCanvas.width, dropCanvas.height);
        // pegs
        dctx.fillStyle = '#64748b';
        pegs.forEach(p=>{ dctx.beginPath(); dctx.arc(p.x, p.y, 3, 0, Math.PI*2); dctx.fill(); });
      }
      function simulateDrop(){
        const width = dropCanvas.getBoundingClientRect().width;
        const height = dropCanvas.getBoundingClientRect().height;
        const pegs = [];
        const rows = 6, cols = 7;
        const spacingX = width/(cols+1); const spacingY = height/(rows+2);
        for(let r=0;r<rows;r++){
          for(let c=0;c<cols;c++){
            const offset = (r%2)*spacingX/2;
            pegs.push({ x: (c+1)*spacingX + offset, y: (r+1)*spacingY });
          }
        }
        let x = width/2, y = 10, vx = (Math.random()<0.5?-1:1)*0.6, vy = 0;
        const g = 0.35, drag = 0.995;
        const radius = 5;
        drawBoard(pegs);
        function step(){
          vy += g; x += vx; y += vy; vx *= drag; vy *= drag;
          // wall bounce
          if (x < radius){ x = radius; vx *= -0.8; }
          if (x > width-radius){ x = width-radius; vx *= -0.8; }
          // peg collisions (approximate)
          for (const p of pegs){
            const dx = x - p.x, dy = y - p.y; const dist2 = dx*dx + dy*dy;
            if (dist2 < 14*14){ // simple deflection
              const ang = Math.atan2(dy, dx);
              const speed = Math.hypot(vx, vy);
              const dir = ang + (Math.random()<0.5?1:-1)*Math.PI/3;
              vx = Math.cos(dir)*speed*0.85;
              vy = Math.sin(dir)*speed*0.85;
            }
          }
          // draw
          drawBoard(pegs);
          dctx.beginPath(); dctx.arc(x,y,radius,0,Math.PI*2);
          const grad = dctx.createRadialGradient(x-2,y-2,1,x,y,8);
          grad.addColorStop(0,'#ffffff'); grad.addColorStop(1,'#60a5fa');
          dctx.fillStyle = grad; dctx.fill();
          if (y < height - 8){ requestAnimationFrame(step); }
          else conclude(x);
        }
        requestAnimationFrame(step);
        function conclude(ballX){
          const slotsEls = Array.from(document.querySelectorAll('#slots .slot'));
          slotsEls.forEach(el=> el.classList.remove('active'));
          if (!slotsEls.length) return;
          const idx = Math.min(slotsEls.length-1, Math.max(0, Math.floor(ballX / (width / slotsEls.length))));
          const chosen = slotsEls[idx];
          chosen.classList.add('active');
          dropResult.textContent = chosen.textContent || '';
          dropResult.style.display = '';
        }
      }
      if (dropBtn) { dropBtn.addEventListener('click', ()=>{ dropResult.style.display='none'; simulateDrop(); }); }
      // Resize handling
      const trackEl = document.querySelector('.track');
      if (window.ResizeObserver && trackEl) {
        const ro = new ResizeObserver(()=>{ sizeDropCanvas(); drawBoard([]); });
        ro.observe(trackEl);
      } else {
        window.addEventListener('resize', ()=>{ sizeDropCanvas(); drawBoard([]); });
      }
      sizeDropCanvas();
      document.getElementById('save').addEventListener('click', async ()=>{
        ['reward','winRate'].forEach(f=> set(f, $(f).value));
        const reward = $('#reward').value || '';
        const winRate = $('#winRate').value || '';
        const rewards = getRewards();
        const paramsStr = new URLSearchParams({ id, game:'balldrop', reward, wr: winRate, rewards: rewards.join('|') }).toString();
        const redir = `${location.origin}/company.html?${paramsStr}`;
        try { await sb.from('accounts').update({ games:true, wich_game:'balldrop', redirection_url: redir, games_details: JSON.stringify({ rewards, winRate: Number(winRate), reward }) }).eq('id', id);} catch(_){ }
        alert('Configuration enregistrée.');
      });
      document.getElementById('reset').addEventListener('click', ()=>{
        ['reward','winRate'].forEach(f=> set(f,''));
        window.location.reload();
      });
    })();
  </script>
</body>
</html>


